<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Family Trip to Hokkaido 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F0FFFF',
                        'ice-blue': '#B3E5FC',
                        'deep-sea-blue': '#01579B',
                        'accent-yellow': '#FFD54F',
                    },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            background-color: #E5F3F7;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
            overscroll-behavior-y: none;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 100px;
        }

        /* ****** Header ****** */
        .header-bg {
            background-color: #ffffff;
            position: relative;
            height: 200px;
            overflow: hidden;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: 0 10px 30px rgba(1, 87, 155, 0.15);
            z-index: 10;
        }
        
        .header-image-container img {
            width: 100%; height: 100%; object-fit: cover;
        }

        .banner-btn {
            position: absolute; z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            color: #01579B; width: 36px; height: 36px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer;
        }
        .banner-edit-btn { bottom: 20px; right: 20px; }
        .banner-settings-btn { top: 20px; right: 20px; }

        /* ****** Navigation ****** */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(229, 231, 235, 0.5);
            display: flex; justify-content: space-around; align-items: center;
            padding: 12px 16px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
            z-index: 50; border-top-left-radius: 24px; border-top-right-radius: 24px;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #94A3B8; font-size: 0.75rem; gap: 4px; width: 60px;
        }
        .nav-item.active { color: #01579B; font-weight: bold; }
        .fab-center {
            width: 56px; height: 56px; background: #FFD54F;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #01579B; font-size: 1.5rem; margin-top: -28px;
            border: 4px solid #fff; box-shadow: 0 4px 15px rgba(255, 213, 79, 0.6);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Specific Styles */
        .timeline-line {
            position: absolute; left: 23px; top: 24px; bottom: -24px;
            width: 2px; background-color: #E2E8F0; z-index: 0;
        }
        
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        .modal-enter-active, .modal-leave-active { transition: all 0.2s ease; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #01579B; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .form-label {
            font-size: 0.75rem; font-weight: 700; color: #64748B;
            margin-bottom: 0.35rem; display: block; margin-left: 0.25rem;
        }

        /* Gallery Controls */
        .gallery-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 32px; height: 32px; background: rgba(0,0,0,0.3);
            color: white; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(2px); z-index: 20;
        }
        .gallery-prev { left: 10px; }
        .gallery-next { right: 10px; }

        .toast {
            background: rgba(30, 41, 59, 0.95); color: white;
            padding: 12px 20px; border-radius: 12px; font-size: 0.875rem;
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 110; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="app-container" v-cloak>

    <!-- Global Loading -->
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner mb-3"></div>
        <div class="text-slate-600 font-bold text-sm bg-white/80 px-3 py-1 rounded-full">{{ loadingText || 'ËôïÁêÜ‰∏≠...' }}</div>
    </div>

    <!-- Toast -->
    <div v-if="toastMessage" class="toast">
        {{ toastMessage }}
    </div>

    <!-- Header -->
    <div class="header-bg">
        <div class="header-image-container relative">
            <img :src="bannerUrl || 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80'" alt="Header">
            <button @click="showSettingsModal = true" class="banner-btn banner-settings-btn"><i class="fa-solid fa-gear"></i></button>
            <label class="banner-btn banner-edit-btn">
                <input type="file" @change="handleBannerUpload" class="hidden" accept="image/*">
                <i class="fa-solid fa-camera"></i>
            </label>
        </div>
    </div>

    <main class="px-4 app-main">
        
        <!-- Tab: Ë°åÁ®ã (Itinerary) -->
        <div v-if="currentTab === 'itinerary'" class="pb-24">
            <!-- Date Selector -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 px-1 sticky date-selector-sticky -mx-4 px-4 snap-x z-20 bg-white/95 backdrop-blur-md py-3 rounded-b-2xl shadow-sm mb-4">
                <div v-for="(day, index) in dates" :key="index"
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[60px] h-[70px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all border border-transparent"
                     :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white shadow-lg translate-y-[-2px]' : 'bg-slate-50 text-slate-400'">
                    <span class="text-xs font-medium mb-1">{{ day.weekday }}</span>
                    <span class="text-lg font-bold leading-none">{{ day.date.split('/')[1] }}</span>
                    <span class="text-[10px] opacity-60 mt-1">{{ day.date.split('/')[0] }}Êúà</span>
                </div>
            </div>

            <!-- Timeline -->
            <div class="space-y-0 pl-2">
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-400 text-sm">
                    <i class="fa-solid fa-map-location-dot text-4xl mb-3 opacity-20 block"></i>
                    ÈÄôÂ§©ÈÇÑÊ≤íÊúâË°åÁ®ãÂñîÔºåÊåâ + Êñ∞Â¢û
                </div>

                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group pb-6 last:pb-24">
                    <!-- Connector Line -->
                    <div v-if="idx < currentItinerary.length - 1" class="timeline-line border-l-2 border-dashed border-slate-200"></div>

                    <!-- Travel Time (Visual) -->
                    <div v-if="idx > 0" class="pl-12 mb-3 flex items-center text-xs text-slate-400">
                        <div class="flex items-center bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">
                            <i :class="getTransportIcon(item.transportType)" class="mr-1.5 text-slate-400"></i>
                            <span>Êé•Á∫åË°åÁ®ã</span>
                        </div>
                    </div>

                    <div class="flex items-start relative z-10">
                        <!-- Icon Column -->
                        <div class="flex flex-col items-center mr-3 w-12 flex-shrink-0">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm ring-4 ring-white z-10" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-500 mt-2 bg-white px-1 rounded">{{ item.startTime }}</span>
                        </div>

                        <!-- Card Content -->
                        <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden flex cursor-pointer active:scale-[0.99] transition-transform"
                             @click="openItineraryDetail(item)">
                            
                            <!-- Left: Info -->
                            <div class="p-3 flex-1 min-w-0">
                                <h3 class="text-base font-bold text-slate-800 leading-snug truncate">{{ item.name }}</h3>
                                <p class="text-xs text-slate-500 truncate mt-1" v-if="item.note">{{ item.note }}</p>
                                
                                <div v-if="item.category === 'flight'" class="mt-2 inline-flex items-center bg-sky-50 text-sky-700 px-2 py-1 rounded text-xs font-bold">
                                    <i class="fa-solid fa-plane mr-1"></i> {{ item.flightNo }}
                                </div>
                            </div>

                            <!-- Right: Reorder Buttons & Image -->
                            <div class="flex flex-col items-center justify-between border-l border-slate-100 bg-slate-50 w-10">
                                <button @click.stop="reorderItem(item, -1)" class="h-1/2 w-full flex items-center justify-center text-slate-400 hover:text-deep-sea-blue active:bg-slate-200">
                                    <i class="fa-solid fa-caret-up"></i>
                                </button>
                                <button @click.stop="reorderItem(item, 1)" class="h-1/2 w-full flex items-center justify-center text-slate-400 hover:text-deep-sea-blue active:bg-slate-200">
                                    <i class="fa-solid fa-caret-down"></i>
                                </button>
                            </div>
                            
                            <!-- Small Thumbnail if exists -->
                             <div v-if="item.images && item.images.length > 0" class="w-16 bg-slate-100 relative">
                                <img :src="item.images[0]" class="w-full h-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Ë≥ºÁâ© (Shopping - List View) -->
        <div v-if="currentTab === 'shopping'" class="pb-24">
            <!-- Sub Tabs -->
            <div class="flex p-1 bg-slate-100 rounded-2xl mb-4">
                <button @click="shoppingSubTab = 'souvenir'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'souvenir' ? 'bg-white text-pink-500 shadow-sm' : 'text-slate-400'">
                    ‰º¥ÊâãÁ¶Æ
                </button>
                <button @click="shoppingSubTab = 'cosmetic'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'cosmetic' ? 'bg-white text-teal-500 shadow-sm' : 'text-slate-400'">
                    Ëó•Â¶ù
                </button>
            </div>

            <!-- List View -->
            <div class="flex flex-col gap-3">
                <div v-for="(item, idx) in filteredShoppingList" :key="item.id" 
                     @click="openShoppingDetail(item)" 
                     class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-4 cursor-pointer active:bg-slate-50">
                    
                    <!-- Thumbnail -->
                    <div class="w-16 h-16 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0 relative border border-slate-200">
                         <img v-if="item.images && item.images.length > 0" :src="item.images[0]" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image"></i></div>
                         <div v-if="item.images && item.images.length > 1" class="absolute bottom-0 right-0 bg-black/60 text-white text-[9px] px-1 rounded-tl-md">
                            +{{ item.images.length - 1 }}
                         </div>
                    </div>

                    <!-- Details -->
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-slate-800 text-sm truncate">{{ item.name }}</h4>
                        <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                            <span v-if="item.price" class="bg-yellow-50 text-yellow-700 px-1.5 py-0.5 rounded">¬•{{ item.price }}</span>
                            <span v-if="item.quantity">x{{ item.quantity }}</span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1 truncate" v-if="item.shopName"><i class="fa-solid fa-location-dot mr-1"></i>{{ item.shopName }}</p>
                    </div>

                    <div class="text-slate-300 text-sm"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                
                <!-- Add Button -->
                <button @click="handleAddClick" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-sm flex items-center justify-center hover:bg-slate-50">
                    <i class="fa-solid fa-plus mr-2"></i> Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ
                </button>
            </div>
        </div>

        <!-- Tab: Ëä±Ë≤ª (Expenses) -->
        <div v-if="currentTab === 'expenses'" class="pb-24">
            <div class="bg-gradient-to-br from-deep-sea-blue to-blue-800 text-white rounded-3xl p-6 mb-6 shadow-xl relative overflow-hidden">
                <p class="text-xs text-blue-200 mb-1">Á∏ΩÊîØÂá∫È†ê‰º∞</p>
                <h2 class="text-4xl font-bold mb-1">¬• {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm text-blue-200 opacity-80">‚âà NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div v-for="exp in expenses" :key="exp.id" class="flex items-center justify-between p-4 border-b border-slate-50 last:border-0">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm mr-3" :class="getCategoryColor(exp.category)">
                            <i :class="getCategoryIcon(exp.category)"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                            <p class="text-[10px] text-slate-400">{{ exp.date }} ¬∑ {{ exp.payment === 'card' ? 'Âà∑Âç°' : 'ÁèæÈáë' }}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-slate-700 text-sm mr-3">¬•{{ formatNumber(exp.amount) }}</span>
                        <button @click="removeExpense(exp.id)" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Ë≥áË®ä (Hotels/Info) -->
        <div v-if="currentTab === 'info'" class="pb-24 space-y-5">
            <!-- Rate Calculator -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-3">
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 block mb-1">Êó•Âπ£ JPY</label>
                    <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-slate-50 rounded-lg p-2 font-bold text-deep-sea-blue">
                </div>
                <i class="fa-solid fa-arrow-right text-slate-300 mt-4"></i>
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 block mb-1">Âè∞Âπ£ TWD</label>
                    <div class="w-full bg-slate-100 rounded-lg p-2 font-bold text-slate-600">$ {{ currencyResult }}</div>
                </div>
            </div>

            <!-- Hotels -->
            <div class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h3 class="font-bold text-slate-800 text-lg">‰ΩèÂÆøË≥áË®ä</h3>
                </div>
                
                <div v-for="hotel in hotels" :key="hotel.id" @click="openHotelDetail(hotel)" 
                     class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                    
                    <div class="flex p-4 gap-4">
                        <div class="w-20 h-20 bg-slate-100 rounded-xl overflow-hidden flex-shrink-0">
                            <img v-if="hotel.images && hotel.images.length > 0" :src="hotel.images[0]" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-hotel text-xl"></i></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 text-base mb-1 truncate">{{ hotel.name }}</h4>
                            <div class="flex flex-col gap-1 text-xs text-slate-500">
                                <span><i class="fa-regular fa-calendar mr-1"></i> {{ hotel.checkInDate }} - {{ hotel.checkOutDate }}</span>
                                <span v-if="hotel.address" class="truncate"><i class="fa-solid fa-map-pin mr-1"></i> {{ hotel.address }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Attachment Indicator -->
                    <div v-if="hotel.files && hotel.files.length > 0" class="bg-slate-50 px-4 py-2 border-t border-slate-100 flex items-center text-xs text-blue-600 font-bold">
                        <i class="fa-solid fa-paperclip mr-2"></i> Â∑≤‰∏äÂÇ≥Ë®ÇÂñÆÊñá‰ª∂ ({{ hotel.files.length }})
                    </div>
                </div>
                
                <button @click="handleAddClick" class="w-full py-3 bg-white border border-slate-200 text-slate-500 rounded-xl font-bold text-sm">
                    <i class="fa-solid fa-plus mr-2"></i> Êñ∞Â¢û‰ΩèÂÆø
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item" :class="{ active: currentTab === 'itinerary' }" @click="currentTab = 'itinerary'">
            <i class="fa-solid fa-map-location-dot"></i><span>Ë°åÁ®ã</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'shopping' }" @click="currentTab = 'shopping'">
            <i class="fa-solid fa-bag-shopping"></i><span>Ë≥ºÁâ©</span>
        </button>
        <button class="fab-center" @click="handleAddClick"><i class="fa-solid fa-plus"></i></button>
        <button class="nav-item" :class="{ active: currentTab === 'expenses' }" @click="currentTab = 'expenses'">
            <i class="fa-solid fa-wallet"></i><span>Ëä±Ë≤ª</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'info' }" @click="currentTab = 'info'">
            <i class="fa-solid fa-circle-info"></i><span>Ë≥áË®ä</span>
        </button>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- Settings Modal -->
    <div v-if="showSettingsModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10">
            <h3 class="font-bold text-lg mb-6 text-center">ÊóÖÁ®ãË®≠ÂÆö</h3>
            <div class="space-y-4">
                <div>
                    <label class="form-label">Âá∫ÁôºÊó•Êúü</label>
                    <input type="date" v-model="tripSettings.startDate" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                </div>
                <div>
                    <label class="form-label">ÁÆ°ÁêÜÂ§©Êï∏ (Â¢û/Ê∏õ)</label>
                    <div class="flex items-center justify-between bg-slate-50 rounded-xl p-3">
                        <button @click="changeDuration(-1)" class="w-10 h-10 bg-white shadow rounded-lg text-slate-600"><i class="fa-solid fa-minus"></i></button>
                        <span class="font-bold text-lg">{{ tripSettings.duration }} Â§©</span>
                        <button @click="changeDuration(1)" class="w-10 h-10 bg-white shadow rounded-lg text-slate-600"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <button @click="saveTripSettings" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold mt-2">ÂÑ≤Â≠òË®≠ÂÆö</button>
            </div>
        </div>
    </div>

    <!-- Itinerary Add/Edit Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'Á∑®ËºØ' : 'Êñ∞Â¢û' }}Ë°åÁ®ã</h3>
            
            <div class="space-y-4">
                <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                    <option value="sightseeing">üì∏ ÊôØÈªû</option>
                    <option value="food">üç¥ È£≤È£ü</option>
                    <option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option>
                    <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                    <option value="transport">üöå ‰∫§ÈÄö</option>
                </select>
                
                <input v-model="newItinerary.name" placeholder="ÂêçÁ®±" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="newItinerary.startTime" type="time" class="bg-slate-50 rounded-xl p-3 text-sm">
                    <select v-model="newItinerary.transportType" class="bg-slate-50 rounded-xl p-3 text-sm">
                        <option value="walk">Ê≠•Ë°å</option>
                        <option value="car">Ëá™Èßï</option>
                        <option value="bus">Â∑¥Â£´</option>
                        <option value="public">Âú∞Èêµ</option>
                    </select>
                </div>
                
                <textarea v-model="newItinerary.note" placeholder="ÂÇôË®ª..." class="w-full bg-slate-50 rounded-xl p-3 text-sm" rows="2"></textarea>
                
                <!-- Image Upload with Compression -->
                <div>
                    <label class="form-label">ÁÖßÁâá</label>
                    <div class="image-preview-grid">
                        <div v-for="(img, idx) in newItinerary.images" :key="idx" class="image-preview-item">
                            <img :src="img">
                            <button @click="removeImage(idx, newItinerary)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 cursor-pointer">
                            <input type="file" @change="(e) => handleImageUpload(e, newItinerary)" class="hidden" multiple accept="image/*">
                            <i class="fa-solid fa-plus text-slate-400"></i>
                        </label>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveItineraryItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hotel Add/Edit Modal -->
    <div v-if="showHotelModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[90vh] overflow-y-auto p-6 relative z-10">
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditHotel ? 'Á∑®ËºØ' : 'Êñ∞Â¢û' }}‰ΩèÂÆø</h3>
            
            <div class="space-y-4">
                <div><label class="form-label">È£ØÂ∫óÂêçÁ®±</label><input v-model="newHotel.name" class="w-full bg-slate-50 rounded-xl p-3 text-sm"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="form-label">ÂÖ•‰ΩèÊó•Êúü</label><input v-model="newHotel.checkInDate" type="date" class="w-full bg-slate-50 rounded-xl p-3 text-sm"></div>
                    <div><label class="form-label">ÈÄÄÊàøÊó•Êúü</label><input v-model="newHotel.checkOutDate" type="date" class="w-full bg-slate-50 rounded-xl p-3 text-sm"></div>
                </div>
                <div><label class="form-label">Âú∞ÂùÄ</label><input v-model="newHotel.address" class="w-full bg-slate-50 rounded-xl p-3 text-sm"></div>
                <div><label class="form-label">ÂÇôË®ª</label><textarea v-model="newHotel.note" class="w-full bg-slate-50 rounded-xl p-3 text-sm"></textarea></div>

                <!-- File Upload for Booking (PDF/Image) -->
                <div>
                    <label class="form-label">Ë®ÇÂñÆÊ™îÊ°à/Êà™Âúñ (ÊîØÊè¥ PDF/ÂúñÁâá)</label>
                    <div class="space-y-2">
                        <div v-for="(file, idx) in newHotel.files" :key="idx" class="flex items-center justify-between bg-slate-50 p-2 rounded-lg text-sm">
                            <span class="truncate max-w-[200px] text-blue-600 underline cursor-pointer" @click="openFile(file)">{{ getFileName(file) }}</span>
                            <button @click="removeFile(idx, newHotel)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="block w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-center text-slate-400 cursor-pointer">
                            <input type="file" @change="(e) => handleFileUpload(e, newHotel)" class="hidden" multiple accept="image/*,application/pdf">
                            <i class="fa-solid fa-cloud-arrow-up mr-1"></i> ‰∏äÂÇ≥Ê™îÊ°à
                        </label>
                    </div>
                </div>

                <!-- Hotel Photos -->
                <div>
                    <label class="form-label">È£ØÂ∫óÂ§ñËßÄ/ÊàøÈñìÁÖßÁâá</label>
                    <div class="image-preview-grid">
                        <div v-for="(img, idx) in newHotel.images" :key="idx" class="image-preview-item">
                            <img :src="img">
                            <button @click="removeImage(idx, newHotel)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 cursor-pointer">
                            <input type="file" @change="(e) => handleImageUpload(e, newHotel)" class="hidden" multiple accept="image/*">
                            <i class="fa-solid fa-plus text-slate-400"></i>
                        </label>
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button v-if="isEditHotel" @click="removeHotelItem(newHotel.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveHotelItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shopping Detail Modal (With Gallery Navigation) -->
    <div v-if="showShoppingDetailModal && selectedShoppingItem" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative z-10">
            <!-- Image Area with Controls -->
            <div class="relative h-72 bg-slate-100 group">
                <img v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 0" 
                     :src="selectedShoppingItem.images[currentGalleryIndex]" 
                     class="w-full h-full object-contain bg-black">
                <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image text-4xl"></i></div>
                
                <button @click="closeAllModals" class="absolute top-3 right-3 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-xmark"></i></button>
                
                <!-- Prev/Next Buttons -->
                <div v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 1">
                    <button @click.stop="galleryNav(-1)" class="gallery-nav-btn gallery-prev"><i class="fa-solid fa-chevron-left"></i></button>
                    <button @click.stop="galleryNav(1)" class="gallery-nav-btn gallery-next"><i class="fa-solid fa-chevron-right"></i></button>
                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/50 px-2 py-0.5 rounded-full text-white text-xs">
                        {{ currentGalleryIndex + 1 }} / {{ selectedShoppingItem.images.length }}
                    </div>
                </div>
            </div>

            <div class="p-5">
                <h3 class="text-xl font-bold text-slate-800 mb-2">{{ selectedShoppingItem.name }}</h3>
                <p class="text-sm text-slate-500 mb-4" v-if="selectedShoppingItem.shopName"><i class="fa-solid fa-store mr-1"></i> {{ selectedShoppingItem.shopName }}</p>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-3 rounded-xl text-center">
                        <span class="text-xs text-slate-400 block">ÂñÆÂÉπ</span>
                        <span class="font-bold">¬•{{ selectedShoppingItem.price || '-' }}</span>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl text-center">
                        <span class="text-xs text-slate-400 block">Êï∏Èáè</span>
                        <span class="font-bold">x{{ selectedShoppingItem.quantity || 1 }}</span>
                    </div>
                </div>
                
                <button @click="switchToEditShopping" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold shadow-lg shadow-blue-900/20">Á∑®ËºØÂÖßÂÆπ</button>
            </div>
        </div>
    </div>
    
    <!-- Shopping Add/Edit Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
         <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
         <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
             <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'Á∑®ËºØ' : 'Êñ∞Â¢û' }}Ë≥ºÁâ©</h3>
             <div class="space-y-4">
                 <input v-model="newShoppingItem.name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                 <input v-model="newShoppingItem.shopName" placeholder="ÂïÜÂ∫ó (ÈÅ∏Â°´)" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                 <div class="grid grid-cols-2 gap-3">
                     <input v-model="newShoppingItem.price" type="number" placeholder="ÂñÆÂÉπ" class="bg-slate-50 rounded-xl p-3 text-sm">
                     <input v-model="newShoppingItem.quantity" type="number" placeholder="Êï∏Èáè" class="bg-slate-50 rounded-xl p-3 text-sm">
                 </div>

                 <!-- Shopping Images -->
                <div>
                    <label class="form-label">ÂïÜÂìÅÁÖßÁâá</label>
                    <div class="image-preview-grid">
                        <div v-for="(img, idx) in newShoppingItem.images" :key="idx" class="image-preview-item">
                            <img :src="img">
                            <button @click="removeImage(idx, newShoppingItem)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 cursor-pointer">
                            <input type="file" @change="(e) => handleImageUpload(e, newShoppingItem)" class="hidden" multiple accept="image/*">
                            <i class="fa-solid fa-plus text-slate-400"></i>
                        </label>
                    </div>
                </div>

                 <div class="flex gap-2 mt-4">
                     <button v-if="isEditMode" @click="removeShoppingItem(newShoppingItem.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                     <button @click="saveShoppingItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">ÂÑ≤Â≠ò</button>
                 </div>
             </div>
         </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // Firebase Config
            const firebaseConfig = {
               apiKey: "AIzaSyA8wiv63sS1lbCkOOeYlZpL1RlKHvvAAYA",
                authDomain: "hokkaido-b390b.firebaseapp.com",
                projectId: "hokkaido-b390b",
                storageBucket: "hokkaido-b390b.firebasestorage.app",
                messagingSenderId: "199459788936",
                appId: "1:199459788936:web:f430fac50b022959f8e73d",
                measurementId: "G-3XGXW53RDB"
            };

            const TRIP_ID = 'family_hokkaido_2026';
            const DATA_PATH = 'shared_data';

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            const userId = ref(null);
            const isLoading = ref(false);
            const loadingText = ref('');
            const toastMessage = ref('');

            const showToast = (msg) => {
                toastMessage.value = msg;
                setTimeout(() => toastMessage.value = '', 3000);
            };

            // Image Compression Helper (Frontend)
            // This is the key fix for "slow uploads"
            const compressImage = async (file) => {
                return new Promise((resolve) => {
                    const maxWidth = 1200; // Resize to max 1200px width
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to Blob (JPEG quality 0.7)
                            canvas.toBlob((blob) => {
                                resolve(blob);
                            }, 'image/jpeg', 0.7);
                        };
                    };
                });
            };

            // Data Refs
            const currentTab = ref('itinerary');
            const shoppingSubTab = ref('souvenir');
            const dates = ref([]);
            const tripSettings = ref({ startDate: '2026-02-01', duration: 7 });
            
            const itineraryData = ref({});
            const shoppingList = ref([]);
            const expenses = ref([]);
            const hotels = ref([]);
            const bannerUrl = ref('');
            
            const selectedDateIndex = ref(0);
            
            // Modals
            const showSettingsModal = ref(false);
            const showItineraryModal = ref(false);
            const showShoppingModal = ref(false);
            const showShoppingDetailModal = ref(false);
            const showHotelModal = ref(false);
            
            // Edit/New Items
            const isEditMode = ref(false);
            const isEditHotel = ref(false);
            const newItinerary = ref({ images: [] });
            const newShoppingItem = ref({ images: [] });
            const newHotel = ref({ images: [], files: [] }); // Added files
            
            const selectedShoppingItem = ref(null);
            const currentGalleryIndex = ref(0); // For Shopping Gallery
            
            const currencyInput = ref(10000);
            const currencyResult = ref(0);

            // Computed
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const filteredShoppingList = computed(() => shoppingList.value.filter(item => item.category === shoppingSubTab.value));
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + e.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * 0.215));

            // Icons & Helpers
            const getCategoryColor = (cat) => ({
                sightseeing: 'bg-emerald-400', food: 'bg-orange-400', shopping: 'bg-pink-400',
                flight: 'bg-sky-500', transport: 'bg-slate-400', accommodation: 'bg-indigo-400'
            }[cat] || 'bg-gray-400');
            
            const getCategoryIcon = (cat) => ({
                sightseeing: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping',
                flight: 'fa-solid fa-plane', transport: 'fa-solid fa-bus', accommodation: 'fa-solid fa-bed'
            }[cat] || 'fa-solid fa-info');

            const getTransportIcon = (t) => ({ walk: 'fa-solid fa-person-walking', car: 'fa-solid fa-car', bus: 'fa-solid fa-bus', public: 'fa-solid fa-train-subway' }[t] || 'fa-solid fa-arrow-right');
            
            const formatNumber = (n) => n?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * 0.215);

            // --- Initialization ---
            onMounted(async () => {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId.value = user.uid;
                        setupListeners();
                    }
                });
                calculateCurrency();
            });

            const generateDates = () => {
                const arr = [];
                const start = new Date(tripSettings.value.startDate);
                const weekdays = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                for(let i=0; i<tripSettings.value.duration; i++){
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    arr.push({ 
                        date: `${d.getMonth()+1}/${d.getDate()}`,
                        weekday: weekdays[d.getDay()] 
                    });
                }
                dates.value = arr;
            };

            const setupListeners = () => {
                // Settings
                onSnapshot(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), (docSnap) => {
                    if(docSnap.exists()){
                        const d = docSnap.data();
                        bannerUrl.value = d.headerImage;
                        if(d.tripStartDate) tripSettings.value.startDate = d.tripStartDate;
                        if(d.tripDuration) tripSettings.value.duration = d.tripDuration;
                        generateDates();
                    }
                });
                // Itinerary
                onSnapshot(collection(db, 'trips', TRIP_ID, 'itinerary_items'), (snap) => {
                    const temp = {};
                    snap.forEach(d => {
                        const data = d.data();
                        const day = data.dayIndex || 0;
                        if(!temp[day]) temp[day] = [];
                        temp[day].push({ ...data, id: d.id });
                    });
                    // Sort by 'order' then 'startTime'
                    Object.keys(temp).forEach(k => {
                        temp[k].sort((a,b) => (a.order || 999) - (b.order || 999) || (a.startTime||'').localeCompare(b.startTime||''));
                    });
                    itineraryData.value = temp;
                });
                // Shopping
                onSnapshot(collection(db, 'trips', TRIP_ID, 'shopping_items'), (snap) => shoppingList.value = snap.docs.map(d => ({...d.data(), id:d.id})));
                // Hotels
                onSnapshot(collection(db, 'trips', TRIP_ID, 'hotel_items'), (snap) => hotels.value = snap.docs.map(d => ({...d.data(), id:d.id})));
            };

            // --- Logic Updates ---

            // 1. Upload Logic (Compressed)
            const processUploads = async (filesArray) => {
                const urls = [];
                for(const item of filesArray) {
                    if(item.startsWith('data:')) {
                        // It's a base64 from FileReader, we need to upload
                        // Note: In handleImageUpload, we already compressed it to Blob, 
                        // but here we simplify by assuming the input is the result of FileReader.
                        // Actually, for better flow: handleImageUpload stores base64 for preview.
                        // We convert base64 -> Blob -> Upload.
                        
                        const res = await fetch(item);
                        const blob = await res.blob();
                        
                        const filename = `upload_${Date.now()}_${Math.random().toString(36).substring(7)}`;
                        const fileRef = storageRef(storage, `uploads/${filename}`);
                        await uploadBytes(fileRef, blob);
                        urls.push(await getDownloadURL(fileRef));
                    } else {
                        urls.push(item); // Already a URL
                    }
                }
                return urls;
            };

            // 2. Date Management (Add/Remove Days)
            const changeDuration = (delta) => {
                const newDur = tripSettings.value.duration + delta;
                if(newDur < 1) return;
                tripSettings.value.duration = newDur;
            };

            const saveTripSettings = async () => {
                isLoading.value = true;
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), {
                    tripStartDate: tripSettings.value.startDate,
                    tripDuration: tripSettings.value.duration
                }, { merge: true });
                generateDates();
                isLoading.value = false;
                showSettingsModal.value = false;
                showToast("Ë®≠ÂÆöÂ∑≤Êõ¥Êñ∞");
            };

            // 3. Manual Reorder
            const reorderItem = async (item, direction) => {
                // direction: -1 (up), 1 (down)
                const dayList = itineraryData.value[selectedDateIndex.value];
                const currentIndex = dayList.findIndex(i => i.id === item.id);
                if(currentIndex === -1) return;
                
                const targetIndex = currentIndex + direction;
                if(targetIndex < 0 || targetIndex >= dayList.length) return;
                
                const neighbor = dayList[targetIndex];
                
                // Swap 'order' values. If undefined, use index as base
                const itemOrder = item.order ?? currentIndex;
                const neighborOrder = neighbor.order ?? targetIndex;

                const batch = writeBatch(db);
                batch.update(doc(db, 'trips', TRIP_ID, 'itinerary_items', item.id), { order: neighborOrder });
                batch.update(doc(db, 'trips', TRIP_ID, 'itinerary_items', neighbor.id), { order: itemOrder });
                
                await batch.commit();
            };

            // 4. Hotel Logic (Files)
            const handleFileUpload = (e, target) => {
                const files = e.target.files;
                if(!files.length) return;
                if(!target.files) target.files = [];
                // For PDF/File uploads, we keep them as is (Base64 for preview is heavy for PDF)
                // For this simple app, we'll upload immediately or read as DataURL if small? 
                // Let's use DataURL for simplicity in "processUploads" logic, but distinguish later.
                Array.from(files).forEach(file => {
                     const reader = new FileReader();
                     reader.onload = (evt) => target.files.push(evt.target.result); // Push base64
                     reader.readAsDataURL(file);
                });
            };

            const getFileName = (urlOrBase64) => {
                if(urlOrBase64.startsWith('data:')) return "Êñ∞Ê™îÊ°à (Â∞öÊú™ÂÑ≤Â≠ò)";
                return "Â∑≤‰∏äÂÇ≥Ê™îÊ°à"; // Simplifying filename display
            };

            const openFile = (url) => {
                if(!url.startsWith('data:')) window.open(url, '_blank');
            };

            const saveHotelItem = async () => {
                isLoading.value = true;
                loadingText.value = '‰∏äÂÇ≥‰∏≠...';
                const imgUrls = await processUploads(newHotel.value.images);
                const fileUrls = await processUploads(newHotel.value.files || []); // Reuse upload logic
                
                const data = { ...newHotel.value, images: imgUrls, files: fileUrls };
                delete data.id;
                
                if(isEditHotel.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'hotel_items', newHotel.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'hotel_items'), data);
                
                isLoading.value = false;
                closeAllModals();
                showToast("‰ΩèÂÆøÂÑ≤Â≠òÊàêÂäü");
            };

            // Generic Handlers
            const handleImageUpload = async (e, targetRef) => {
                const files = e.target.files;
                if(!files.length) return;
                loadingText.value = 'Â£ìÁ∏ÆÂúñÁâá‰∏≠...';
                isLoading.value = true; // Show spinner while compressing
                
                if(!targetRef.images) targetRef.images = [];
                
                for(const file of files) {
                    const compressedBlob = await compressImage(file);
                    // Convert Blob back to base64 for preview
                    const reader = new FileReader();
                    reader.onload = (evt) => targetRef.images.push(evt.target.result);
                    reader.readAsDataURL(compressedBlob);
                }
                isLoading.value = false;
            };

            const removeImage = (idx, target) => target.images.splice(idx, 1);
            const removeFile = (idx, target) => target.files.splice(idx, 1);

            const handleAddClick = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    const dayList = itineraryData.value[selectedDateIndex.value] || [];
                    const maxOrder = dayList.length > 0 ? Math.max(...dayList.map(i => i.order || 0)) : 0;
                    
                    newItinerary.value = { category: 'sightseeing', transportType: 'walk', images: [], dayIndex: selectedDateIndex.value, order: maxOrder + 1 };
                    showItineraryModal.value = true;
                } else if(currentTab.value === 'shopping') {
                    isEditMode.value = false;
                    newShoppingItem.value = { category: shoppingSubTab.value, images: [] };
                    showShoppingModal.value = true;
                } else if(currentTab.value === 'info') {
                    isEditHotel.value = false;
                    newHotel.value = { images: [], files: [] };
                    showHotelModal.value = true;
                }
            };

            const saveItineraryItem = async () => {
                isLoading.value = true;
                const urls = await processUploads(newItinerary.value.images);
                const data = { ...newItinerary.value, images: urls, dayIndex: selectedDateIndex.value };
                delete data.id;
                
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', newItinerary.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'itinerary_items'), data);
                
                isLoading.value = false;
                closeAllModals();
            };
            
            const removeItineraryItem = async (id) => {
                if(confirm("Âà™Èô§Ê≠§Ë°åÁ®ãÔºü")) {
                    await deleteDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', id));
                    closeAllModals();
                }
            };

            const saveShoppingItem = async () => {
                isLoading.value = true;
                if(!isEditMode.value) newShoppingItem.value.category = shoppingSubTab.value;
                const urls = await processUploads(newShoppingItem.value.images);
                const data = { ...newShoppingItem.value, images: urls };
                delete data.id;
                
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', newShoppingItem.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'shopping_items'), data);
                isLoading.value = false;
                closeAllModals();
            };
            
            const removeShoppingItem = async (id) => {
                if(confirm("Âà™Èô§ÂïÜÂìÅÔºü")) {
                    await deleteDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', id));
                    closeAllModals();
                }
            };
            
            // Detail Openers
            const openItineraryDetail = (item) => {
                isEditMode.value = true;
                newItinerary.value = JSON.parse(JSON.stringify(item));
                showItineraryModal.value = true; // Reusing edit modal for details to simplify
            };
            
            const openShoppingDetail = (item) => {
                selectedShoppingItem.value = item;
                currentGalleryIndex.value = 0;
                showShoppingDetailModal.value = true;
            };

            const switchToEditShopping = () => {
                showShoppingDetailModal.value = false;
                isEditMode.value = true;
                newShoppingItem.value = JSON.parse(JSON.stringify(selectedShoppingItem.value));
                if(!newShoppingItem.value.images) newShoppingItem.value.images = [];
                showShoppingModal.value = true;
            };

            const galleryNav = (dir) => {
                if(!selectedShoppingItem.value) return;
                const len = selectedShoppingItem.value.images.length;
                let newIdx = currentGalleryIndex.value + dir;
                if(newIdx < 0) newIdx = len - 1;
                if(newIdx >= len) newIdx = 0;
                currentGalleryIndex.value = newIdx;
            };

            const openHotelDetail = (hotel) => {
                isEditHotel.value = true;
                newHotel.value = JSON.parse(JSON.stringify(hotel));
                if(!newHotel.value.images) newHotel.value.images = [];
                if(!newHotel.value.files) newHotel.value.files = [];
                showHotelModal.value = true;
            };
            
            const removeHotelItem = async (id) => {
                if(confirm("Âà™Èô§‰ΩèÂÆøÔºü")) {
                    await deleteDoc(doc(db, 'trips', TRIP_ID, 'hotel_items', id));
                    closeAllModals();
                }
            };
            
            const handleBannerUpload = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                isLoading.value = true;
                // Compress banner too
                const blob = await compressImage(file);
                const fileRef = storageRef(storage, `uploads/banner_${Date.now()}`);
                await uploadBytes(fileRef, blob);
                const url = await getDownloadURL(fileRef);
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), { headerImage: url }, { merge: true });
                isLoading.value = false;
            };

            const closeAllModals = () => {
                showSettingsModal.value = false;
                showItineraryModal.value = false;
                showShoppingModal.value = false;
                showShoppingDetailModal.value = false;
                showHotelModal.value = false;
                isLoading.value = false;
            };

            return {
                isLoading, loadingText, toastMessage, bannerUrl,
                currentTab, dates, selectedDateIndex, currentItinerary,
                shoppingSubTab, filteredShoppingList, expenses, totalExpensesJPY, totalExpensesTWD,
                hotels, currencyInput, currencyResult, calculateCurrency, formatNumber,
                getCategoryColor, getCategoryIcon, getTransportIcon,
                // Modals
                showSettingsModal, showItineraryModal, showShoppingModal, showShoppingDetailModal, showHotelModal,
                tripSettings, saveTripSettings, changeDuration,
                // Itinerary
                newItinerary, isEditMode, handleAddClick, handleImageUpload, removeImage, saveItineraryItem, removeItineraryItem, openItineraryDetail, reorderItem,
                // Shopping
                newShoppingItem, selectedShoppingItem, currentGalleryIndex, galleryNav, openShoppingDetail, switchToEditShopping, saveShoppingItem, removeShoppingItem,
                // Hotel
                newHotel, isEditHotel, openHotelDetail, saveHotelItem, removeHotelItem, handleFileUpload, removeFile, openFile, getFileName,
                closeAllModals, handleBannerUpload
            };
        }
    }).mount('#app');
</script>
</body>
</html>