<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Hokkaido Sunny</title>
    
    <meta name="description" content="20260103~20260113">
    <meta property="og:title" content="Hokkaido Sunny">
    <meta property="og:description" content="20260103~20260113">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea-blue': '#01579B',
                        'accent-yellow': '#FFD54F',
                        'expense-header': '#007EA7',
                    },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            background-color: #F8FAFC;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 480px;
            background-color: #ffffff; min-height: 100vh; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* Header */
        .header-bg {
            height: 200px; width: 100%; position: relative;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            overflow: hidden; background-color: #e2e8f0;
        }
        
        /* éœ€æ±‚5: Banner åˆªé™¤æŒ‰éˆ• */
        .banner-btn-delete {
            position: absolute; top: 20px; right: 20px; width: 36px; height: 36px;
            background: rgba(255, 255, 255, 0.9); color: #ef4444;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 50;
            backdrop-filter: blur(4px);
        }

        /* Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; background: rgba(255, 255, 255, 0.98);
            border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center;
            padding: 10px 16px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); z-index: 50;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94A3B8; font-size: 0.7rem; width: 60px; }
        .nav-item.active { color: #01579B; font-weight: bold; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        
        /* FAB Center Button */
        .fab-center {
            width: 52px; height: 52px; background: #01579B; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            font-size: 1.4rem; margin-top: -26px; border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(1, 87, 155, 0.4);
            position: relative; z-index: 60; cursor: pointer;
        }

        /* Timeline */
        .timeline-line {
            position: absolute; left: 23px; top: 30px; bottom: -20px;
            width: 2px; background-color: #E2E8F0; z-index: 0;
        }

        /* Common */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .form-label {
            font-size: 0.75rem; font-weight: 700; color: #64748B;
            margin-bottom: 0.35rem; display: block; margin-left: 0.25rem;
        }
        .input-field {
            width: 100%; background-color: #F8FAFC; border-radius: 0.75rem;
            padding: 0.75rem; font-size: 0.875rem; outline: none;
            border: 1px solid transparent; transition: border-color 0.2s;
        }
        .input-field:focus { border-color: #01579B; background-color: #fff; }

        /* Images */
        .image-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .image-preview-item {
            aspect-ratio: 1; position: relative; border-radius: 0.75rem;
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }

        .modal-close-btn {
            position: absolute; top: 12px; right: 12px; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            background-color: #F1F5F9; border-radius: 50%; color: #64748B;
            font-size: 1rem; cursor: pointer; z-index: 50;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95); color: white;
            padding: 12px 20px; border-radius: 12px; font-size: 0.875rem;
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 110; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none; width: max-content;
        }

        /* Lightbox */
        .lightbox {
            position: fixed; inset: 0; background: black; z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* Spinner */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #01579B; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="app-container" v-cloak>

    <!-- Global Loading -->
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner mb-3"></div>
        <div class="text-slate-600 font-bold text-sm bg-white/80 px-3 py-1 rounded-full">{{ loadingText || 'è™•ç†ä¸­...' }}</div>
    </div>

    <!-- Toast -->
    <div v-if="toastMessage" class="toast">{{ toastMessage }}</div>

    <!-- Header (Banner) -->
    <div class="header-bg relative">
        <div class="header-image-container relative w-full h-full group">
            <label class="cursor-pointer block w-full h-full relative">
                <input type="file" @change="handleBannerUpload" class="hidden" accept="image/*">
                <!-- éœ€æ±‚5: ç§»é™¤æ‰€æœ‰å»¶é²é¡¯ç¤ºçš„ classï¼ŒåŠ å…¥ eager å±¬æ€§ -->
                <img :src="bannerUrl || 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80'" 
                     alt="Header" referrerpolicy="no-referrer"
                     class="w-full h-full object-cover"
                     loading="eager" decoding="sync">
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity z-20 flex items-center justify-center text-white text-sm font-bold">
                    <i class="fa-solid fa-camera mr-2"></i> æ›´æ›å°é¢
                </div>
            </label>
            <!-- éœ€æ±‚5: åˆªé™¤ Banner æŒ‰éˆ• -->
            <button v-if="bannerUrl" @click.stop="deleteBanner" class="banner-btn-delete">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>
    </div>

    <main class="px-4 pt-1">
        
        <!-- Tab: è¡Œç¨‹ (Itinerary) -->
        <div v-if="currentTab === 'itinerary'">
            <!-- Date Selector -->
            <div class="sticky top-0 z-30 bg-white/95 backdrop-blur-md -mx-4 px-4 pb-2 pt-1 shadow-sm rounded-b-2xl">
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 py-1 items-center">
                    
                    <!-- æ—¥æœŸå¡ç‰‡ -->
                    <div v-for="(day, index) in dates" :key="index"
                         @click="selectedDateIndex = index"
                         class="flex-shrink-0 w-[56px] h-[64px] rounded-xl flex flex-col items-center justify-center cursor-pointer border border-transparent transition-all"
                         :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white shadow-md' : 'bg-slate-50 text-slate-400'">
                        <span class="text-xs font-medium">{{ day.weekday }}</span>
                        <span class="text-lg font-bold leading-none mt-0.5">{{ day.date.split('/')[1] }}</span>
                        <span class="text-[9px] opacity-70">{{ day.date.split('/')[0] }}æœˆ</span>
                    </div>

                    <!-- è¨­å®šæŒ‰éˆ• -->
                    <div @click="showSettingsModal = true"
                         class="flex-shrink-0 w-[30px] h-[64px] flex flex-col items-center justify-center cursor-pointer text-slate-300 active:text-slate-500 transition-colors ml-1">
                        <i class="fa-solid fa-gear text-sm"></i>
                    </div>

                </div>
            </div>

            <!-- Header Info -->
            <div class="flex justify-between items-center my-3 px-1">
                <span class="text-xs font-bold text-slate-400">ç•¶æ—¥è¡Œç¨‹ ({{ currentItinerary.length }}) <span class="text-[10px] font-normal ml-1">è‡ªå‹•ä¾æ™‚é–“æ’åº</span></span>
            </div>

            <!-- Timeline -->
            <div class="pl-2 pb-24">
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-400 text-sm">
                    <i class="fa-solid fa-map-location-dot text-4xl mb-3 opacity-20 block"></i>
                    å°šæœªå®‰æ’è¡Œç¨‹ï¼ŒæŒ‰ + æ–°å¢
                </div>

                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group pb-6">
                    <div v-if="idx < currentItinerary.length - 1" class="timeline-line border-l-2 border-dashed border-slate-200"></div>
                    
                    <!-- é¡¯ç¤ºäº¤é€šè³‡è¨Š -->
                    <div v-if="item.transportType || idx > 0" class="pl-12 mb-2 flex items-center text-xs text-slate-400">
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded border border-slate-100">
                            <i :class="getTransportIcon(item.transportType || 'walk')" class="mr-1.5 opacity-60"></i>
                            <span>{{ getTransportName(item.transportType) || 'ç§»å‹•' }}</span>
                            <span v-if="item.transportTime" class="ml-1 text-slate-500 font-bold">({{ item.transportTime }})</span>
                        </div>
                    </div>

                    <!-- èˆªç­ -->
                    <div v-if="item.category === 'flight'" class="flex items-start relative z-10">
                        <div class="flex flex-col items-center mr-3 w-12 flex-shrink-0">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm ring-4 ring-white bg-sky-500">
                                <i class="fa-solid fa-plane"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-500 mt-1 bg-white px-1 rounded">{{ item.startTime }}</span>
                        </div>
                        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden flex cursor-pointer active:scale-[0.99] transition-transform"
                             @click="openDetailPreview(item)">
                            <div class="p-3 flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-base font-bold text-slate-800 leading-tight truncate pr-1">{{ item.name }}</h3>
                                </div>
                                <div class="text-xs text-sky-600 font-bold mt-1">
                                    <i class="fa-solid fa-plane-departure mr-1"></i>{{ item.deptFlightNo }} ({{ item.deptAirport }} <i class="fa-solid fa-arrow-right text-[10px]"></i> {{ item.arrAirport }})
                                </div>
                                <p class="text-xs text-slate-500 truncate mt-1" v-if="item.note">{{ item.note }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸€èˆ¬è¡Œç¨‹ -->
                    <div v-else class="flex items-start relative z-10">
                        <div class="flex flex-col items-center mr-3 w-12 flex-shrink-0">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm ring-4 ring-white" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-500 mt-1 bg-white px-1 rounded">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden flex cursor-pointer active:scale-[0.99] transition-transform"
                             @click="openDetailPreview(item)">
                            
                            <div class="p-3 flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-base font-bold text-slate-800 leading-tight truncate pr-1">{{ item.name }}</h3>
                                    <span v-if="item.price" class="text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded font-bold shrink-0">Â¥{{ item.price }}</span>
                                </div>
                                
                                <div v-if="item.category === 'food' && item.foodItem" class="text-xs text-orange-600 font-bold mt-1">
                                    <i class="fa-solid fa-utensils mr-1"></i>{{ item.foodItem }}
                                </div>
                                
                                <p class="text-xs text-slate-500 truncate mt-1" v-if="item.note">{{ item.note }}</p>
                            </div>

                            <div v-if="item.images && item.images.length > 0" class="w-20 bg-slate-100 relative">
                                <img :src="item.images[0]" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                                <div v-if="item.images.length > 1" class="absolute bottom-0 right-0 bg-black/50 text-white text-[9px] px-1.5 py-0.5 rounded-tl">
                                    +{{ item.images.length - 1 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è³¼ç‰© (Shopping) -->
        <div v-if="currentTab === 'shopping'" class="pb-24">
            <div class="flex p-1 bg-slate-100 rounded-2xl mb-4">
                <button @click="shoppingSubTab = 'souvenir'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'souvenir' ? 'bg-white text-pink-500 shadow-sm' : 'text-slate-400'">
                    ä¼´æ‰‹ç¦®
                </button>
                <button @click="shoppingSubTab = 'cosmetic'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'cosmetic' ? 'bg-white text-teal-500 shadow-sm' : 'text-slate-400'">
                    è—¥å¦
                </button>
            </div>

            <div class="flex flex-col gap-3">
                <!-- éœ€æ±‚3ï¼šä¿®æ­£é»æ“Šç¯„åœå•é¡Œ -->
                <div v-for="(item, idx) in filteredShoppingList" :key="item.id" 
                     @click="openShoppingDetail(item)"
                     class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-3 cursor-pointer active:bg-slate-50 transition-all relative overflow-hidden"
                     :class="{'opacity-60 grayscale': item.isPurchased}">
                    
                    <!-- å‹¾é¸æ¡† -->
                    <div @click.stop="toggleShoppingCheck(item)" 
                         class="w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors flex-shrink-0 z-20"
                         :class="item.isPurchased ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300 text-transparent'">
                        <i class="fa-solid fa-check text-xs"></i>
                    </div>

                    <!-- Image -->
                    <div class="w-20 h-20 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0 relative border border-slate-200">
                         <img v-if="item.images && item.images.length > 0" :src="item.images[0]" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image"></i></div>
                    </div>
                    
                    <!-- Info -->
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <h4 class="font-bold text-slate-800 text-sm truncate mb-1" :class="{'line-through text-slate-400': item.isPurchased}">{{ item.name }}</h4>
                        
                        <div class="flex items-center gap-2 mb-1">
                             <span v-if="item.price" class="bg-yellow-50 text-yellow-700 px-1.5 py-0.5 rounded text-xs font-bold">Â¥{{ item.price }}</span>
                             <span v-if="item.quantity" class="text-xs text-slate-500">x{{ item.quantity }}</span>
                        </div>
                        
                        <div v-if="item.shopName" class="text-xs text-slate-500 truncate flex items-center gap-1">
                            <i class="fa-solid fa-store text-[10px] opacity-70"></i> {{ item.shopName }}
                        </div>
                        <div v-if="item.address" class="text-[10px] text-slate-400 truncate mt-0.5">
                            {{ item.address }}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-col items-center gap-2 z-20">
                        <a v-if="item.address" :href="'https://www.google.com/maps/search/?api=1&query='+item.address" @click.stop target="_blank" 
                           class="w-8 h-8 rounded-full bg-blue-50 text-deep-sea-blue flex items-center justify-center shadow-sm hover:bg-blue-100 transition-colors">
                            <i class="fa-solid fa-location-arrow text-xs"></i>
                        </a>
                        <div v-else class="w-8 h-8"></div>
                        <div class="text-slate-300 text-xs"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: èŠ±è²» (Expenses) -->
        <div v-if="currentTab === 'expenses'" class="pb-24">
            <!-- Blue Card Header -->
            <div class="bg-gradient-to-r from-[#007EA7] to-[#00A8E8] text-white rounded-3xl py-4 px-6 mb-4 shadow-xl relative overflow-hidden">
                <div class="relative z-10 text-center">
                    <p class="text-xs text-blue-100 mb-1 opacity-90">ç›®å‰ç¸½èŠ±è²» (JPY)</p>
                    <h2 class="text-4xl font-bold mb-2 tracking-tight">Â¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                    <p class="text-xs text-blue-100 font-medium text-right">ç´„ NT$ {{ formatNumber(totalExpensesTWD) }}</p>
                </div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
            </div>

            <!-- List Header -->
            <div class="flex items-center gap-2 mb-4 px-1">
                <i class="fa-solid fa-receipt text-slate-300"></i>
                <h3 class="font-bold text-slate-700">æ”¯å‡ºç´€éŒ„</h3>
            </div>
            
            <!-- Expenses List -->
            <div class="space-y-4">
                <div v-for="exp in expenses" :key="exp.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-50 relative">
                    <div class="flex items-start">
                        <!-- Icon -->
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-md mr-3 shrink-0 mt-1" 
                             :class="getExpenseCatInfo(exp.category).color">
                            <i :class="getExpenseCatInfo(exp.category).icon"></i>
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 min-w-0 mr-2">
                            <div class="font-bold text-slate-700 text-base leading-tight">{{ exp.name }}</div>
                            <div class="text-xs text-slate-400 mt-1 font-medium">
                                {{ exp.date }} Â· {{ getPaymentLabel(exp.payment) }}
                            </div>
                            <div v-if="exp.note" class="mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded-lg break-words">
                                {{ exp.note }}
                            </div>
                        </div>
                        
                        <!-- Right Side: Amount & Actions -->
                        <div class="flex flex-col justify-between items-end h-full min-h-[60px]">
                            <!-- Amount (Top Right) -->
                            <div class="font-bold text-slate-700 text-lg mb-3">Â¥{{ formatNumber(exp.amount) }}</div>
                            
                            <!-- Actions (Bottom Right) -->
                            <div class="flex items-center gap-2">
                                <button @click="editExpense(exp)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                                <button @click="removeExpense(exp.id)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="expenses.length === 0" class="text-center py-10 text-slate-400 text-sm">
                    å°šç„¡æ”¯å‡ºç´€éŒ„
                </div>
            </div>
        </div>

        <!-- Tab: è³‡è¨Š (Info) -->
        <div v-if="currentTab === 'info'" class="pb-28">
            
            <!-- éœ€æ±‚4ï¼šåŒ¯ç‡æ›ç®—é€æ˜åŒ– (ç§»é™¤è—è‰²èƒŒæ™¯) -->
            <div class="p-4 mb-2 relative overflow-hidden">
                <div class="flex items-center gap-2 mb-4 relative z-10 text-slate-700">
                    <i class="fa-solid fa-calculator text-deep-sea-blue"></i>
                    <h3 class="font-bold">åŒ¯ç‡æ›ç®—</h3>
                </div>

                <div class="flex items-center gap-3 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-slate-400 block mb-1 ml-1">JPY (æ—¥å¹£)</label>
                        <div class="bg-white rounded-xl px-3 py-2 border border-slate-200 shadow-sm">
                            <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-transparent text-xl font-bold outline-none text-slate-700 placeholder-slate-300">
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-slate-300 mt-5"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-slate-400 block mb-1 ml-1">TWD (å°å¹£)</label>
                        <div class="bg-white rounded-xl px-3 py-2 border border-slate-200 shadow-sm">
                            <div class="text-xl font-bold text-slate-700">$ {{ formatNumber(currencyResult) }}</div>
                        </div>
                    </div>
                </div>
                <!-- åŒ¯ç‡ä¾†æº -->
                <div class="text-[10px] text-slate-400 text-right mt-2 font-mono">
                    è¨ˆç®—åŒ¯ç‡: {{ currentRate }} ({{ rateSource }})
                </div>
            </div>

            <!-- éŠ€è¡Œå„ªæƒ åˆ—è¡¨ -->
            <div class="mb-6">
                <button @click="showBankOffersModal = true" class="w-full bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between group active:scale-[0.99] transition-transform">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg">
                            <i class="fa-solid fa-credit-card"></i>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-slate-700">éŠ€è¡Œå„ªæƒ åˆ—è¡¨</div>
                            <div class="text-xs text-slate-400">ä¿¡ç”¨å¡å›é¥‹èˆ‡å„ªæƒ è³‡è¨Š</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                </button>
            </div>

            <!-- 2. ä½å®¿è³‡è¨Š -->
            <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-slate-800">
                    <i class="fa-solid fa-hotel text-indigo-500"></i>
                    <h3 class="font-bold">ä½å®¿è³‡è¨Š</h3>
                </div>

                <div v-if="allAccommodations.length === 0" class="text-center py-8 text-slate-400 text-xs bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                    å°šæœªæ–°å¢ä½å®¿è¡Œç¨‹
                </div>

                <div class="divide-y divide-slate-100">
                    <div v-for="hotel in allAccommodations" :key="hotel.id" class="py-4 first:pt-0 last:pb-0">
                         <div class="flex items-start justify-between gap-3">
                             <div class="flex-1 min-w-0">
                                 <h4 class="font-bold text-slate-800 text-base mb-2 truncate">{{ hotel.name }}</h4>
                                 <div class="inline-flex items-center bg-slate-100 text-slate-500 rounded-full px-3 py-1 text-xs font-medium mb-3">
                                    {{ getHotelDurationLabel(hotel) }}
                                 </div>
                                 <div v-if="hotel.note" class="flex items-center gap-2 text-slate-500 text-xs mb-1.5">
                                     <i class="fa-solid fa-pen w-4 text-center text-slate-300"></i>
                                     <span class="whitespace-pre-wrap" v-html="linkify(hotel.note)"></span>
                                 </div>
                                 <div class="flex items-start gap-2 text-slate-500 text-xs">
                                     <i class="fa-solid fa-location-dot w-4 text-center text-slate-300 mt-0.5"></i>
                                     <span class="break-words leading-relaxed">{{ hotel.address || 'å°šæœªè¼¸å…¥åœ°å€' }}</span>
                                 </div>
                             </div>
                             <a v-if="hotel.address" :href="'https://www.google.com/maps/search/?api=1&query='+hotel.address" target="_blank" 
                                class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center flex-shrink-0 shadow-sm active:scale-95 transition-transform mt-2">
                                 <i class="fa-solid fa-location-arrow"></i>
                             </a>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item" :class="{ active: currentTab === 'itinerary' }" @click="currentTab = 'itinerary'">
            <i class="fa-solid fa-map-location-dot"></i><span>è¡Œç¨‹</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'shopping' }" @click="currentTab = 'shopping'">
            <i class="fa-solid fa-bag-shopping"></i><span>è³¼ç‰©</span>
        </button>
        <!-- FAB Center Button -->
        <button class="fab-center" @click="handleAddClick"><i class="fa-solid fa-plus"></i></button>
        <button class="nav-item" :class="{ active: currentTab === 'expenses' }" @click="currentTab = 'expenses'">
            <i class="fa-solid fa-wallet"></i><span>èŠ±è²»</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'info' }" @click="currentTab = 'info'">
            <i class="fa-solid fa-circle-info"></i><span>è³‡è¨Š</span>
        </button>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- Bank Offers Modal -->
    <div v-if="showBankOffersModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm h-[70vh] flex flex-col relative z-10 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-bold text-lg text-slate-800">éŠ€è¡Œå„ªæƒ åˆ—è¡¨</h3>
                <button @click="closeAllModals" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex-1 p-4 overflow-y-auto">
                <div v-if="!isEditingBankOffers" class="whitespace-pre-wrap text-sm text-slate-700 leading-relaxed" v-html="linkify(bankOffersContent || 'å°šæœªè¼¸å…¥å„ªæƒ è³‡è¨Š')">
                </div>
                <textarea v-else v-model="bankOffersContent" class="w-full h-full border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:border-deep-sea-blue resize-none" placeholder="è«‹è¼¸å…¥ä¿¡ç”¨å¡å„ªæƒ ã€å›é¥‹è³‡è¨Š... (æ”¯æ´ Emoji èˆ‡ç¬¦è™Ÿ)"></textarea>
            </div>

            <div class="p-4 border-t border-slate-100 flex gap-3">
                <button v-if="!isEditingBankOffers" @click="closeAllModals" class="w-1/3 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">è¿”å›</button>
                <button v-if="!isEditingBankOffers" @click="isEditingBankOffers = true" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">ç·¨è¼¯</button>

                <button v-if="isEditingBankOffers" @click="isEditingBankOffers = false" class="w-1/3 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">å–æ¶ˆ</button>
                <button v-if="isEditingBankOffers" @click="saveBankOffers" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- 1. Itinerary Detail Modal (READ ONLY) -->
    <div v-if="showItineraryDetailModal && previewItem" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative z-10 max-h-[90vh] overflow-y-auto">
            <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center z-20 backdrop-blur-md"><i class="fa-solid fa-xmark"></i></button>

            <!-- Image Area -->
            <div class="relative h-60 bg-slate-100 group" @click="openLightbox(previewItem.images ? previewItem.images[currentGalleryIndex] : null)">
                <img v-if="previewItem.images && previewItem.images.length > 0" :src="previewItem.images[currentGalleryIndex]" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                <div v-else class="w-full h-full flex flex-col items-center justify-center text-slate-400 bg-slate-50">
                    <i :class="getCategoryIcon(previewItem.category)" class="text-6xl opacity-30 mb-2"></i>
                    <span class="text-xs">ç„¡ç…§ç‰‡</span>
                </div>
            </div>

            <div class="p-6">
                <!-- Detail content -->
                <div class="mb-4">
                    <div class="flex gap-2 mb-2">
                        <span class="text-xs font-bold px-2 py-1 rounded text-white inline-block" :class="getCategoryColor(previewItem.category)">{{ getCategoryName(previewItem.category) }}</span>
                    </div>
                    <h2 v-if="previewItem.category !== 'flight'" class="text-2xl font-bold text-slate-800 leading-tight">
                        {{ previewItem.name }}
                    </h2>
                     <div v-if="previewItem.category === 'food' && previewItem.foodItem" class="mt-2 flex items-center text-orange-600 font-bold bg-orange-50 px-3 py-2 rounded-lg">
                        <i class="fa-solid fa-utensils mr-2"></i> {{ previewItem.foodItem }}
                     </div>
                </div>

                <!-- æ©Ÿç¥¨è©³ç´°UI -->
                <div v-if="previewItem.category === 'flight' && previewItem.deptAirport" class="mb-6 bg-sky-50 rounded-xl p-4 border border-sky-100 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-sky-400"></div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-center flex-1">
                            <div class="text-3xl font-black text-slate-700 tracking-wider">{{ previewItem.deptAirport }}</div>
                            <div class="text-xs text-slate-500 font-bold">{{ previewItem.deptTerminal ? 'T'+previewItem.deptTerminal : 'èˆªå»ˆ -' }}</div>
                            <div class="text-lg font-bold text-sky-700 mt-1">{{ previewItem.startTime }}</div>
                        </div>
                        <div class="flex flex-col items-center justify-center px-2 w-16 opacity-50">
                            <i class="fa-solid fa-plane text-sky-400 text-xl transform rotate-45 mb-1"></i>
                            <div class="w-full border-t-2 border-dashed border-sky-300"></div>
                        </div>
                        <div class="text-center flex-1">
                            <div class="text-3xl font-black text-slate-700 tracking-wider">{{ previewItem.arrAirport }}</div>
                            <div class="text-xs text-slate-500 font-bold">{{ previewItem.arrTerminal ? 'T'+previewItem.arrTerminal : 'èˆªå»ˆ -' }}</div>
                            <div class="text-lg font-bold text-sky-700 mt-1">{{ previewItem.endTime || '--:--' }}</div>
                        </div>
                    </div>
                    <div class="border-t border-sky-200 pt-2 flex justify-between text-[10px] text-sky-700">
                        <span><i class="fa-solid fa-plane-departure mr-1"></i>{{ previewItem.deptFlightNo || previewItem.name }}</span>
                        <span v-if="previewItem.arrFlightNo"><i class="fa-solid fa-plane-arrival mr-1"></i>{{ previewItem.arrFlightNo }}</span>
                    </div>
                </div>
                
                <!-- é¡¯ç¤ºäº¤é€šè³‡è¨Š -->
                <div v-if="previewItem.transportType" class="mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-slate-500 shadow-sm"><i :class="getTransportIcon(previewItem.transportType)"></i></div>
                    <div>
                        <div class="text-xs text-slate-400">äº¤é€šæ–¹å¼</div>
                        <div class="text-sm font-bold text-slate-700">
                            {{ getTransportName(previewItem.transportType) }}
                            <span v-if="previewItem.transportTime"> - {{ previewItem.transportTime }}</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <!-- æ™‚é–“ -->
                    <div v-if="previewItem.category !== 'flight'" class="flex items-start gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-regular fa-clock"></i></div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-700">é è¨ˆæ™‚é–“: {{ previewItem.startTime || '--:--' }}</p>
                            <p v-if="previewItem.openTime" class="text-xs text-slate-500">ç‡Ÿæ¥­æ™‚é–“: {{ previewItem.openTime }}</p>
                            <p v-if="previewItem.checkOutDate" class="text-xs text-indigo-600">é€€æˆ¿: {{ previewItem.checkOutDate }}</p>
                        </div>
                    </div>
                    <!-- åƒ¹æ ¼ -->
                    <div v-if="previewItem.price" class="flex items-center gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-yen-sign"></i></div>
                        <div class="text-sm font-bold text-slate-700">{{ previewItem.price }}</div>
                    </div>
                    <!-- ä»˜æ¬¾æ–¹å¼ -->
                    <div v-if="previewItem.paymentMethods && previewItem.paymentMethods.length > 0" class="flex items-center gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-wallet"></i></div>
                        <div class="flex gap-1 flex-wrap">
                            <span v-for="pm in previewItem.paymentMethods" :key="pm" class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded font-bold">{{ getPaymentName(pm) }}</span>
                        </div>
                    </div>
                    
                    <div v-if="previewItem.address" class="flex items-start gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-location-dot"></i></div>
                        <div class="flex-1">
                            <p class="text-sm text-slate-700 mb-1">{{ previewItem.address }}</p>
                            <a :href="'https://www.google.com/maps/search/?api=1&query='+previewItem.address" target="_blank" class="inline-block text-xs bg-slate-100 px-3 py-1.5 rounded-lg text-slate-600 font-bold hover:bg-slate-200"><i class="fa-solid fa-map-location-dot mr-1"></i> Google å°èˆª</a>
                        </div>
                    </div>
                    <!-- å‚™è¨» -->
                    <div v-if="previewItem.note" class="flex items-start gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-note-sticky"></i></div>
                        <p class="text-sm text-slate-600 whitespace-pre-wrap bg-slate-50 p-2 rounded-lg flex-1" v-html="linkify(previewItem.note)"></p>
                    </div>
                </div>

                <div v-if="previewItem.files && previewItem.files.length > 0" class="mb-6">
                    <p class="text-xs font-bold text-slate-400 mb-2">é™„ä»¶æª”æ¡ˆ</p>
                    <div class="space-y-2">
                        <!-- éœ€æ±‚1ï¼šé¡¯ç¤ºæ­£ç¢ºæª”å -->
                        <div v-for="(file, idx) in previewItem.files" :key="idx" @click="openFile(file)" class="flex items-center p-3 bg-slate-50 rounded-xl border border-slate-100 cursor-pointer hover:bg-slate-100">
                            <i class="fa-solid fa-file-pdf text-red-400 text-xl mr-3"></i>
                            <span class="text-sm font-bold text-slate-700 flex-1 truncate">{{ file.name || 'é™„ä»¶' }}</span>
                            <i class="fa-solid fa-arrow-up-right-from-square text-slate-300 text-xs ml-2"></i>
                        </div>
                    </div>
                </div>

                <button @click="switchToEditItinerary" class="w-full py-3.5 bg-deep-sea-blue text-white rounded-xl font-bold shadow-lg shadow-blue-900/20"><i class="fa-solid fa-pen mr-2"></i> ç·¨è¼¯è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- 3. Itinerary Add/Edit Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}è¡Œç¨‹</h3>
            
            <div class="space-y-4">
                <!-- æ—¥æœŸé¸æ“‡ -->
                <div>
                    <label class="form-label text-deep-sea-blue">ğŸ“… æ—¥æœŸ</label>
                    <select v-model="newItinerary.dayIndex" class="input-field border-blue-200 bg-blue-50 font-bold">
                        <option v-for="(d, i) in dates" :key="i" :value="i">
                            Day {{ i + 1 }} - {{ d.date }} ({{ d.weekday }})
                        </option>
                    </select>
                </div>

                <div><label class="form-label">é¡å‹</label>
                    <select v-model="newItinerary.category" class="input-field">
                        <option value="sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="food">ğŸ´ é£²é£Ÿ</option>
                        <option value="accommodation">ğŸ¨ ä½å®¿</option>
                        <option value="flight">âœˆï¸ èˆªç­</option>
                        <option value="transport">ğŸšŒ äº¤é€š</option>
                    </select>
                </div>
                
                <!-- è»Šç¨‹æ™‚é–“ -->
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <label class="form-label text-slate-500 mb-2">ğŸš— å‰å¾€æ­¤è™•çš„äº¤é€š (é¸å¡«)</label>
                    <div class="flex items-center gap-2 mb-2">
                        <select v-model="newItinerary.transportType" class="input-field bg-white flex-1">
                            <option value="">ç„¡ / æœªè¨­å®š</option>
                            <option value="public">ğŸš‡ åœ°éµ/JR</option>
                            <option value="bus">ğŸšŒ å·´å£«</option>
                            <option value="walk">ğŸš¶ æ­¥è¡Œ</option>
                            <option value="car">ğŸš• è¨ˆç¨‹è»Š/è‡ªé§•</option>
                            <option value="hsr">ğŸš„ æ–°å¹¹ç·š</option>
                            <option value="flight">âœˆï¸ é£›æ©Ÿ</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 flex items-center bg-white rounded-lg border border-slate-200 px-2">
                            <input type="number" v-model="newItinerary.transportH" class="w-full py-2 outline-none text-center" placeholder="0">
                            <span class="text-xs text-slate-400 shrink-0">å°æ™‚</span>
                        </div>
                        <div class="flex-1 flex items-center bg-white rounded-lg border border-slate-200 px-2">
                            <input type="number" v-model="newItinerary.transportM" class="w-full py-2 outline-none text-center" placeholder="0">
                            <span class="text-xs text-slate-400 shrink-0">åˆ†</span>
                        </div>
                    </div>
                </div>

                <!-- 1. é¤å»³ -->
                <div v-if="newItinerary.category === 'food'" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                        <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newItinerary.openTime" class="input-field"></div>
                    </div>
                    <div><label class="form-label">é¤å»³åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                    <div><label class="form-label">å“å (æƒ³åƒçš„èœ)</label><input v-model="newItinerary.foodItem" placeholder="ä¾‹å¦‚ï¼šæˆå‰æ€æ±—çƒ¤è‚‰" class="input-field"></div>
                    <div><label class="form-label">åƒ¹æ ¼</label><input v-model="newItinerary.price" placeholder="Â¥" class="input-field"></div>
                    
                    <div>
                        <label class="form-label">ä»˜æ¬¾æ–¹å¼ (å¯è¤‡é¸)</label>
                        <div class="flex gap-2 flex-wrap">
                             <button v-for="pm in ['cash','card','paypay','suica']" :key="pm" 
                                     @click="togglePayment(pm, newItinerary)"
                                     class="px-3 py-2 rounded-lg text-xs font-bold border transition-colors"
                                     :class="newItinerary.paymentMethods?.includes(pm) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-400 border-slate-200'">
                                {{ getPaymentName(pm) }}
                             </button>
                        </div>
                    </div>

                    <div><label class="form-label">åœ°å€</label><input v-model="newItinerary.address" class="input-field"></div>
                    <div><label class="form-label">å®˜ç¶²é€£çµ</label><input v-model="newItinerary.website" placeholder="http://" class="input-field"></div>
                </div>

                <!-- 2. æ™¯é» -->
                <div v-else-if="newItinerary.category === 'sightseeing'" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                        <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newItinerary.openTime" class="input-field"></div>
                    </div>
                    <div><label class="form-label">æ™¯é»åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                    <div><label class="form-label">é–€ç¥¨åƒ¹æ ¼</label><input v-model="newItinerary.price" class="input-field"></div>
                    
                    <div>
                        <label class="form-label">ä»˜æ¬¾æ–¹å¼ (å¯è¤‡é¸)</label>
                        <div class="flex gap-2 flex-wrap">
                             <button v-for="pm in ['cash','card','paypay','suica']" :key="pm" 
                                     @click="togglePayment(pm, newItinerary)"
                                     class="px-3 py-2 rounded-lg text-xs font-bold border transition-colors"
                                     :class="newItinerary.paymentMethods?.includes(pm) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-400 border-slate-200'">
                                {{ getPaymentName(pm) }}
                             </button>
                        </div>
                    </div>
                    
                    <div><label class="form-label">åœ°å€</label><input v-model="newItinerary.address" class="input-field"></div>
                </div>

                <!-- 3. ä½å®¿ -->
                <div v-else-if="newItinerary.category === 'accommodation'" class="space-y-3 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                    <div><label class="form-label text-indigo-800">é£¯åº—åç¨±</label><input v-model="newItinerary.name" class="input-field bg-white"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label text-indigo-800">å…¥ä½æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field bg-white"></div>
                        <div><label class="form-label text-indigo-800">é€€æˆ¿æ—¥æœŸ</label><input v-model="newItinerary.checkOutDate" type="date" class="input-field bg-white"></div>
                    </div>
                    <div><label class="form-label text-indigo-800">åœ°å€</label><input v-model="newItinerary.address" class="input-field bg-white"></div>
                    
                    <div>
                        <label class="form-label text-indigo-800">ä»˜æ¬¾æ–¹å¼ (å¯è¤‡é¸)</label>
                        <div class="flex gap-2 flex-wrap">
                             <button v-for="pm in ['cash','card','paypay','suica']" :key="pm" 
                                     @click="togglePayment(pm, newItinerary)"
                                     class="px-3 py-2 rounded-lg text-xs font-bold border transition-colors"
                                     :class="newItinerary.paymentMethods?.includes(pm) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-indigo-200'">
                                {{ getPaymentName(pm) }}
                             </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label text-indigo-800">è¨‚å–®æª”æ¡ˆ</label>
                        <div class="space-y-2">
                             <div v-for="(file, idx) in newItinerary.files" :key="idx" class="flex items-center justify-between bg-white p-2 rounded text-xs border border-indigo-100">
                                <span class="truncate pr-2">{{file.name}}</span>
                                <button @click="removeFile(idx, newItinerary)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                             </div>
                             <label class="block w-full py-2 bg-white border border-dashed border-indigo-300 rounded-lg text-center text-indigo-400 cursor-pointer text-xs">
                                <input type="file" @change="(e) => handleFileUpload(e, newItinerary)" class="hidden" multiple accept="application/pdf,image/*">
                                <i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³ PDF/åœ–ç‰‡
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 4. èˆªç­ -->
                <div v-else-if="newItinerary.category === 'flight'" class="space-y-3 bg-sky-50 p-3 rounded-xl border border-sky-100">
                    <div><label class="form-label text-sky-800">æ¨™é¡Œ</label><input v-model="newItinerary.name" placeholder="ä¾‹å¦‚ï¼šå°åŒ— -> æœ­å¹Œ" class="input-field bg-white"></div>
                    <div><label class="form-label text-sky-800">å‡ºç™¼æ©Ÿå ´</label><input v-model="newItinerary.deptAirport" placeholder="TPE" class="input-field bg-white"></div>
                    <div class="grid grid-cols-2 gap-3">
                         <div><label class="form-label text-sky-800">èˆªç­è™Ÿ</label><input v-model="newItinerary.deptFlightNo" placeholder="JX800" class="input-field bg-white"></div>
                         <div><label class="form-label text-sky-800">å‡ºç™¼æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field bg-white"></div>
                    </div>
                    <div><label class="form-label text-sky-800">æŠµé”æ©Ÿå ´</label><input v-model="newItinerary.arrAirport" placeholder="CTS" class="input-field bg-white"></div>
                    <div class="grid grid-cols-2 gap-3">
                         <div><label class="form-label text-sky-800">èˆªç­è™Ÿ</label><input v-model="newItinerary.arrFlightNo" placeholder="JX800" class="input-field bg-white"></div>
                         <div><label class="form-label text-sky-800">æŠµé”æ™‚é–“</label><input v-model="newItinerary.endTime" type="time" class="input-field bg-white"></div>
                    </div>
                    
                    <div class="mt-2">
                        <label class="form-label text-sky-800">èˆªå»ˆè³‡è¨Š (é¸å¡«)</label>
                        <div class="grid grid-cols-2 gap-3">
                             <input v-model="newItinerary.deptTerminal" placeholder="å‡ºç™¼èˆªå»ˆ" class="input-field bg-white">
                             <input v-model="newItinerary.arrTerminal" placeholder="æŠµé”èˆªå»ˆ" class="input-field bg-white">
                        </div>
                    </div>
                     <div class="mt-2">
                        <label class="form-label text-sky-800">é›»å­æ©Ÿç¥¨/é™„ä»¶</label>
                        <div class="space-y-2">
                             <div v-for="(file, idx) in newItinerary.files" :key="idx" class="flex items-center justify-between bg-white p-2 rounded text-xs border border-sky-100">
                                <span class="truncate pr-2">{{file.name}}</span>
                                <button @click="removeFile(idx, newItinerary)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                             </div>
                             <label class="block w-full py-2 bg-white border border-dashed border-sky-300 rounded-lg text-center text-sky-400 cursor-pointer text-xs">
                                <input type="file" @change="(e) => handleFileUpload(e, newItinerary)" class="hidden" multiple accept="application/pdf,image/*">
                                <i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³ PDF/åœ–ç‰‡
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 5. å…¶ä»–/äº¤é€š -->
                <div v-else class="space-y-3">
                     <div><label class="form-label">åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                     <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                </div>

                <div><label class="form-label">å‚™è¨» (æ”¯æ´ç¶²å€)</label><textarea v-model="newItinerary.note" rows="2" class="input-field"></textarea></div>
                
                <div class="flex gap-2 pt-2">
                    <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveItineraryItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Shopping Add/Edit Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}è³¼ç‰©æ¸…å–®</h3>
            
            <div class="space-y-3">
                <!-- Name -->
                <div><label class="form-label">å•†å“åç¨±</label><input v-model="newShoppingItem.name" class="input-field"></div>
                
                <!-- Price & Qty -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="form-label">é ä¼°åƒ¹æ ¼</label><input v-model="newShoppingItem.price" type="number" class="input-field"></div>
                    <div><label class="form-label">æ•¸é‡</label><input v-model="newShoppingItem.quantity" type="number" class="input-field"></div>
                </div>

                <!-- Shop Info -->
                <div><label class="form-label">å•†åº—åç¨±</label><input v-model="newShoppingItem.shopName" class="input-field"></div>
                
                <div class="grid grid-cols-1 gap-3">
                    <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newShoppingItem.openTime" class="input-field"></div>
                </div>
                
                <!-- ä»˜æ¬¾æ–¹å¼ -->
                <div>
                    <label class="form-label">ä»˜æ¬¾æ–¹å¼ (å¯è¤‡é¸)</label>
                    <div class="flex gap-2 flex-wrap">
                         <button v-for="pm in ['cash','card','paypay','suica']" :key="pm" 
                                 @click="togglePayment(pm, newShoppingItem)"
                                 class="px-3 py-2 rounded-lg text-xs font-bold border transition-colors"
                                 :class="newShoppingItem.paymentMethods?.includes(pm) ? 'bg-deep-sea-blue text-white border-blue-800' : 'bg-white text-slate-400 border-slate-200'">
                            {{ getPaymentName(pm) }}
                         </button>
                    </div>
                </div>

                <div><label class="form-label">åœ°å€</label><input v-model="newShoppingItem.address" class="input-field"></div>
                <div><label class="form-label">å®˜ç¶²é€£çµ</label><input v-model="newShoppingItem.website" class="input-field"></div>
                
                <!-- Note -->
                <div><label class="form-label">å‚™è¨» (æ”¯æ´ç¶²å€)</label><textarea v-model="newShoppingItem.note" rows="2" class="input-field"></textarea></div>

                <!-- Images -->
                <div>
                    <label class="form-label">åœ–ç‰‡</label>
                    <div class="image-preview-grid mb-2">
                        <div v-for="(img, idx) in newShoppingItem.images" :key="idx" class="image-preview-item">
                            <img :src="img">
                            <button @click="removeImage(idx, newShoppingItem)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 cursor-pointer border-dashed">
                            <input type="file" multiple accept="image/*" @change="(e) => handleImageUpload(e, newShoppingItem)" class="hidden">
                            <i class="fa-solid fa-plus text-slate-300"></i>
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 pt-2">
                    <button v-if="isEditMode" @click="removeShoppingItem(newShoppingItem.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveShoppingItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Settings Modal -->
    <div v-if="showSettingsModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10 max-h-[80vh] overflow-y-auto">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-6 text-center">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-6">
                <!-- å‡ºç™¼æ—¥æœŸ -->
                <div>
                    <label class="form-label">å‡ºç™¼æ—¥æœŸ</label>
                    <input type="date" v-model="tripSettings.startDate" class="input-field">
                </div>
                
                <!-- æ‰‹å‹•åŒ¯ç‡è¨­å®š -->
                <div>
                    <label class="form-label">æ‰‹å‹•åŒ¯ç‡ (å¯è¼¸å…¥éŠ€è¡Œæ›åŒ¯åŒ¯ç‡)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" v-model="tripSettings.manualRate" step="0.001" placeholder="ä¾‹å¦‚ 0.22" class="input-field flex-1">
                        <div class="text-xs text-slate-400">ç›®å‰: {{ currentRate }}</div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1">è‹¥æœªè¨­å®šï¼Œå°‡ä½¿ç”¨ API å¸‚å ´ä¸­åƒ¹ (é€šå¸¸è¼ƒä½)ã€‚</p>
                </div>

                <!-- ç®¡ç†æ—¥æœŸ -->
                <div>
                    <label class="form-label mb-2">ç®¡ç†æ—¥æœŸ (åƒ…å¯åˆªé™¤æœ€å¾Œä¸€å¤©)</label>
                    <div class="space-y-2">
                        <div v-for="(d, i) in dates" :key="i" class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div class="text-sm font-bold text-slate-700">
                                Day {{ i+1 }} - {{ d.date }}
                            </div>
                            <!-- åªå…è¨±åˆªé™¤æœ€å¾Œä¸€å¤© -->
                            <button v-if="i === dates.length - 1 && dates.length > 1" 
                                    @click="deleteLastDate" 
                                    class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition-colors">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>
                        </div>
                        <button @click="changeDuration(1)" class="w-full py-2 border-2 border-dashed border-slate-200 text-slate-400 rounded-xl font-bold text-sm hover:border-deep-sea-blue hover:text-deep-sea-blue transition-colors">
                            <i class="fa-solid fa-plus mr-1"></i> æ–°å¢ä¸€å¤©
                        </button>
                    </div>
                </div>

                <button @click="saveTripSettings" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold mt-2">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>
    
    <!-- 6. Expense Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[90vh] overflow-y-auto p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-6 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}æ”¯å‡º</h3>
            <div class="space-y-4">
                 
                 <!-- Category -->
                 <div>
                    <label class="form-label">é¡åˆ¥</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button v-for="cat in ['transport','food','accommodation','ticket','shopping','other']" 
                                :key="cat"
                                @click="newExpense.category = cat"
                                class="py-2 rounded-lg border text-xs font-bold transition-all flex flex-col items-center justify-center gap-1"
                                :class="newExpense.category === cat ? 'bg-deep-sea-blue text-white border-transparent' : 'bg-slate-50 text-slate-500 border-slate-100'">
                             <i :class="getExpenseCatInfo(cat).icon"></i>
                             <span>{{ {transport:'äº¤é€š',food:'é£²é£Ÿ',accommodation:'ä½å®¿',ticket:'é–€ç¥¨',shopping:'è³¼ç‰©',other:'å…¶ä»–'}[cat] }}</span>
                        </button>
                    </div>
                 </div>

                 <!-- Name -->
                 <div><label class="form-label">åç¨±</label><input v-model="newExpense.name" class="input-field" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€JRè»Šç¥¨"></div>
                 
                 <!-- Date -->
                 <div><label class="form-label">æ—¥æœŸ</label><input v-model="newExpense.date" type="date" class="input-field"></div>

                 <!-- Amount -->
                 <div><label class="form-label">é‡‘é¡ (Â¥)</label><input v-model.number="newExpense.amount" type="number" class="input-field font-bold text-lg text-deep-sea-blue"></div>
                 
                 <!-- Payment -->
                 <div><label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="newExpense.payment='cash'" class="py-2 rounded-lg border text-xs font-bold" :class="newExpense.payment==='cash'?'bg-slate-700 text-white':'text-slate-400'">ç¾é‡‘</button>
                        <button @click="newExpense.payment='card'" class="py-2 rounded-lg border text-xs font-bold" :class="newExpense.payment==='card'?'bg-blue-600 text-white':'text-slate-400'">ä¿¡ç”¨å¡</button>
                        <button @click="newExpense.payment='paypay'" class="py-2 rounded-lg border text-xs font-bold" :class="newExpense.payment==='paypay'?'bg-red-500 text-white':'text-slate-400'">PayPay</button>
                        <button @click="newExpense.payment='suica'" class="py-2 rounded-lg border text-xs font-bold" :class="newExpense.payment==='suica'?'bg-green-600 text-white':'text-slate-400'">Suica</button>
                    </div>
                 </div>

                 <!-- Note -->
                 <div><label class="form-label">å‚™è¨»</label><textarea v-model="newExpense.note" rows="2" class="input-field"></textarea></div>

                 <button @click="saveExpense" class="w-full py-3 bg-accent-yellow text-yellow-900 rounded-xl font-bold mt-2">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- 7. Lightbox Zoom -->
    <div v-if="lightboxImage" class="lightbox" @click="lightboxImage = null">
        <img :src="lightboxImage" referrerpolicy="no-referrer" class="max-w-full max-h-screen object-contain p-2">
        <button class="absolute top-4 right-4 text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            const firebaseConfig = {
               apiKey: "AIzaSyA8wiv63sS1lbCkOOeYlZpL1RlKHvvAAYA",
                authDomain: "hokkaido-b390b.firebaseapp.com",
                projectId: "hokkaido-b390b",
                storageBucket: "hokkaido-b390b.firebasestorage.app",
                messagingSenderId: "199459788936",
                appId: "1:199459788936:web:f430fac50b022959f8e73d",
                measurementId: "G-3XGXW53RDB"
            };

            const TRIP_ID = 'family_hokkaido_2026';
            const DATA_PATH = 'shared_data';

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            const isLoading = ref(false);
            const loadingText = ref('');
            const toastMessage = ref('');
            const bannerLoaded = ref(false);

            // ä¿®æ”¹: åŠ å¼·å£“ç¸®è¨­å®š (1024px -> 800px, 0.6 -> 0.5)
            const compressImage = async (file) => {
                return new Promise((resolve) => {
                    const maxWidth = 800;
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.5);
                        };
                    };
                });
            };

            const currentTab = ref('itinerary');
            const shoppingSubTab = ref('souvenir');
            const dates = ref([]);
            const tripSettings = ref({ startDate: '2026-02-01', duration: 7, manualRate: null });
            const itineraryData = ref({});
            const shoppingList = ref([]);
            const expenses = ref([]);
            const bannerUrl = ref('');
            const selectedDateIndex = ref(0);
            const lightboxImage = ref(null);

            const showSettingsModal = ref(false);
            const showItineraryModal = ref(false);
            const showItineraryDetailModal = ref(false);
            const showShoppingModal = ref(false);
            const showShoppingDetailModal = ref(false);
            const showExpenseModal = ref(false);
            const showBankOffersModal = ref(false); 
            
            const isEditMode = ref(false);
            const isEditingBankOffers = ref(false);
            const bankOffersContent = ref('');
            
            const newItinerary = ref({ images: [], files: [], paymentMethods: [] });
            const newShoppingItem = ref({ images: [], paymentMethods: [] });
            const newExpense = ref({ payment: 'cash' });
            
            const previewItem = ref(null);
            const selectedShoppingItem = ref(null);
            const currentGalleryIndex = ref(0);
            const currencyInput = ref(10000);
            const currencyResult = ref(0);
            
            const apiRate = ref(0.215);
            const currentRate = computed(() => tripSettings.value.manualRate ? Number(tripSettings.value.manualRate) : apiRate.value);
            const rateSource = computed(() => tripSettings.value.manualRate ? 'æ‰‹å‹•è¨­å®š' : 'API');

            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const filteredShoppingList = computed(() => shoppingList.value.filter(item => item.category === shoppingSubTab.value));
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + e.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * currentRate.value));
            
            const allAccommodations = computed(() => {
                let hotels = [];
                Object.keys(itineraryData.value).forEach(dayIndex => {
                    itineraryData.value[dayIndex].forEach(item => {
                        if (item.category === 'accommodation') {
                            hotels.push({
                                ...item,
                                dayIndex: parseInt(dayIndex)
                            });
                        }
                    });
                });
                return hotels.sort((a, b) => a.dayIndex - b.dayIndex || (a.startTime || '').localeCompare(b.startTime || ''));
            });

            const getCategoryColor = (cat) => ({
                sightseeing: 'bg-emerald-400', food: 'bg-orange-400', shopping: 'bg-pink-400',
                flight: 'bg-sky-500', transport: 'bg-slate-400', accommodation: 'bg-indigo-500'
            }[cat] || 'bg-gray-400');
            const getCategoryIcon = (cat) => ({
                sightseeing: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping',
                flight: 'fa-solid fa-plane', transport: 'fa-solid fa-bus', accommodation: 'fa-solid fa-bed'
            }[cat] || 'fa-solid fa-info');
            const getCategoryName = (cat) => ({
                sightseeing: 'æ™¯é»', food: 'é£²é£Ÿ', shopping: 'è³¼ç‰©', flight: 'èˆªç­', transport: 'äº¤é€š', accommodation: 'ä½å®¿'
            }[cat] || 'è¡Œç¨‹');
            
            const getTransportIcon = (t) => ({ 
                walk: 'fa-solid fa-person-walking', 
                car: 'fa-solid fa-car', 
                bus: 'fa-solid fa-bus', 
                public: 'fa-solid fa-train-subway', 
                hsr: 'fa-solid fa-train',
                flight: 'fa-solid fa-plane' 
            }[t] || 'fa-solid fa-arrow-right');

            const getTransportName = (t) => ({
                walk: 'æ­¥è¡Œ', car: 'è‡ªé§•/è¨ˆç¨‹è»Š', bus: 'å·´å£«', public: 'åœ°éµ/JR', hsr: 'æ–°å¹¹ç·š', flight: 'é£›æ©Ÿ'
            }[t] || '');
            
            const getPaymentName = (pm) => ({
                cash: 'ç¾é‡‘', card: 'ä¿¡ç”¨å¡', paypay: 'PayPay', suica: 'Suica/IC'
            }[pm] || pm);

            const formatNumber = (n) => n?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * currentRate.value);
            
            const getDateString = (idx) => dates.value[idx] ? `${dates.value[idx].date} (${dates.value[idx].weekday})` : '';
            const getDateSimple = (idx) => dates.value[idx] ? dates.value[idx].date : '';
            
            const getHotelDurationLabel = (hotel) => {
                const startDate = getDateSimple(hotel.dayIndex);
                if (!hotel.checkOutDate) return `${startDate} (1æ™š)`;
                try {
                    const startObj = new Date(tripSettings.value.startDate);
                    startObj.setDate(startObj.getDate() + hotel.dayIndex);
                    const endObj = new Date(hotel.checkOutDate);
                    const diffTime = Math.abs(endObj - startObj);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    const endMonth = endObj.getMonth() + 1;
                    const endDate = endObj.getDate();
                    return `${startDate} - ${endMonth}/${endDate} (${diffDays}æ™š)`;
                } catch (e) { return `${startDate} (å…¥ä½)`; }
            };

            const getExpenseCatInfo = (cat) => {
                const map = {
                    transport: { color: 'bg-blue-500', icon: 'fa-solid fa-train' },
                    food: { color: 'bg-red-500', icon: 'fa-solid fa-utensils' },
                    accommodation: { color: 'bg-purple-500', icon: 'fa-solid fa-bed' },
                    ticket: { color: 'bg-teal-500', icon: 'fa-solid fa-ticket' },
                    shopping: { color: 'bg-pink-500', icon: 'fa-solid fa-bag-shopping' },
                    other: { color: 'bg-gray-500', icon: 'fa-solid fa-ellipsis' }
                };
                return map[cat] || map.other;
            };
            
            const getPaymentLabel = (code) => {
                if(code === 'cash') return 'ç¾é‡‘';
                if(code === 'mobile') return 'è¡Œå‹•æ”¯ä»˜';
                if(code === 'ic') return 'è¥¿ç“œå¡/IC';
                if(code === 'card') return 'ä¿¡ç”¨å¡';
                if(code === 'paypay') return 'PayPay';
                if(code === 'suica') return 'Suica';
                return 'å…¶ä»–';
            };

            const linkify = (text) => {
                if (!text) return '';
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, (url) => {
                    return `<a href="${url}" target="_blank" class="text-blue-500 underline break-all" @click.stop>${url}</a>`;
                });
            };

            const fetchExchangeRate = async () => {
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                    const data = await res.json();
                    if(data && data.rates && data.rates.TWD) {
                        apiRate.value = data.rates.TWD;
                    }
                } catch(e) {
                    console.error("Rate fetch failed", e);
                }
                calculateCurrency();
            };

            onMounted(async () => {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { if (user) setupListeners(); });
                fetchExchangeRate();
            });

            const generateDates = () => {
                const arr = [];
                const start = new Date(tripSettings.value.startDate);
                const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                for(let i=0; i<tripSettings.value.duration; i++){
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    arr.push({ date: `${d.getMonth()+1}/${d.getDate()}`, weekday: weekdays[d.getDay()] });
                }
                dates.value = arr;
            };

            const setupListeners = () => {
                onSnapshot(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), (snap) => {
                    if(snap.exists()){
                        const d = snap.data();
                        bannerUrl.value = d.headerImage;
                        bankOffersContent.value = d.bankOffersNote || '';
                        if(d.tripStartDate) tripSettings.value.startDate = d.tripStartDate;
                        if(d.tripDuration) tripSettings.value.duration = d.tripDuration;
                        if(d.manualRate) tripSettings.value.manualRate = d.manualRate; 
                        generateDates();
                    }
                });
                onSnapshot(collection(db, 'trips', TRIP_ID, 'itinerary_items'), (snap) => {
                    const temp = {};
                    snap.forEach(d => {
                        const data = d.data();
                        const day = data.dayIndex || 0;
                        if(!temp[day]) temp[day] = [];
                        temp[day].push({ ...data, id: d.id });
                    });
                    Object.keys(temp).forEach(k => {
                        temp[k].sort((a,b) => {
                            const timeA = a.startTime || '99:99'; 
                            const timeB = b.startTime || '99:99';
                            return timeA.localeCompare(timeB);
                        });
                    });
                    itineraryData.value = temp;
                });
                onSnapshot(collection(db, 'trips', TRIP_ID, 'shopping_items'), (snap) => shoppingList.value = snap.docs.map(d => ({...d.data(), id:d.id})));
                const qExp = query(collection(db, 'trips', TRIP_ID, 'expense_items'), orderBy("date", "desc"));
                onSnapshot(qExp, (snap) => expenses.value = snap.docs.map(d => ({...d.data(), id:d.id})));
            };

            const processUploads = async (filesArray) => {
                const results = [];
                for(const item of filesArray) {
                    if(item.content && item.content.startsWith('data:')) {
                        const res = await fetch(item.content); 
                        const blob = await res.blob();
                        const fileRef = storageRef(storage, `uploads/file_${Date.now()}_${Math.random().toString(36).substr(2)}`);
                        await uploadBytes(fileRef, blob);
                        const url = await getDownloadURL(fileRef);
                        // ä¿®æ­£ 1: é€™è£¡ç¢ºä¿ item.name è¢«å¯«å…¥
                        results.push({ name: item.name, url: url });
                    } else if (item.url) {
                        results.push(item);
                    } else if (typeof item === 'string') {
                        results.push({ name: 'é™„ä»¶', url: item });
                    }
                }
                return results;
            };

            const processImageUploads = async (imagesArray) => {
                 const urls = [];
                 for(const item of imagesArray) {
                    if(item.startsWith('data:')) {
                         const res = await fetch(item); const blob = await res.blob();
                         const fileRef = storageRef(storage, `uploads/img_${Date.now()}_${Math.random().toString(36).substr(2)}`);
                         await uploadBytes(fileRef, blob);
                         urls.push(await getDownloadURL(fileRef));
                    } else urls.push(item);
                 }
                 return urls;
            };

            const saveTripSettings = async () => {
                isLoading.value = true;
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), {
                    tripStartDate: tripSettings.value.startDate, 
                    tripDuration: tripSettings.value.duration,
                    manualRate: tripSettings.value.manualRate
                }, { merge: true });
                generateDates(); isLoading.value = false; showSettingsModal.value = false;
            };
            
            const changeDuration = (delta) => {
                const n = tripSettings.value.duration + delta;
                if(n > 0) tripSettings.value.duration = n;
            };
            const deleteLastDate = () => {
                if(confirm('ç¢ºå®šåˆªé™¤æœ€å¾Œä¸€å¤©çš„æ—¥æœŸï¼Ÿè©²æ—¥æœŸçš„è¡Œç¨‹è³‡æ–™å°‡ä¸æœƒå†é¡¯ç¤ºã€‚')) {
                    changeDuration(-1);
                }
            };

            const saveBankOffers = async () => {
                isLoading.value = true;
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), {
                    bankOffersNote: bankOffersContent.value
                }, { merge: true });
                isLoading.value = false; 
                isEditingBankOffers.value = false;
            };

            const handleAddClick = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    newItinerary.value = { 
                        category: 'sightseeing', 
                        transportType: '', 
                        transportH: '', transportM: '',
                        images: [], 
                        files: [], 
                        paymentMethods: [],
                        dayIndex: selectedDateIndex.value 
                    };
                    showItineraryModal.value = true;
                } else if(currentTab.value === 'shopping') {
                    isEditMode.value = false;
                    newShoppingItem.value = { category: shoppingSubTab.value, images: [], paymentMethods: [] };
                    showShoppingModal.value = true;
                } else if(currentTab.value === 'expenses') {
                    isEditMode.value = false;
                    newExpense.value = { 
                        payment: 'cash', 
                        category: 'food',
                        date: new Date().toISOString().split('T')[0]
                    };
                    showExpenseModal.value = true;
                }
            };

            const togglePayment = (pm, target) => {
                if(!target.paymentMethods) target.paymentMethods = [];
                const idx = target.paymentMethods.indexOf(pm);
                if(idx > -1) target.paymentMethods.splice(idx, 1);
                else target.paymentMethods.push(pm);
            };

            const toggleShoppingCheck = async (item) => {
                item.isPurchased = !item.isPurchased;
                await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', item.id), { isPurchased: item.isPurchased });
            };

            const saveItineraryItem = async () => {
                isLoading.value = true;
                try {
                    const imgUrls = await processImageUploads(newItinerary.value.images || []);
                    const fileObjects = await processUploads(newItinerary.value.files || []);
                    const finalDayIndex = parseInt(newItinerary.value.dayIndex);
                    
                    // ä¿®æ­£ 2: äº¤é€šæ™‚é–“æ™ºæ…§é¡¯ç¤º
                    let tTime = '';
                    const h = parseInt(newItinerary.value.transportH || 0);
                    const m = parseInt(newItinerary.value.transportM || 0);
                    
                    if(h > 0 && m > 0) tTime = `${h}å°æ™‚${m}åˆ†`;
                    else if(h > 0) tTime = `${h}å°æ™‚`;
                    else if(m > 0) tTime = `${m}åˆ†`;

                    const data = { 
                        ...newItinerary.value, 
                        images: imgUrls, 
                        files: fileObjects, 
                        dayIndex: finalDayIndex,
                        transportTime: tTime
                    };
                    delete data.transportH; 
                    delete data.transportM;
                    delete data.order; delete data.id;

                    if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', newItinerary.value.id), data);
                    else await addDoc(collection(db, 'trips', TRIP_ID, 'itinerary_items'), data);
                } catch (e) {
                    console.error("Save failed", e);
                    alert("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                isLoading.value = false; closeAllModals();
            };
            
            const switchToEditItinerary = () => {
                showItineraryDetailModal.value = false;
                isEditMode.value = true;
                const item = JSON.parse(JSON.stringify(previewItem.value));
                
                item.transportH = '';
                item.transportM = '';
                if(item.transportTime) {
                    const matchHM = item.transportTime.match(/(\d+)å°æ™‚(\d+)åˆ†/);
                    const matchH = item.transportTime.match(/(\d+)å°æ™‚/);
                    const matchM = item.transportTime.match(/(\d+)åˆ†/);
                    
                    if(matchHM) { item.transportH = matchHM[1]; item.transportM = matchHM[2]; }
                    else if(matchH) { item.transportH = matchH[1]; }
                    else if(matchM) { item.transportM = matchM[1]; }
                }
                
                newItinerary.value = item;
                showItineraryModal.value = true;
            };

            const removeItineraryItem = async (id) => {
                if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) { await deleteDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', id)); closeAllModals(); }
            };

            const saveShoppingItem = async () => {
                isLoading.value = true;
                if(!isEditMode.value) newShoppingItem.value.category = shoppingSubTab.value;
                const urls = await processImageUploads(newShoppingItem.value.images);
                const data = { ...newShoppingItem.value, images: urls };
                delete data.id;
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', newShoppingItem.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'shopping_items'), data);
                isLoading.value = false; closeAllModals();
            };
            const removeShoppingItem = async (id) => {
                if(confirm("åˆªé™¤æ­¤å•†å“ï¼Ÿ")) { await deleteDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', id)); closeAllModals(); }
            };

            const editExpense = (exp) => {
                newExpense.value = { ...exp };
                isEditMode.value = true;
                showExpenseModal.value = true;
            };

            const saveExpense = async () => { 
                if(!newExpense.value.name || !newExpense.value.amount) return;
                isLoading.value = true;
                const dateVal = newExpense.value.date || new Date().toISOString().split('T')[0];
                const expenseData = { ...newExpense.value, date: dateVal };
                
                if(isEditMode.value) {
                    const id = newExpense.value.id;
                    delete expenseData.id; 
                    await updateDoc(doc(db, 'trips', TRIP_ID, 'expense_items', id), expenseData);
                } else {
                    await addDoc(collection(db, 'trips', TRIP_ID, 'expense_items'), expenseData);
                }
                isLoading.value = false; closeAllModals();
            };
            const removeExpense = async (id) => { if(confirm("åˆªé™¤è¨˜å¸³ï¼Ÿ")) await deleteDoc(doc(db, 'trips', TRIP_ID, 'expense_items', id)); };

            const handleImageUpload = async (e, target) => {
                loadingText.value = 'å£“ç¸®ä¸­...'; isLoading.value = true;
                if(!target.images) target.images = [];
                for(const file of e.target.files) {
                    const blob = await compressImage(file);
                    const reader = new FileReader();
                    reader.onload = (evt) => target.images.push(evt.target.result);
                    reader.readAsDataURL(blob);
                }
                isLoading.value = false;
            };

            const handleFileUpload = (e, target) => {
                if(!target.files) target.files = [];
                for(const file of e.target.files) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        target.files.push({
                            name: file.name,
                            content: evt.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const removeImage = (idx, target) => target.images.splice(idx, 1);
            const removeFile = (idx, target) => target.files.splice(idx, 1);
            
            const openFile = (fileObj) => { 
                const url = fileObj.url || fileObj; 
                if(url && !url.startsWith('data:')) window.open(url, '_blank'); 
            };
            const openLightbox = (url) => { if(url) lightboxImage.value = url; };

            const openDetailPreview = (item) => {
                const normalizedItem = { ...item };
                if (normalizedItem.files) {
                    normalizedItem.files = normalizedItem.files.map(f => {
                        return (typeof f === 'string') ? { name: 'é™„ä»¶', url: f } : f;
                    });
                }
                previewItem.value = normalizedItem;
                currentGalleryIndex.value = 0;
                showItineraryDetailModal.value = true;
            };
            const switchToEditItinerary = () => {
                showItineraryDetailModal.value = false;
                isEditMode.value = true;
                newItinerary.value = JSON.parse(JSON.stringify(previewItem.value));
                showItineraryModal.value = true;
            };

            const openShoppingDetail = (item) => { 
                selectedShoppingItem.value = item; 
                currentGalleryIndex.value = 0; 
                showShoppingDetailModal.value = true; 
            };
            const switchToEditShopping = () => { 
                showShoppingDetailModal.value = false; 
                isEditMode.value = true; 
                newShoppingItem.value = JSON.parse(JSON.stringify(selectedShoppingItem.value)); 
                showShoppingModal.value = true; 
            };
            const galleryNav = (d, target) => {
                const len = target.images.length;
                let n = currentGalleryIndex.value + d;
                if(n < 0) n = len - 1; if(n >= len) n = 0;
                currentGalleryIndex.value = n;
            };
            const handleBannerUpload = async (e) => {
                const file = e.target.files[0]; if(!file) return; isLoading.value = true;
                const blob = await compressImage(file);
                const fileRef = storageRef(storage, `uploads/banner_${Date.now()}`);
                await uploadBytes(fileRef, blob);
                const url = await getDownloadURL(fileRef);
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), { headerImage: url }, { merge: true });
                isLoading.value = false;
            };
            
            // ä¿®æ­£ 6: Banner åˆªé™¤
            const deleteBanner = async () => {
                if(confirm('ç¢ºå®šåˆªé™¤å°é¢ç…§ç‰‡ï¼Ÿ')) {
                    isLoading.value = true;
                    await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), { headerImage: null }, { merge: true });
                    bannerUrl.value = '';
                    isLoading.value = false;
                }
            };

            const closeAllModals = () => {
                showSettingsModal.value = false; showItineraryModal.value = false;
                showItineraryDetailModal.value = false; showShoppingModal.value = false; 
                showShoppingDetailModal.value = false; showExpenseModal.value = false;
                showBankOffersModal.value = false; isEditingBankOffers.value = false;
                isLoading.value = false;
            };

            return {
                isLoading, loadingText, toastMessage, bannerUrl, bannerLoaded, lightboxImage,
                currentTab, dates, selectedDateIndex, currentItinerary,
                shoppingSubTab, filteredShoppingList, expenses, totalExpensesJPY, totalExpensesTWD,
                currencyInput, currencyResult, calculateCurrency, formatNumber, getDateString, getDateSimple, getHotelDurationLabel,
                getCategoryColor, getCategoryIcon, getCategoryName, getTransportIcon, getTransportName, getExpenseCatInfo, getPaymentLabel, getPaymentName,
                showSettingsModal, showItineraryModal, showItineraryDetailModal, showShoppingModal, showShoppingDetailModal, showExpenseModal,
                showBankOffersModal, bankOffersContent, isEditingBankOffers, saveBankOffers,
                tripSettings, saveTripSettings, changeDuration, deleteLastDate,
                newItinerary, isEditMode, handleAddClick, handleImageUpload, handleFileUpload, removeImage, removeFile, saveItineraryItem, removeItineraryItem, openDetailPreview, switchToEditItinerary, openFile,
                previewItem, allAccommodations,
                newShoppingItem, selectedShoppingItem, currentGalleryIndex, galleryNav, openShoppingDetail, switchToEditShopping, saveShoppingItem, removeShoppingItem, toggleShoppingCheck,
                newExpense, saveExpense, editExpense, removeExpense,
                closeAllModals, handleBannerUpload, openLightbox,
                linkify, togglePayment,
                currentRate, rateSource, deleteBanner
            };
        }
    }).mount('#app');
</script>
</body>
</html>