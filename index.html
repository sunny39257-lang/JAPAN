<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Family Trip to Hokkaido 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F0FFFF',
                        'ice-blue': '#B3E5FC',
                        'light-snow-blue': '#E5F3F7',
                        'deep-sea-blue': '#01579B',
                        'accent-yellow': '#FFD54F',
                        'soft-gray': '#F8FAFC'
                    },
                    padding: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            background-color: #E5F3F7;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
            overscroll-behavior-y: none;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 100px;
        }

        /* ****** Header ****** */
        .header-bg {
            background-color: #ffffff;
            position: relative;
            height: 220px;
            overflow: hidden;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: 0 10px 30px rgba(1, 87, 155, 0.15);
            z-index: 10;
        }
        
        .header-image-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .snow-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1.5" fill="%23fff" opacity="0.8"/><circle cx="20" cy="80" r="1" fill="%23fff" opacity="0.6"/><circle cx="70" cy="30" r="2" fill="%23fff" opacity="0.9"/></svg>');
            background-size: 150px 150px;
            opacity: 0.8;
            animation: snowfall 8s linear infinite;
            z-index: 5;
            pointer-events: none;
        }

        @keyframes snowfall {
            from { background-position: 0 0; }
            to { background-position: 50px 100px; }
        }

        /* ****** Bottom Navigation ****** */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(229, 231, 235, 0.5);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            z-index: 50;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #94A3B8;
            font-size: 0.75rem;
            gap: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 60px;
        }

        .nav-item i {
            font-size: 1.25rem;
            margin-bottom: 2px;
            transition: transform 0.2s;
        }

        .nav-item.active {
            color: #01579B;
            font-weight: bold;
        }
        
        .nav-item.active i {
            transform: translateY(-2px);
        }

        .fab-center {
            width: 56px;
            height: 56px;
            background: #FFD54F;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #01579B;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(255, 213, 79, 0.6);
            margin-top: -28px;
            border: 4px solid #fff;
            transition: transform 0.2s;
        }
        
        .fab-center:active {
            transform: scale(0.95);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .app-main {
            padding-top: 20px !important;
            position: relative;
            z-index: 5;
        }

        .date-selector-sticky {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            z-index: 20;
            top: 0;
            padding-top: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        .timeline-line {
            position: absolute;
            left: 23px;
            top: 24px;
            bottom: -24px;
            width: 2px;
            background-color: #E2E8F0;
            z-index: 0;
        }

        /* Modal Transitions */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        .modal-enter-active .modal-content, .modal-leave-active .modal-content {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-enter-from .modal-content, .modal-leave-to .modal-content {
            transform: scale(0.9) translateY(20px);
        }

        .expense-card-bg {
            background: linear-gradient(135deg, #01579B 0%, #0277BD 100%);
        }

        .form-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: #64748B;
            margin-bottom: 0.35rem;
            display: block;
            margin-left: 0.25rem;
        }

        /* Image Gallery Styles */
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .image-preview-item {
            aspect-ratio: 1;
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Loader Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #01579B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .lightbox-overlay {
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- Global Loading Indicator -->
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Header Image Area (Updated Banner) -->
    <div class="header-bg">
        <div class="header-image-container">
            <img src="50328286908_769a66c13a_c.jpg" alt="Hokkaido">
        </div>
        <div class="snow-layer"></div>
    </div>

    <main class="px-4 app-main">
        
        <!-- Tab: Ë°åÁ®ã -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in pb-20">
            
            <!-- Date Selector -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 px-1 sticky date-selector-sticky -mx-4 px-4 snap-x">
                <div v-for="(day, index) in dates" :key="index"
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[60px] h-[70px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-200 border border-transparent"
                     :class="selectedDateIndex === index ? 
                     'bg-deep-sea-blue text-white shadow-lg shadow-blue-900/20 translate-y-[-2px]' : 
                     'bg-slate-50 text-slate-400 hover:bg-slate-100'">
                    
                    <span class="text-xs font-medium mb-1">{{ day.weekday }}</span>
                    <span class="text-lg font-bold leading-none">{{ day.date.split('/')[1] }}</span>
                    <span class="text-[10px] opacity-60 mt-1">{{ day.date.split('/')[0] }}Êúà</span>
                </div>
            </div>

            <!-- Weather Card -->
            <div v-if="currentWeather" class="mb-6 bg-gradient-to-br from-white to-blue-50 border border-white rounded-3xl p-5 flex justify-between items-center shadow-sm relative overflow-hidden">
                <div class="flex items-center text-deep-sea-blue space-x-4 relative z-10">
                    <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm text-2xl text-blue-400">
                        <i :class="getWeatherIcon(currentWeather.condition)"></i>
                    </div>
                    <div>
                        <div class="flex items-baseline">
                            <span class="text-3xl font-bold tracking-tighter">{{ currentWeather.temp.split('/')[0] }}¬∞</span>
                            <span class="text-sm text-slate-400 ml-1">/ {{ currentWeather.temp.split('/')[1] }}¬∞</span>
                        </div>
                        <span class="text-xs text-slate-500 font-medium bg-white/60 px-2 py-0.5 rounded-lg backdrop-blur-sm">È´îÊÑü {{ currentWeather.feel }}¬∞C</span>
                    </div>
                </div>
                
                <div class="text-right z-10">
                    <div class="text-sm font-bold text-slate-700 mb-1">{{ getWeatherDescription(currentWeather.condition) }}</div>
                    <div v-if="currentDateInfo.hasCar" class="inline-flex items-center bg-accent-yellow/20 text-yellow-700 text-xs px-2.5 py-1 rounded-full font-bold border border-accent-yellow/30">
                        <i class="fa-solid fa-car-side mr-1.5"></i> ÁßüËªäÊó•
                    </div>
                </div>
            </div>

            <!-- Timeline Itinerary -->
            <div class="space-y-0 pl-2">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" 
                     class="relative group pb-6 last:pb-24 cursor-pointer"
                     @click="openItineraryDetail(item)">
                    
                    <div v-if="idx < currentItinerary.length - 1" class="timeline-line border-l-2 border-dashed border-slate-200"></div>

                    <div v-if="idx > 0" class="pl-12 mb-3 flex items-center text-xs text-slate-400">
                        <div class="flex items-center bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">
                            <i :class="getTransportIcon(item.transportType)" class="mr-1.5 text-slate-400"></i>
                            <span>Á¥Ñ {{ item.travelTime || '15 ÂàÜÈêò' }}</span>
                        </div>
                    </div>

                    <div class="flex items-start relative z-10">
                        <div class="flex flex-col items-center mr-4 w-12 flex-shrink-0">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm ring-4 ring-white" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-500 mt-2 bg-white px-1 rounded">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 bg-white rounded-2xl shadow-[0_2px_15px_rgba(0,0,0,0.04)] border border-slate-100 relative overflow-hidden active:scale-[0.99] transition-transform flex">
                            <!-- Left Content -->
                            <div class="p-4 flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-base font-bold text-slate-800 leading-snug">{{ item.name }}</h3>
                                </div>

                                <div v-if="item.category === 'flight'" class="flex items-center gap-3 mb-2 text-xs text-slate-500 bg-sky-50 p-2 rounded-lg">
                                    <span class="font-bold text-sky-700">{{ item.flightNo }}</span>
                                    <span v-if="item.depAirport || item.arrAirport">{{ item.depAirport }} <i class="fa-solid fa-arrow-right text-[10px] mx-1"></i> {{ item.arrAirport }}</span>
                                </div>

                                <div v-if="item.note" class="bg-slate-50 rounded-lg p-2.5 border border-slate-100/50">
                                    <p class="text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Note</p>
                                    <p class="text-sm text-slate-600 leading-relaxed line-clamp-2">{{ item.note }}</p>
                                </div>
                            </div>

                            <!-- Right Thumbnail (if images exist) -->
                            <div v-if="item.images && item.images.length > 0" class="w-24 bg-slate-100 flex-shrink-0 relative">
                                <img :src="item.images[0]" class="w-full h-full object-cover">
                                <div v-if="item.images.length > 1" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded backdrop-blur-sm">
                                    +{{ item.images.length - 1 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Ë≥ºÁâ© -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-24">
            
            <!-- Sub Tabs -->
            <div class="flex p-1 bg-slate-100 rounded-2xl mb-4">
                <button @click="shoppingSubTab = 'souvenir'" 
                        class="flex-1 py-2.5 rounded-xl text-sm font-bold flex items-center justify-center transition-all"
                        :class="shoppingSubTab === 'souvenir' ? 'bg-white text-pink-500 shadow-sm' : 'text-slate-400'">
                    <i class="fa-solid fa-gift mr-2"></i> ‰º¥ÊâãÁ¶Æ
                </button>
                <button @click="shoppingSubTab = 'cosmetic'" 
                        class="flex-1 py-2.5 rounded-xl text-sm font-bold flex items-center justify-center transition-all"
                        :class="shoppingSubTab === 'cosmetic' ? 'bg-white text-teal-500 shadow-sm' : 'text-slate-400'">
                    <i class="fa-solid fa-capsules mr-2"></i> Ëó•Â¶ù
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div v-for="(item, idx) in filteredShoppingList" :key="item.id" 
                     @click="openShoppingDetail(item)" 
                     class="bg-white rounded-2xl p-2 shadow-sm border border-slate-100 group relative cursor-pointer active:scale-95 transition-transform">
                    <div class="aspect-square bg-slate-50 rounded-xl overflow-hidden mb-2 relative">
                         <img v-if="item.images && item.images.length > 0" :src="item.images[0]" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-slate-300">
                             <i class="fa-solid fa-image text-2xl"></i>
                         </div>
                         <div v-if="item.images && item.images.length > 1" class="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-1.5 py-0.5 rounded-md backdrop-blur-sm">
                            <i class="fa-solid fa-layer-group mr-1"></i>{{ item.images.length }}
                         </div>
                    </div>
                    <p class="text-sm font-bold text-slate-700 px-1 truncate">{{ item.name }}</p>
                    <p class="text-xs text-slate-400 px-1 truncate mt-0.5" v-if="item.shopName">@{{ item.shopName }}</p>
                </div>
                
                <button @click="handleAddClick" class="aspect-square rounded-2xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 hover:border-slate-300 transition-colors">
                    <i class="fa-solid fa-plus text-2xl mb-2"></i>
                    <span class="text-xs font-bold">Êñ∞Â¢ûÁâ©ÂìÅ</span>
                </button>
            </div>
        </div>

        <!-- Tab: Ëä±Ë≤ª -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-24">
            <div class="expense-card-bg text-white rounded-3xl p-6 mb-6 relative overflow-hidden shadow-xl shadow-blue-900/20">
                <div class="absolute -right-6 -top-6 bg-white/20 w-32 h-32 rounded-full blur-2xl"></div>
                <div class="absolute -left-6 -bottom-6 bg-black/10 w-32 h-32 rounded-full blur-2xl"></div>
                
                <p class="text-xs text-blue-100 mb-1">Á∏ΩÊîØÂá∫È†ê‰º∞</p>
                <h2 class="text-4xl font-bold mb-1 tracking-tight">¬• {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm text-blue-100 opacity-80">‚âà NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between p-4 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm mr-3" :class="getCategoryColor(exp.category)">
                            <i :class="getCategoryIcon(exp.category)"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                            <p class="text-[10px] text-slate-400">{{ exp.date }} ¬∑ {{ exp.payment === 'card' ? '‰ø°Áî®Âç°' : 'ÁèæÈáë' }}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-slate-700 text-sm mr-3">¬•{{ formatNumber(exp.amount) }}</span>
                        <button @click="removeExpense(exp.id)" class="text-slate-300 hover:text-red-400 px-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Ë≥áË®ä (‰ΩèÂÆø/Hotels) -->
        <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in pb-24">
            <div class="bg-gradient-to-r from-deep-sea-blue to-cyan-800 rounded-3xl p-6 text-white shadow-lg shadow-blue-900/20 relative overflow-hidden">
                <h3 class="font-bold text-sm mb-4 flex items-center opacity-80"><i class="fa-solid fa-coins mr-2"></i> Âç≥ÊôÇÂåØÁéáË©¶ÁÆó</h3>
                <div class="flex items-center gap-3 relative z-10">
                    <div class="flex-1 bg-white/10 rounded-2xl p-3 backdrop-blur-sm border border-white/10">
                        <label class="text-[10px] text-cyan-200 block mb-1">JPY Êó•Âπ£</label>
                        <input type="number" inputmode="decimal" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-transparent border-none text-white text-xl font-bold p-0 focus:ring-0 placeholder-white/30" placeholder="0">
                    </div>
                    <i class="fa-solid fa-arrow-right text-white/50 text-sm"></i>
                    <div class="flex-1 bg-white rounded-2xl p-3 text-deep-sea-blue shadow-lg">
                        <label class="text-[10px] text-slate-400 block mb-1">TWD Âè∞Âπ£</label>
                        <div class="text-xl font-bold">$ {{ currencyResult }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Hotels List (Cards) -->
            <div class="space-y-4">
                <h3 class="font-bold text-slate-800 text-lg px-2">‰ΩèÂÆøÂÆâÊéí</h3>
                <div v-for="(hotel, idx) in hotels" :key="idx" 
                     @click="openHotelDetail(hotel)"
                     class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 cursor-pointer active:scale-95 transition-transform">
                    <div class="flex gap-4">
                        <!-- Hotel Image Thumbnail -->
                        <div class="w-20 h-20 bg-slate-100 rounded-xl overflow-hidden flex-shrink-0">
                             <img v-if="hotel.images && hotel.images.length > 0" :src="hotel.images[0]" class="w-full h-full object-cover">
                             <div v-else class="w-full h-full flex items-center justify-center text-slate-300">
                                 <i class="fa-solid fa-hotel text-xl"></i>
                             </div>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800 text-base leading-tight mb-1">{{ hotel.name }}</h4>
                            <span class="inline-block bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-full mb-2">{{ hotel.date }}</span>
                            <div class="flex gap-2">
                                <button @click.stop="openMap(hotel.name)" class="flex-1 bg-slate-50 text-slate-500 text-xs py-1.5 rounded-lg hover:bg-slate-100"><i class="fa-solid fa-location-arrow mr-1"></i>Â∞éËà™</button>
                                <a @click.stop :href="'tel:' + hotel.phone" class="flex-1 bg-slate-50 text-slate-500 text-xs py-1.5 rounded-lg text-center hover:bg-slate-100"><i class="fa-solid fa-phone mr-1"></i>ÈõªË©±</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <button class="nav-item" :class="{ active: currentTab === 'itinerary' }" @click="currentTab = 'itinerary'">
            <i class="fa-solid fa-map-location-dot"></i>
            <span>Ë°åÁ®ã</span>
        </button>
        
        <button class="nav-item" :class="{ active: currentTab === 'shopping' }" @click="currentTab = 'shopping'">
            <i class="fa-solid fa-bag-shopping"></i>
            <span>Ë≥ºÁâ©</span>
        </button>

        <button class="fab-center" @click="handleAddClick">
            <i class="fa-solid fa-plus"></i>
        </button>
        
        <button class="nav-item" :class="{ active: currentTab === 'expenses' }" @click="currentTab = 'expenses'">
            <i class="fa-solid fa-wallet"></i>
            <span>Ëä±Ë≤ª</span>
        </button>

        <button class="nav-item" :class="{ active: currentTab === 'info' }" @click="currentTab = 'info'">
            <i class="fa-solid fa-circle-info"></i>
            <span>Ë≥áË®ä</span>
        </button>
    </nav>

    <!-- Modals -->
    <transition name="modal">
        <div v-if="anyModalOpen" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
            <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" @click="closeAllModals"></div>
            
            <!-- 1. Itinerary Add/Edit Modal (Updated with Images) -->
            <div v-if="showItineraryModal" class="modal-content bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto shadow-2xl relative z-10 p-6">
                <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
                <h3 class="font-bold text-lg mb-6 text-center text-slate-800">{{ isEditMode ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                <div class="space-y-4">
                    <!-- Category -->
                    <div>
                        <label class="form-label">È°ûÂûã</label>
                        <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none border border-slate-100">
                            <option value="sightseeing">üì∏ ÊôØÈªû</option>
                            <option value="food">üç¥ È£≤È£ü</option>
                            <option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option>
                            <option value="accommodation">üè® ‰ΩèÂÆø</option>
                            <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                            <option value="transport">üöå ‰∫§ÈÄö</option>
                        </select>
                    </div>

                    <!-- Dynamic Name -->
                    <div>
                         <label class="form-label">{{ newItinerary.category === 'flight' ? 'Ê©üÂ†¥ÂêçÁ®± (ÂèØÈÅ∏)' : 'ÂêçÁ®±' }}</label>
                        <input v-model="newItinerary.name" :placeholder="newItinerary.category === 'flight' ? '‰æãÂ¶Ç: Êñ∞ÂçÉÊ≠≤Ê©üÂ†¥' : 'Ë¶ÅÂéªÂì™Ë£°?'" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue transition-all">
                    </div>

                    <!-- Flight Fields (Updated) -->
                    <div v-if="newItinerary.category === 'flight'" class="space-y-4 bg-sky-50 p-4 rounded-2xl border border-sky-100">
                         <div>
                            <label class="form-label text-sky-700">Ëà™Áè≠Ëôü</label>
                            <input v-model="newItinerary.flightNo" placeholder="‰æãÂ¶Ç: CI130" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200">
                         </div>
                         
                         <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-2">
                                <label class="form-label text-sky-700">Âá∫ÁôºÊ©üÂ†¥</label>
                                <input v-model="newItinerary.depAirport" placeholder="TPE" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200">
                            </div>
                            <div>
                                <label class="form-label text-sky-700">Ëà™Âªà</label>
                                <input v-model="newItinerary.depTerminal" placeholder="1" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200">
                            </div>
                         </div>

                         <div>
                            <label class="form-label text-sky-700">Âá∫ÁôºÊôÇÈñì</label>
                            <!-- Bind to startTime for sorting compatibility -->
                            <input v-model="newItinerary.startTime" type="time" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200"> 
                         </div>

                         <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-2">
                                <label class="form-label text-sky-700">ÊäµÈÅîÊ©üÂ†¥</label>
                                <input v-model="newItinerary.arrAirport" placeholder="CTS" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200">
                            </div>
                            <div>
                                <label class="form-label text-sky-700">Ëà™Âªà</label>
                                <input v-model="newItinerary.arrTerminal" placeholder="I" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200">
                            </div>
                         </div>

                         <div>
                            <label class="form-label text-sky-700">ÊäµÈÅîÊôÇÈñì</label>
                            <input v-model="newItinerary.arrTime" type="time" class="w-full bg-white rounded-xl p-3 text-sm outline-none border border-sky-200">
                         </div>
                    </div>

                    <!-- Standard Address -->
                    <div v-else>
                         <label class="form-label">Âú∞ÂùÄ/Âú∞Èªû</label>
                         <input v-model="newItinerary.address" placeholder="Google Map ÊêúÂ∞ãÁî®" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue transition-all">
                    </div>

                    <!-- Time & Transport (Hidden for Flight) -->
                    <div class="grid grid-cols-2 gap-3" v-if="newItinerary.category !== 'flight'">
                        <div>
                            <label class="form-label">ÈñãÂßãÊôÇÈñì</label>
                            <input v-model="newItinerary.startTime" type="time" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        </div>
                        <div>
                             <label class="form-label">‰∫§ÈÄöÊñπÂºè</label>
                             <select v-model="newItinerary.transportType" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                                <option value="walk">üö∂ Ê≠•Ë°å</option>
                                <option value="car">üöó Ëá™Èßï</option>
                                <option value="bus">üöå Â∑¥Â£´</option>
                                <option value="public">üöá Âú∞Èêµ/JR</option>
                                <option value="flight">‚úàÔ∏è È£õÊ©ü</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea v-model="newItinerary.note" placeholder="Á¥∞ÁØÄ..." rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue transition-all"></textarea>
                    </div>

                    <!-- Itinerary Image Upload -->
                    <div>
                        <label class="form-label">ÁÖßÁâá (ÂèØÂ§öÈÅ∏)</label>
                        <div class="image-preview-grid mb-3" v-if="newItinerary.images && newItinerary.images.length > 0">
                            <div v-for="(img, idx) in newItinerary.images" :key="idx" class="image-preview-item">
                                <img :src="img">
                                <button @click="removeItineraryImage(idx)" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-sm"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                             <label class="image-preview-item flex flex-col items-center justify-center bg-slate-50 border-dashed border-2 border-slate-200 cursor-pointer hover:bg-slate-100 text-slate-400">
                                <input type="file" @change="handleItineraryImageUpload" class="hidden" multiple accept="image/*">
                                <i class="fa-solid fa-plus text-lg"></i>
                            </label>
                        </div>
                        <label v-else class="w-full h-24 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer hover:bg-slate-100 transition-colors overflow-hidden">
                            <input type="file" @change="handleItineraryImageUpload" class="hidden" multiple accept="image/*">
                            <div class="text-center text-slate-400">
                                <i class="fa-solid fa-camera text-xl mb-1 block"></i>
                                <span class="text-xs">‰∏äÂÇ≥ÁÖßÁâá</span>
                            </div>
                        </label>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="px-4 py-3 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-blue-900/30">
                            {{ isEditMode ? 'ÂÑ≤Â≠òËÆäÊõ¥' : 'Êñ∞Â¢ûË°åÁ®ã' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Itinerary Detail View (Updated with FULL Details) -->
            <div v-if="showItineraryDetailModal && selectedItineraryItem" class="modal-content bg-white rounded-3xl w-full max-w-sm shadow-2xl relative z-10 p-0 overflow-hidden">
                 <!-- Image Header -->
                 <div class="relative h-64 bg-slate-900 group cursor-pointer" @click="openImagePreview(selectedItineraryItem.images ? selectedItineraryItem.images[0] : null)">
                    <img v-if="selectedItineraryItem.images && selectedItineraryItem.images.length > 0" :src="selectedItineraryItem.images[0]" class="w-full h-full object-cover">
                    <!-- Fallback Icon Header if no image -->
                    <div v-else class="w-full h-full flex items-center justify-center bg-slate-100 text-slate-300 text-5xl">
                         <i :class="getCategoryIcon(selectedItineraryItem.category)"></i>
                    </div>
                    <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-black/30 text-white backdrop-blur-md z-20"><i class="fa-solid fa-xmark"></i></button>
                    <div v-if="selectedItineraryItem.images && selectedItineraryItem.images.length > 0" class="absolute bottom-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-expand mr-1"></i>ÊîæÂ§ß
                    </div>
                 </div>

                 <!-- Thumbnails -->
                 <div class="flex gap-2 p-4 pb-0 overflow-x-auto" v-if="selectedItineraryItem.images && selectedItineraryItem.images.length > 1">
                     <div v-for="(img, idx) in selectedItineraryItem.images" :key="idx" 
                          class="w-16 h-16 rounded-lg overflow-hidden border-2 cursor-pointer flex-shrink-0"
                          :class="idx === 0 ? 'border-deep-sea-blue' : 'border-transparent'"
                          @click="openImagePreview(img)">
                         <img :src="img" class="w-full h-full object-cover">
                     </div>
                 </div>

                 <div class="p-6 bg-white rounded-t-3xl relative -mt-4">
                     <div class="flex justify-between items-start mb-4">
                         <div>
                             <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">{{ selectedItineraryItem.startTime }}</span>
                             <h3 class="text-2xl font-bold text-slate-800">{{ selectedItineraryItem.name }}</h3>
                         </div>
                         <!-- Category Icon (Small if header is image) -->
                         <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md" :class="getCategoryColor(selectedItineraryItem.category)">
                             <i :class="getCategoryIcon(selectedItineraryItem.category)"></i>
                         </div>
                     </div>
                     
                     <!-- General Info (Transport & Address) -->
                     <div class="grid grid-cols-2 gap-3 mb-6" v-if="selectedItineraryItem.category !== 'flight'">
                        <div class="bg-slate-50 p-3 rounded-xl">
                            <p class="text-[10px] text-slate-400">‰∫§ÈÄöÊñπÂºè</p>
                            <div class="font-bold text-slate-700 flex items-center mt-0.5">
                                <i :class="getTransportIcon(selectedItineraryItem.transportType)" class="mr-1.5 text-deep-sea-blue"></i>
                                <span class="text-sm">
                                    {{ 
                                        {
                                            walk: 'Ê≠•Ë°å', car: 'Ëá™Èßï', bus: 'Â∑¥Â£´', 
                                            public: 'Âú∞Èêµ/JR', flight: 'È£õÊ©ü'
                                        }[selectedItineraryItem.transportType] || 'ÂÖ∂‰ªñ'
                                    }}
                                </span>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl col-span-2" v-if="selectedItineraryItem.address">
                            <p class="text-[10px] text-slate-400">Âú∞Èªû / Âú∞ÂùÄ</p>
                            <p class="font-bold text-slate-700 text-sm mt-0.5">{{ selectedItineraryItem.address }}</p>
                        </div>
                     </div>

                     <!-- Flight Info Display (Updated) -->
                     <div v-if="selectedItineraryItem.category === 'flight'" class="space-y-4 mb-6">
                         <!-- Flight Number Tag -->
                         <div class="inline-flex items-center bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-bold">
                             <i class="fa-solid fa-plane-up mr-2"></i> {{ selectedItineraryItem.flightNo }}
                         </div>

                         <!-- Route Visual -->
                         <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 relative overflow-hidden">
                             <div class="flex justify-between items-center relative z-10">
                                 <!-- Departure -->
                                 <div class="text-center">
                                     <div class="text-3xl font-black text-slate-800 leading-none">{{ selectedItineraryItem.depAirport || 'DEP' }}</div>
                                     <div class="text-xs text-slate-500 font-bold mt-1 bg-white px-2 py-0.5 rounded-md border border-slate-200 inline-block">
                                         T{{ selectedItineraryItem.depTerminal || '-' }}
                                     </div>
                                     <div class="text-sm font-bold text-sky-600 mt-2">{{ selectedItineraryItem.startTime }}</div>
                                 </div>

                                 <!-- Icon -->
                                 <div class="flex flex-col items-center px-4">
                                     <i class="fa-solid fa-plane text-slate-300 text-xl transform rotate-90 mb-1"></i>
                                     <div class="h-0.5 w-16 bg-slate-200"></div>
                                 </div>

                                 <!-- Arrival -->
                                 <div class="text-center">
                                     <div class="text-3xl font-black text-slate-800 leading-none">{{ selectedItineraryItem.arrAirport || 'ARR' }}</div>
                                     <div class="text-xs text-slate-500 font-bold mt-1 bg-white px-2 py-0.5 rounded-md border border-slate-200 inline-block">
                                         T{{ selectedItineraryItem.arrTerminal || '-' }}
                                     </div>
                                     <div class="text-sm font-bold text-slate-700 mt-2">{{ selectedItineraryItem.arrTime || '--:--' }}</div>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <div v-if="selectedItineraryItem.note" class="mb-6">
                         <p class="text-xs font-bold text-slate-400 mb-2">ÂÇôË®ª</p>
                         <p class="text-sm text-slate-600 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100">{{ selectedItineraryItem.note }}</p>
                     </div>

                     <div class="flex gap-3">
                         <button v-if="selectedItineraryItem.address" @click="openMap(selectedItineraryItem.address)" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm"><i class="fa-solid fa-location-arrow mr-2"></i> Â∞éËà™</button>
                         <button @click="switchToEditItinerary" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20"><i class="fa-solid fa-pen mr-2"></i> Á∑®ËºØ</button>
                     </div>
                 </div>
            </div>

            <!-- 3. Hotel Add/Edit Modal (New for Info Tab) -->
            <div v-if="showHotelModal" class="modal-content bg-white rounded-3xl w-full max-w-sm shadow-2xl relative z-10 p-6">
                <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
                <h3 class="font-bold text-lg mb-6 text-center text-slate-800">{{ isEditHotel ? 'Á∑®ËºØ‰ΩèÂÆø' : 'Êñ∞Â¢û‰ΩèÂÆø' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="form-label">È£ØÂ∫óÂêçÁ®±</label>
                        <input v-model="newHotel.name" placeholder="‰æãÂ¶Ç: Êú≠ÂπåÂ§ßÈÄöÊù±ÊÄ•STAY" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                    </div>
                    <div>
                        <label class="form-label">ÂÖ•‰ΩèÊó•ÊúüË™™Êòé</label>
                        <input v-model="newHotel.date" placeholder="‰æãÂ¶Ç: 2/1 - 2/3 (2Êôö)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    </div>
                    <div>
                        <label class="form-label">ËÅØÁµ°ÈõªË©±</label>
                        <input v-model="newHotel.phone" placeholder="+81..." class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    </div>
                    
                    <!-- Hotel Image Upload -->
                    <div>
                        <label class="form-label">È£ØÂ∫óÁÖßÁâá</label>
                        <div class="image-preview-grid mb-3" v-if="newHotel.images && newHotel.images.length > 0">
                            <div v-for="(img, idx) in newHotel.images" :key="idx" class="image-preview-item">
                                <img :src="img">
                                <button @click="removeHotelImage(idx)" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-sm"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                             <label class="image-preview-item flex flex-col items-center justify-center bg-slate-50 border-dashed border-2 border-slate-200 cursor-pointer hover:bg-slate-100 text-slate-400">
                                <input type="file" @change="handleHotelImageUpload" class="hidden" multiple accept="image/*">
                                <i class="fa-solid fa-plus text-lg"></i>
                            </label>
                        </div>
                        <label v-else class="w-full h-24 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer hover:bg-slate-100 transition-colors overflow-hidden">
                            <input type="file" @change="handleHotelImageUpload" class="hidden" multiple accept="image/*">
                            <div class="text-center text-slate-400">
                                <i class="fa-solid fa-camera text-xl mb-1 block"></i>
                                <span class="text-xs">‰∏äÂÇ≥ÁÖßÁâá</span>
                            </div>
                        </label>
                    </div>

                    <div class="flex gap-3 pt-2">
                         <button v-if="isEditHotel" @click="removeHotelItem(newHotel.id)" class="px-4 py-3 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button @click="saveHotelItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-blue-900/30">
                            {{ isEditHotel ? 'ÂÑ≤Â≠òËÆäÊõ¥' : 'Êñ∞Â¢û‰ΩèÂÆø' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- 4. Hotel Detail View (Info Tab) -->
            <div v-if="showHotelDetailModal && selectedHotelItem" class="modal-content bg-white rounded-3xl w-full max-w-sm shadow-2xl relative z-10 p-0 overflow-hidden">
                <div class="relative h-64 bg-slate-900 group cursor-pointer" @click="openImagePreview(selectedHotelItem.images ? selectedHotelItem.images[0] : null)">
                    <img v-if="selectedHotelItem.images && selectedHotelItem.images.length > 0" :src="selectedHotelItem.images[0]" class="w-full h-full object-cover">
                    <div v-else class="w-full h-full flex items-center justify-center text-slate-500 bg-slate-200">
                        <i class="fa-solid fa-hotel text-5xl"></i>
                    </div>
                    <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-black/30 text-white backdrop-blur-md z-20"><i class="fa-solid fa-xmark"></i></button>
                    <div v-if="selectedHotelItem.images && selectedHotelItem.images.length > 0" class="absolute bottom-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-expand mr-1"></i>ÊîæÂ§ß
                    </div>
                </div>
                
                 <!-- Thumbnails -->
                 <div class="flex gap-2 p-4 pb-0 overflow-x-auto" v-if="selectedHotelItem.images && selectedHotelItem.images.length > 1">
                     <div v-for="(img, idx) in selectedHotelItem.images" :key="idx" 
                          class="w-16 h-16 rounded-lg overflow-hidden border-2 cursor-pointer flex-shrink-0"
                          :class="idx === 0 ? 'border-deep-sea-blue' : 'border-transparent'"
                          @click="openImagePreview(img)">
                         <img :src="img" class="w-full h-full object-cover">
                     </div>
                 </div>

                <div class="p-6 bg-white">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">{{ selectedHotelItem.name }}</h3>
                    <div class="inline-block bg-indigo-50 text-indigo-600 text-xs font-bold px-2 py-1 rounded-md mb-4">{{ selectedHotelItem.date }}</div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-6">
                         <button @click="openMap(selectedHotelItem.name)" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-100"><i class="fa-solid fa-location-arrow mr-2"></i> Â∞éËà™</button>
                         <a :href="'tel:' + selectedHotelItem.phone" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-sm text-center hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-phone mr-2"></i> {{ selectedHotelItem.phone }}</a>
                    </div>
                    
                    <button @click="switchToEditHotel" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20"><i class="fa-solid fa-pen mr-2"></i> Á∑®ËºØ‰ΩèÂÆø</button>
                </div>
            </div>

            <!-- Expense Modal (Existing) -->
            <div v-if="showExpenseModal" class="modal-content bg-white rounded-3xl w-full max-w-sm shadow-2xl relative z-10 p-6">
                <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
                <h3 class="font-bold text-lg mb-6 text-center text-slate-800">Ë®ò‰∏ÄÁ≠Ü</h3>
                <div class="space-y-4">
                     <div>
                         <label class="form-label">Ê∂àË≤ªÈ†ÖÁõÆ</label>
                         <input v-model="newExpense.name" placeholder="‰æãÂ¶Ç: ÊπØÂíñÂì©" class="w-full bg-slate-50 rounded-xl p-4 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                     </div>
                     <div>
                        <label class="form-label">ÈáëÈ°ç</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">¬•</span>
                            <input v-model.number="newExpense.amount" type="number" inputmode="decimal" placeholder="0" class="w-full bg-slate-50 rounded-xl p-4 pl-8 text-xl font-bold outline-none focus:ring-2 focus:ring-deep-sea-blue text-deep-sea-blue">
                        </div>
                     </div>
                     <div>
                        <label class="form-label">‰ªòÊ¨æÊñπÂºè</label>
                        <div class="flex gap-2">
                            <button @click="newExpense.payment='cash'" class="flex-1 py-3 rounded-xl text-sm font-bold border-2 transition-all" :class="newExpense.payment==='cash' ? 'border-deep-sea-blue bg-deep-sea-blue text-white' : 'border-slate-100 text-slate-400'">ÁèæÈáë</button>
                            <button @click="newExpense.payment='card'" class="flex-1 py-3 rounded-xl text-sm font-bold border-2 transition-all" :class="newExpense.payment==='card' ? 'border-deep-sea-blue bg-deep-sea-blue text-white' : 'border-slate-100 text-slate-400'">‰ø°Áî®Âç°</button>
                        </div>
                     </div>
                     <button @click="addExpense" class="w-full py-3 rounded-xl bg-accent-yellow text-yellow-900 font-bold text-sm shadow-lg shadow-yellow-400/30 mt-2">ÂÑ≤Â≠ò</button>
                </div>
            </div>
            
            <!-- Shopping Add/Edit Modal (Existing) -->
            <div v-if="showShoppingModal" class="modal-content bg-white rounded-3xl w-full max-w-sm shadow-2xl relative z-10 p-6">
                <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
                <h3 class="font-bold text-lg mb-6 text-center text-slate-800">{{ isEditMode ? 'Á∑®ËºØÁâ©ÂìÅ' : 'Êñ∞Â¢ûÁâ©ÂìÅ' }}</h3>
                
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-500">
                            {{ shoppingSubTab === 'souvenir' ? 'üéÅ ‰º¥ÊâãÁ¶Æ' : 'üíÑ Ëó•Â¶ù' }}
                        </span>
                    </div>

                    <div>
                        <label class="form-label">ÂïÜÂìÅÂêçÁ®±</label>
                        <input v-model="newShoppingItem.name" type="text" placeholder="ÂøÖË≤∑!" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                    </div>

                    <div>
                        <label class="form-label">ÂïÜÂ∫óÂêçÁ®±</label>
                        <input v-model="newShoppingItem.shopName" type="text" placeholder="Âú®Âì™Ë≤∑?" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="form-label">È†ê‰º∞ÂñÆÂÉπ (¬•)</label>
                            <input v-model="newShoppingItem.price" type="number" inputmode="decimal" placeholder="0" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        </div>
                        <div>
                            <label class="form-label">Êï∏Èáè</label>
                            <input v-model="newShoppingItem.quantity" type="number" placeholder="1" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="form-label">ÁáüÊ•≠ÊôÇÈñì</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-2 border border-slate-100 justify-center gap-1">
                            <select v-model="newShoppingItem.openHour" class="bg-transparent font-bold outline-none text-center appearance-none w-8">
                                <option v-for="h in 24" :value="(h-1).toString().padStart(2,'0')">{{ (h-1).toString().padStart(2,'0') }}</option>
                            </select>
                            <span>:</span>
                            <select v-model="newShoppingItem.openMin" class="bg-transparent font-bold outline-none text-center appearance-none w-8">
                                <option value="00">00</option><option value="30">30</option>
                            </select>
                            <span class="text-slate-300 mx-2">~</span>
                            <select v-model="newShoppingItem.closeHour" class="bg-transparent font-bold outline-none text-center appearance-none w-8">
                                <option v-for="h in 24" :value="(h-1).toString().padStart(2,'0')">{{ (h-1).toString().padStart(2,'0') }}</option>
                            </select>
                            <span>:</span>
                            <select v-model="newShoppingItem.closeMin" class="bg-transparent font-bold outline-none text-center appearance-none w-8">
                                <option value="00">00</option><option value="30">30</option>
                            </select>
                        </div>
                    </div>

                    <!-- Multiple Image Upload Section -->
                    <div>
                        <label class="form-label">ÁÖßÁâá (ÂèØÂ§öÈÅ∏)</label>
                        
                        <!-- Image Grid -->
                        <div class="image-preview-grid mb-3" v-if="newShoppingItem.images && newShoppingItem.images.length > 0">
                            <div v-for="(img, idx) in newShoppingItem.images" :key="idx" class="image-preview-item">
                                <img :src="img">
                                <button @click="removeImage(idx)" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-sm">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                             <label class="image-preview-item flex flex-col items-center justify-center bg-slate-50 border-dashed border-2 border-slate-200 cursor-pointer hover:bg-slate-100 text-slate-400">
                                <input type="file" @change="handleImageUpload" class="hidden" multiple accept="image/*">
                                <i class="fa-solid fa-plus text-lg"></i>
                            </label>
                        </div>

                        <label v-else class="w-full h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer hover:bg-slate-100 transition-colors overflow-hidden">
                            <input type="file" @change="handleImageUpload" class="hidden" multiple accept="image/*">
                            <div class="text-center text-slate-400">
                                <i class="fa-solid fa-camera text-2xl mb-2 block"></i>
                                <span class="text-xs">‰∏äÂÇ≥ÁÖßÁâá</span>
                            </div>
                        </label>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button v-if="isEditMode" @click="removeShoppingItem(newShoppingItem.id)" class="px-4 py-3 rounded-xl bg-red-50 text-red-500"><i class="fa-solid fa-trash"></i></button>
                        <button @click="saveShoppingItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-blue-900/30">
                            {{ isEditMode ? 'ÂÑ≤Â≠òËÆäÊõ¥' : 'Âä†ÂÖ•Ê∏ÖÂñÆ' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shopping Detail View (Existing) -->
            <div v-if="showShoppingDetailModal && selectedShoppingItem" class="modal-content bg-white rounded-3xl w-full max-w-sm shadow-2xl relative z-10 p-0 overflow-hidden">
                <!-- Main Large Image -->
                <div class="relative h-64 bg-slate-900 group cursor-pointer" @click="openImagePreview(selectedShoppingItem.images ? selectedShoppingItem.images[0] : null)">
                    <img v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 0" :src="selectedShoppingItem.images[0]" class="w-full h-full object-cover">
                    <div v-else class="w-full h-full flex items-center justify-center text-slate-500">
                        <i class="fa-solid fa-image text-4xl"></i>
                    </div>
                    
                    <button @click.stop="closeAllModals" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-black/30 text-white backdrop-blur-md z-20"><i class="fa-solid fa-xmark"></i></button>
                    <div v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 0" class="absolute bottom-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-expand mr-1"></i>ÊîæÂ§ßÊ™¢Ë¶ñ
                    </div>
                </div>

                <div class="flex gap-2 p-4 pb-0 overflow-x-auto" v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 1">
                     <div v-for="(img, idx) in selectedShoppingItem.images" :key="idx" 
                          class="w-16 h-16 rounded-lg overflow-hidden border-2 cursor-pointer flex-shrink-0"
                          :class="idx === 0 ? 'border-deep-sea-blue' : 'border-transparent'"
                          @click="openImagePreview(img)">
                         <img :src="img" class="w-full h-full object-cover">
                     </div>
                </div>

                <div class="p-6 bg-white relative">
                    <div class="flex justify-between items-start mb-2">
                         <span class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-500 mb-2 inline-block">
                            {{ selectedShoppingItem.category === 'souvenir' ? 'üéÅ ‰º¥ÊâãÁ¶Æ' : 'üíÑ Ëó•Â¶ù' }}
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-1">{{ selectedShoppingItem.name }}</h3>
                    <p class="text-sm text-slate-500 font-bold mb-4" v-if="selectedShoppingItem.shopName">@{{ selectedShoppingItem.shopName }}</p>

                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="bg-slate-50 p-3 rounded-xl text-center">
                            <p class="text-[10px] text-slate-400">Êï∏Èáè</p>
                            <p class="font-bold text-slate-700">{{ selectedShoppingItem.quantity || 1 }}</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl text-center">
                            <p class="text-[10px] text-slate-400">ÂñÆÂÉπ</p>
                            <p class="font-bold text-slate-700">¬•{{ selectedShoppingItem.price || '-' }}</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl text-center">
                            <p class="text-[10px] text-slate-400">ÁáüÊ•≠ÊôÇÈñì</p>
                            <p class="font-bold text-slate-700 text-xs mt-1">
                                {{ selectedShoppingItem.openHour || '09' }}:{{ selectedShoppingItem.openMin || '00' }}~{{ selectedShoppingItem.closeHour || '20' }}:{{ selectedShoppingItem.closeMin || '00' }}
                            </p>
                        </div>
                    </div>

                    <button @click="switchToEditShopping" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20"><i class="fa-solid fa-pen mr-2"></i> Á∑®ËºØÁâ©ÂìÅ</button>
                </div>
            </div>

            <!-- 6. Full Screen Image Preview (Lightbox) -->
             <div v-if="showImagePreviewModal" class="fixed inset-0 z-[70] lightbox-overlay flex justify-center items-center" @click="showImagePreviewModal = false">
                <button class="absolute top-6 right-6 text-white text-3xl"><i class="fa-solid fa-xmark"></i></button>
                <img :src="previewImageUrl" class="max-w-full max-h-screen object-contain p-4 transition-transform duration-300 transform scale-100">
            </div>

        </div>
    </transition>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // Firebase Setup
            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = __app_id || 'default-app';
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            const userId = ref(null);
            const isLoading = ref(false);

            // Data
            const EXCHANGE_RATE = 0.215;
            const CATEGORY_MAP = {
                sightseeing: { color: 'bg-emerald-400', icon: 'fa-solid fa-camera' },
                food: { color: 'bg-orange-400', icon: 'fa-solid fa-utensils' },
                shopping: { color: 'bg-pink-400', icon: 'fa-solid fa-bag-shopping' },
                accommodation: { color: 'bg-indigo-400', icon: 'fa-solid fa-bed' },
                flight: { color: 'bg-sky-500', icon: 'fa-solid fa-plane-departure' },
                transport: { color: 'bg-slate-400', icon: 'fa-solid fa-van-shuttle' },
                ticket: { color: 'bg-teal-400', icon: 'fa-solid fa-ticket' },
                other: { color: 'bg-gray-400', icon: 'fa-solid fa-circle-info' },
                stay: { color: 'bg-indigo-400', icon: 'fa-solid fa-hotel' },
            };

            const currentTab = ref('itinerary');
            const shoppingSubTab = ref('souvenir');
            
            const dates = ref([
                { date: '2/1', weekday: '‰∫î', hasCar: false },
                { date: '2/2', weekday: 'ÂÖ≠', hasCar: true },
                { date: '2/3', weekday: 'Êó•', hasCar: true },
                { date: '2/4', weekday: '‰∏Ä', hasCar: true },
                { date: '2/5', weekday: '‰∫å', hasCar: true },
                { date: '2/6', weekday: '‰∏â', hasCar: true },
                { date: '2/7', weekday: 'Âõõ', hasCar: false },
            ]);

            // Reactive Data Containers
            const hotels = ref([]);
            const itineraryData = ref([[], [], [], [], [], [], []]);
            const shoppingList = ref([]);
            const expenses = ref([]);

            const weatherData = ref([
                { condition: 'snow', temp: '0/-5', feel: '-8' },
                { condition: 'snow', temp: '-1/-7', feel: '-10' },
                { condition: 'snow', temp: '-2/-10', feel: '-12' },
                { condition: 'snow', temp: '-3/-8', feel: '-11' },
                { condition: 'snow', temp: '1/-4', feel: '-6' },
                { condition: 'snow', temp: '2/-3', feel: '-5' },
                { condition: 'cloudy', temp: '3/-2', feel: '-3' },
            ]);

            const selectedDateIndex = ref(0);
            
            // Modal States
            const showShoppingModal = ref(false);
            const showShoppingDetailModal = ref(false); 
            const showExpenseModal = ref(false);
            const showItineraryModal = ref(false);
            const showItineraryDetailModal = ref(false);
            const showHotelModal = ref(false); 
            const showHotelDetailModal = ref(false); 
            const showImagePreviewModal = ref(false);
            const previewImageUrl = ref('');

            const isEditMode = ref(false);
            const isEditHotel = ref(false);
            
            // Selected Items
            const selectedShoppingItem = ref(null);
            const selectedItineraryItem = ref(null);
            const selectedHotelItem = ref(null);

            // Forms
            const newItinerary = ref({ images: [] });
            const newShoppingItem = ref({ images: [] });
            const newHotel = ref({ images: [] });
            const newExpense = ref({ name: '', amount: null, category: 'food', payment: 'cash' });
            
            const currencyInput = ref(10000);
            const currencyResult = ref(Math.round(10000 * EXCHANGE_RATE));

            // Computed
            const currentItinerary = computed(() => {
                return itineraryData.value[selectedDateIndex.value] || [];
            });

            const filteredShoppingList = computed(() => {
                return shoppingList.value.filter(item => item.category === shoppingSubTab.value);
            });
            
            const currentWeather = computed(() => weatherData.value[selectedDateIndex.value] || null);
            const currentDateInfo = computed(() => dates.value[selectedDateIndex.value]);

            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, exp) => sum + exp.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * EXCHANGE_RATE));
            
            const anyModalOpen = computed(() => showItineraryModal.value || showShoppingModal.value || showExpenseModal.value || showShoppingDetailModal.value || showItineraryDetailModal.value || showHotelModal.value || showHotelDetailModal.value || showImagePreviewModal.value);

            // --- Firebase Logic ---

            onMounted(async () => {
                if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch(e) {
                        console.error("Auth Token Error", e);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId.value = user.uid;
                        setupFirestoreListeners(user.uid);
                    }
                });
                
                calculateCurrency();
            });

            const setupFirestoreListeners = (uid) => {
                // 1. Itinerary Listener
                const itineraryRef = collection(db, 'artifacts', appId, 'users', uid, 'itinerary_items');
                onSnapshot(itineraryRef, (snapshot) => {
                    const temp = [[], [], [], [], [], [], []];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const dayIdx = data.dayIndex || 0;
                        if (dayIdx >= 0 && dayIdx < 7) {
                            temp[dayIdx].push({ ...data, id: doc.id });
                        }
                    });
                    // Sort by startTime
                    temp.forEach(day => day.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || '')));
                    itineraryData.value = temp;
                });

                // 2. Shopping Listener
                const shoppingRef = collection(db, 'artifacts', appId, 'users', uid, 'shopping_items');
                onSnapshot(shoppingRef, (snapshot) => {
                    shoppingList.value = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                });

                // 3. Expenses Listener
                const expensesRef = collection(db, 'artifacts', appId, 'users', uid, 'expense_items');
                const expensesQuery = query(expensesRef, orderBy("date", "desc")); 
                onSnapshot(expensesQuery, (snapshot) => {
                    expenses.value = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                });

                // 4. Hotels Listener
                const hotelsRef = collection(db, 'artifacts', appId, 'users', uid, 'hotel_items');
                onSnapshot(hotelsRef, (snapshot) => {
                    hotels.value = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                });
            };

            // Helper: Convert DataURL to Blob for Upload
            const dataURLtoBlob = (dataurl) => {
                if (!dataurl.startsWith('data:')) return null;
                var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while(n--){
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], {type:mime});
            }

            // Helper: Process Images (Upload new ones, keep old URLs)
            const processImagesAndUpload = async (imagesArray) => {
                if (!imagesArray || imagesArray.length === 0) return [];
                isLoading.value = true;
                const processedUrls = [];
                
                try {
                    for (const img of imagesArray) {
                        if (img.startsWith('data:')) {
                            // Needs Upload
                            const blob = dataURLtoBlob(img);
                            const filename = `img_${Date.now()}_${Math.random().toString(36).substring(7)}`;
                            const fileRef = storageRef(storage, `users/${userId.value}/${filename}`);
                            await uploadBytes(fileRef, blob);
                            const url = await getDownloadURL(fileRef);
                            processedUrls.push(url);
                        } else {
                            // Already URL
                            processedUrls.push(img);
                        }
                    }
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("ÁÖßÁâá‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÈáçË©¶");
                } finally {
                    isLoading.value = false;
                }
                return processedUrls;
            };

            // --- Itinerary CRUD ---
            
            const saveItineraryItem = async () => {
                if(!newItinerary.value.name) return;
                if(!userId.value) return;

                // Auto-set transportType for flight category
                if(newItinerary.value.category === 'flight') {
                    newItinerary.value.transportType = 'flight';
                }

                const finalImages = await processImagesAndUpload(newItinerary.value.images);
                const itemData = { ...newItinerary.value, images: finalImages, dayIndex: selectedDateIndex.value };
                delete itemData.id; // Don't save ID in doc data

                const colRef = collection(db, 'artifacts', appId, 'users', userId.value, 'itinerary_items');

                if(isEditMode.value && newItinerary.value.id) {
                    await updateDoc(doc(colRef, newItinerary.value.id), itemData);
                } else {
                    await addDoc(colRef, itemData);
                }
                closeAllModals();
            };

            const removeItineraryItem = async (id) => {
                if(!userId.value) return;
                if(confirm("Á¢∫ÂÆöÂà™Èô§ÂóéÔºü")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId.value, 'itinerary_items', id));
                    closeAllModals();
                }
            };

            // --- Shopping CRUD ---

            const saveShoppingItem = async () => {
                if(!newShoppingItem.value.name) return;
                if(!userId.value) return;

                if(!isEditMode.value) newShoppingItem.value.category = shoppingSubTab.value;
                const finalImages = await processImagesAndUpload(newShoppingItem.value.images);
                const itemData = { ...newShoppingItem.value, images: finalImages };
                delete itemData.id;

                const colRef = collection(db, 'artifacts', appId, 'users', userId.value, 'shopping_items');

                if(isEditMode.value && newShoppingItem.value.id) {
                    await updateDoc(doc(colRef, newShoppingItem.value.id), itemData);
                } else {
                    await addDoc(colRef, itemData);
                }
                closeAllModals();
            };

            const removeShoppingItem = async (id) => {
                if(!userId.value) return;
                if(confirm("Á¢∫ÂÆöÂà™Èô§ÂóéÔºü")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId.value, 'shopping_items', id));
                    closeAllModals();
                }
            };

            // --- Hotel CRUD ---

            const saveHotelItem = async () => {
                if(!newHotel.value.name) return;
                if(!userId.value) return;

                const finalImages = await processImagesAndUpload(newHotel.value.images);
                const itemData = { ...newHotel.value, images: finalImages };
                delete itemData.id;

                const colRef = collection(db, 'artifacts', appId, 'users', userId.value, 'hotel_items');

                if(isEditHotel.value && newHotel.value.id) {
                    await updateDoc(doc(colRef, newHotel.value.id), itemData);
                } else {
                    await addDoc(colRef, itemData);
                }
                closeAllModals();
            };

            const removeHotelItem = async (id) => {
                if(!userId.value) return;
                if(confirm("Á¢∫ÂÆöÂà™Èô§ÂóéÔºü")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId.value, 'hotel_items', id));
                    closeAllModals();
                }
            };

            // --- Expense CRUD ---

            const addExpense = async () => {
                if(!newExpense.value.name || !newExpense.value.amount) return;
                if(!userId.value) return;

                const itemData = { ...newExpense.value, date: newExpense.value.date || new Date().toISOString().split('T')[0] };
                const colRef = collection(db, 'artifacts', appId, 'users', userId.value, 'expense_items');
                await addDoc(colRef, itemData);
                
                closeAllModals();
            };

            const removeExpense = async (id) => {
                if(!userId.value) return;
                if(confirm("Á¢∫ÂÆöÂà™Èô§ÂóéÔºü")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId.value, 'expense_items', id));
                }
            };

            // --- Common Methods ---

            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * EXCHANGE_RATE);
            const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
            
            const getCategoryColor = (cat) => CATEGORY_MAP[cat]?.color || CATEGORY_MAP.other.color;
            const getCategoryIcon = (cat) => CATEGORY_MAP[cat]?.icon || CATEGORY_MAP.other.icon;
            
            const getWeatherIcon = (c) => ({
                snow: 'fa-solid fa-snowflake', sunny: 'fa-solid fa-sun', cloudy: 'fa-solid fa-cloud', rain: 'fa-solid fa-cloud-showers-heavy'
            }[c] || 'fa-solid fa-cloud');

            const getWeatherDescription = (c) => ({
                snow: 'ÈôçÈõ™Ê©üÁéáÈ´ò', sunny: 'Êô¥ÊúóÂ•ΩÂ§©Ê∞£', cloudy: 'Â§öÈõ≤Èô∞Â§©', rain: 'ÊúâÈõ®Ë´ãÂ∏∂ÂÇò'
            }[c] || 'Â§©Ê∞£Êú™Áü•');

            const getTransportIcon = (t) => ({
                walk: 'fa-solid fa-person-walking', car: 'fa-solid fa-car', bus: 'fa-solid fa-bus', public: 'fa-solid fa-train-subway', flight: 'fa-solid fa-plane'
            }[t] || 'fa-solid fa-arrow-right');

            const handleAddClick = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    newItinerary.value = { id: null, name: '', category: 'sightseeing', startTime: '', note: '', transportType: 'walk', address: '', images: [] };
                    showItineraryModal.value = true;
                } else if(currentTab.value === 'shopping') {
                    isEditMode.value = false;
                    newShoppingItem.value = { 
                        id: null, category: shoppingSubTab.value, name: '', shopName: '', 
                        price: null, quantity: 1, openHour: '09', openMin: '00', closeHour: '21', closeMin: '00', images: [] 
                    };
                    showShoppingModal.value = true;
                } else if(currentTab.value === 'info') {
                    isEditHotel.value = false;
                    newHotel.value = { id: null, name: '', date: '', phone: '', images: [] };
                    showHotelModal.value = true;
                } else {
                    newExpense.value = { name: '', amount: null, category: 'food', payment: 'cash' };
                    showExpenseModal.value = true;
                }
            };

            const closeAllModals = () => {
                showItineraryModal.value = false;
                showShoppingModal.value = false;
                showExpenseModal.value = false;
                showShoppingDetailModal.value = false;
                showItineraryDetailModal.value = false;
                showImagePreviewModal.value = false;
                showHotelModal.value = false;
                showHotelDetailModal.value = false;
                isLoading.value = false;
            };

            // Detail Logic
            const openItineraryDetail = (item) => {
                selectedItineraryItem.value = item;
                showItineraryDetailModal.value = true;
            };

            const switchToEditItinerary = () => {
                showItineraryDetailModal.value = false;
                isEditMode.value = true;
                newItinerary.value = JSON.parse(JSON.stringify(selectedItineraryItem.value));
                if(!newItinerary.value.images) newItinerary.value.images = [];
                showItineraryModal.value = true;
            };

            const openHotelDetail = (item) => {
                selectedHotelItem.value = item;
                showHotelDetailModal.value = true;
            };
            
            const switchToEditHotel = () => {
                showHotelDetailModal.value = false;
                isEditHotel.value = true;
                newHotel.value = JSON.parse(JSON.stringify(selectedHotelItem.value));
                if(!newHotel.value.images) newHotel.value.images = [];
                showHotelModal.value = true;
            };

            const openShoppingDetail = (item) => {
                selectedShoppingItem.value = item;
                showShoppingDetailModal.value = true;
            };

            const switchToEditShopping = () => {
                showShoppingDetailModal.value = false;
                isEditMode.value = true;
                newShoppingItem.value = JSON.parse(JSON.stringify(selectedShoppingItem.value));
                showShoppingModal.value = true;
            };

            // Image Handlers
            const handleImageUploadGeneric = (e, targetRef) => {
                const files = e.target.files;
                if(files && files.length > 0) {
                    if (!targetRef.value.images) targetRef.value.images = [];
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (evt) => targetRef.value.images.push(evt.target.result);
                        reader.readAsDataURL(file);
                    });
                }
            };

            const removeImageGeneric = (idx, targetRef) => {
                if(targetRef.value.images) targetRef.value.images.splice(idx, 1);
            };

            const handleItineraryImageUpload = (e) => handleImageUploadGeneric(e, newItinerary);
            const removeItineraryImage = (idx) => removeImageGeneric(idx, newItinerary);
            
            const handleHotelImageUpload = (e) => handleImageUploadGeneric(e, newHotel);
            const removeHotelImage = (idx) => removeImageGeneric(idx, newHotel);

            const handleImageUpload = (e) => handleImageUploadGeneric(e, newShoppingItem);
            const removeImage = (idx) => removeImageGeneric(idx, newShoppingItem);

            const openImagePreview = (url) => {
                if(url) {
                    previewImageUrl.value = url;
                    showImagePreviewModal.value = true;
                }
            };
            
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');

            return {
                isLoading,
                currentTab, dates, selectedDateIndex, currentItinerary, currentWeather, currentDateInfo,
                hotels, shoppingList, filteredShoppingList, expenses, totalExpensesJPY, totalExpensesTWD,
                currencyInput, currencyResult, calculateCurrency, formatNumber,
                getWeatherIcon, getWeatherDescription, getCategoryColor, getCategoryIcon, getTransportIcon,
                // Modals
                showItineraryModal, showShoppingModal, showExpenseModal, showShoppingDetailModal, showItineraryDetailModal, showHotelModal, showHotelDetailModal, showImagePreviewModal, anyModalOpen,
                isEditMode, isEditHotel, shoppingSubTab, previewImageUrl,
                // Data
                newItinerary, newShoppingItem, newHotel, newExpense, selectedShoppingItem, selectedItineraryItem, selectedHotelItem,
                // Methods
                handleAddClick, closeAllModals, 
                saveItineraryItem, removeItineraryItem, openItineraryDetail, switchToEditItinerary, handleItineraryImageUpload, removeItineraryImage,
                saveShoppingItem, removeShoppingItem, openShoppingDetail, switchToEditShopping, handleImageUpload, removeImage, openImagePreview,
                saveHotelItem, removeHotelItem, openHotelDetail, switchToEditHotel, handleHotelImageUpload, removeHotelImage,
                addExpense, removeExpense, openMap
            };
        }
    }).mount('#app');
</script>
</body>
</html>