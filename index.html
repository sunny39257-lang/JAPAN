<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“æ¥µç°¡è¡Œç¨‹è¦åŠƒ â„ï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hokkaido-blue': '#a5dff9',    
                        'snow-white': '#f8f8f8',       
                        'active-blue': '#4c99c3',      
                    },
                }
            }
        }
    </script>
    
    <script>
        // ğŸ¯ Firebase åˆå§‹åŒ–é‚è¼¯
        const firebaseConfig = {
            apiKey: "AIzaSyA8wiv63sS1lbCkOOeYlZpL1RlKHvvAAYA", 
            authDomain: "hokkaido-b390b.firebaseapp.com",
            projectId: "hokkaido-b390b",   
            storageBucket: "hokkaido-b390b.firebasestorage.app", 
            messagingSenderId: "199459788936",
            appId: "1:199459788936:web:f430fac50b022959f8e73d"
        };
        
        // å…¨åŸŸè®Šæ•¸å®£å‘Š
        let storage = null;
        let db = null; 

        if (typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                storage = firebase.storage();
                db = firebase.firestore();
                // ç¶å®šåˆ° window ä»¥ä¾¿é™¤éŒ¯
                window.db = db;
                window.storage = storage;
                console.log("Firebase initialized successfully");
            } catch (e) {
                console.error("Firebase initialized Error:", e);
            }
        } else {
            console.error("Firebase SDK failed to load.");
        }
    </script>
    
    <style>
        /* å„ªåŒ–ï¼šé˜²æ­¢ Vue è¼‰å…¥å‰çš„ç•«é¢é–ƒçˆ */
        [v-cloak] { display: none; }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .curved-banner::after {
            content: '';
            position: absolute;
            bottom: -50px; 
            left: 0;
            width: 100%;
            height: 100px;
            background-color: #f8f8f8; 
            border-top-left-radius: 50%;
            border-top-right-radius: 50%;
            z-index: 10;
        }
        .main-content {
            margin-top: -30px;
            position: relative;
            z-index: 20;
            background-color: #f8f8f8;
            min-height: calc(100vh - 250px + 30px);
        }
        .whitespace-pre-line {
            white-space: pre-line;
        }
        .date-scroll-container {
            overflow-x: scroll;
            scroll-behavior: smooth;
        }
        .sortable-ghost {
            opacity: 0.5;
            background: #eee !important;
        }
    </style>
</head>

<body class="bg-snow-white font-sans">
    <div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen" v-cloak>
        
        <div class="relative w-full h-[250px] curved-banner overflow-hidden group">
            <div class="w-full h-full bg-cover bg-center transition-transform duration-700 hover:scale-105" 
                 :style="{ 'background-image': 'url(' + bannerUrl + ')' }">
                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
            </div>

            <button @click="openBannerModal" class="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full opacity-90 hover:opacity-100 transition duration-150 flex items-center text-sm z-30">
                <ion-icon name="image-outline" class="text-xl"></ion-icon>
            </button>
            <div class="absolute bottom-4 left-4 text-white text-3xl font-extrabold z-20 shadow-black drop-shadow-md">
                åŒ—æµ·é“æ¥µç°¡è¡Œç¨‹è¦åŠƒ
            </div>
        </div>

        <main class="main-content rounded-t-3xl p-4 pt-6 pb-20">

            <div v-show="activeTab === 'daily-plan'">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <ion-icon name="calendar-outline" class="mr-2 text-active-blue"></ion-icon>
                        æ¯æ—¥è¡Œç¨‹è¡¨
                    </div>
                    <button @click="openDateModal" class="text-sm font-semibold text-active-blue hover:text-blue-700 bg-active-blue/10 px-3 py-1 rounded-full transition duration-150 flex items-center">
                        <ion-icon name="create-outline" class="mr-1"></ion-icon>
                        ç·¨è¼¯æ—¥æœŸ
                    </button>
                </h2>
                
                <div class="date-scroll-container flex space-x-3 pb-3 mb-4 no-scrollbar">
                    <div v-for="date in dates" :key="date.date" 
                         @click="activeDate = date.date"
                         :class="{'bg-active-blue text-white shadow-md': activeDate === date.date, 'bg-white border border-gray-200 text-gray-600': activeDate !== date.date}"
                         class="flex-shrink-0 w-16 h-16 p-2 rounded-xl text-center cursor-pointer flex flex-col justify-center transition duration-200">
                        <span class="text-2xl font-extrabold block leading-none">{{ date.dateNum }}</span>
                        <span class="text-xs block leading-snug">{{ date.dayName }}</span>
                    </div>
                </div>

                <div class="weather-info bg-hokkaido-blue/30 p-4 rounded-xl mb-6 flex items-center shadow-inner border border-hokkaido-blue/80">
                    <ion-icon :name="getWeatherIcon(weatherData.condition)" class="text-4xl mr-4 text-active-blue flex-shrink-0"></ion-icon>
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-800">{{ activeDate }} - ç•¶åœ°å¤©æ°£</h3>
                        <div class="flex items-center text-sm text-gray-700 mt-1 space-x-4">
                            <p class="text-3xl font-extrabold text-active-blue">{{ weatherData.temperature }}Â°C</p>
                            <p class="text-base">é«”æ„Ÿï¼š{{ weatherData.feelsLike }}Â°C</p>
                            <p class="text-base">{{ weatherData.conditionText }}</p>
                        </div>
                    </div>
                    <button @click="fetchWeather(activeDate)" class="text-active-blue/80 hover:text-active-blue ml-2 p-1 flex-shrink-0" title="æ›´æ–°å¤©æ°£">
                        <ion-icon name="refresh-circle-outline" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <div class="space-y-4">
                    <draggable :list="filteredSchedules" item-key="id" @end="updateTravelTimes" handle=".schedule-card" class="space-y-4">
                        <template #item="{ element: item, index: index }">
                            <div>
                                <div v-if="item.prevTravelTime && item.prevTravelTime !== 'N/A'" 
                                    class="flex items-center text-sm text-gray-500 my-2 px-2 py-1 bg-gray-100 rounded-lg shadow-inner w-fit mx-auto">
                                    <ion-icon :name="getTransportIcon(item.prevTransport)" class="mr-1 text-active-blue"></ion-icon>
                                    <span class="font-semibold">{{ item.prevTravelTime }}</span>
                                    <span class="mx-1">â€¢</span>
                                    <span class="text-xs">{{ item.prevTransport === 'drive' ? 'é–‹è»Š' : (item.prevTransport === 'walk' ? 'æ­¥è¡Œ' : (item.prevTransport === 'public' ? 'å¤§çœ¾é‹è¼¸' : 'å‡ºç™¼')) }}</span>
                                </div>
                                
                                <div class="schedule-card bg-white p-4 rounded-xl shadow-lg border-l-4 cursor-grab active:cursor-grabbing hover:shadow-xl transition duration-150 relative" 
                                     :class="item.category === 'flight' ? 'border-hokkaido-blue' : 'border-active-blue'">

                                    <div v-if="item.category === 'flight'" @click="openFlightModal(item, 'view')" class="flex justify-between items-center">
                                        <div>
                                            <h4 class="text-lg font-bold text-hokkaido-blue flex items-center">
                                                <ion-icon name="airplane-outline" class="mr-2"></ion-icon>
                                                {{ item.airportName || 'èˆªç­è³‡è¨Š' }}
                                            </h4>
                                            <p class="text-sm text-gray-700 mt-1 font-extrabold">
                                                {{ item.fromAirport }} ({{ item.depTime }}) â†’ {{ item.toAirport }} ({{ item.arrTime }})
                                            </p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                èˆªç­: **{{ item.flightNum }}** | ç™»æ©Ÿ: {{ item.boardingTime }}
                                            </p>
                                        </div>
                                        <button @click.stop="openFlightModal(item, 'edit')" class="text-gray-500 hover:text-active-blue ml-2 p-1">
                                            <ion-icon name="create-outline" class="text-xl"></ion-icon>
                                        </button>
                                    </div>
                                    
                                    <div v-else class="flex justify-between items-start">
                                        <div @click="openScheduleModal(item)" class="flex-grow">
                                            <h4 class="text-xl font-bold text-gray-800">{{ item.name }}</h4>
                                            <p class="text-sm text-gray-600 mt-1">
                                                <ion-icon name="time-outline" class="align-middle text-active-blue"></ion-icon>
                                                <span class="font-mono font-bold mx-1">{{ item.time }}</span> | 
                                                <ion-icon :name="getCategoryIcon(item.category)" class="align-middle ml-1"></ion-icon>
                                                {{ getCategoryLabel(item.category) }}
                                            </p>
                                            <p v-if="item.entryFee" class="text-xs text-red-500 mt-1 font-semibold">é–€ç¥¨: Â¥{{ item.entryFee }}</p>
                                            <p v-if="item.openHours" class="text-xs text-gray-500">ç‡Ÿæ¥­æ™‚é–“: {{ item.openHours}}</p>
                                            <p class="text-sm mt-2 text-gray-700 whitespace-pre-line">{{ item.notes }}</p>
                                            
                                            <button @click.stop="navigateTo(item.address || item.name)" 
                                                    class="mt-3 text-sm font-semibold text-white bg-active-blue hover:bg-blue-600 px-3 py-1 rounded-full transition duration-150 shadow-md flex items-center">
                                                <ion-icon name="navigate-circle-outline" class="mr-1 text-lg"></ion-icon>
                                                å°èˆª
                                            </button>
                                        </div>
                                        <button @click.stop="openScheduleModal(item)" class="text-gray-500 hover:text-active-blue ml-2 p-1 flex-shrink-0">
                                            <ion-icon name="create-outline" class="text-xl"></ion-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </draggable>

                    <button @click="openScheduleModal(null)" 
                            class="fixed bottom-24 right-4 bg-active-blue text-white p-4 rounded-full shadow-2xl hover:bg-blue-600 transition duration-300 z-50 flex items-center justify-center transform hover:scale-110">
                        <ion-icon name="add-outline" class="text-3xl"></ion-icon>
                    </button>
                </div>
            </div>

            <div v-show="activeTab === 'info'" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <ion-icon name="information-circle-outline" class="mr-2 text-active-blue"></ion-icon>
                    æ—…éŠè³‡è¨Š
                </h2>
                
                <div class="bg-white p-4 rounded-xl shadow-lg space-y-3 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                        <ion-icon name="swap-horizontal-outline" class="mr-2"></ion-icon>
                        å³æ™‚åŒ¯ç‡æ›ç®—æ©Ÿ (JPY to TWD)
                    </h3>
                    
                    <div class="flex items-center space-x-2">
                        <label for="jpy-input" class="text-xl font-bold text-gray-500">Â¥</label>
                        <input type="number" id="jpy-input" v-model.number="jpyAmount" @input="calculateExchange"
                            placeholder="æ—¥åœ“é‡‘é¡"
                            class="flex-1 p-2 border rounded-lg focus:ring-active-blue focus:border-active-blue text-lg">
                    </div>
                    
                    <div class="text-center text-sm text-gray-500 py-1">
                        **ç•¶å‰åŒ¯ç‡:** 1 JPY â‰ˆ NT$ {{ exchangeRate }}
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-hokkaido-blue/50 rounded-lg">
                        <p class="text-lg font-semibold text-gray-700">ç´„ç•¶å°å¹£ (TWD)</p>
                        <p class="text-2xl font-extrabold text-active-blue">NT$ {{ twdAmount.toLocaleString() }}</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                        <ion-icon name="cloud-outline" class="mr-2"></ion-icon>
                        å¤©æ°£é å ± (æœ­å¹Œ)
                    </h3>
                    <p class="text-sm text-gray-600">æ˜æ—¥: -2Â°C / 1Â°Cï¼Œå¤šé›²è½‰æ™´</p>
                    <p class="text-xs text-gray-500">ï¼ˆè³‡æ–™ä¾†æº: æ¨¡æ“¬æ•¸æ“šï¼‰</p>
                </div>
            </div>

            <div v-show="activeTab === 'shopping'" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <ion-icon name="basket-outline" class="mr-2 text-active-blue"></ion-icon>
                    è³¼ç‰©æ¸…å–®
                </h2>
                
                <div class="flex justify-around bg-gray-100 p-1 rounded-xl mb-4 shadow-inner">
                    <button @click="activeShoppingTab = 'gift'"
                            :class="{'bg-active-blue text-white shadow-md': activeShoppingTab === 'gift', 'text-gray-600': activeShoppingTab !== 'gift'}"
                            class="flex-1 py-2 rounded-lg transition duration-200 flex items-center justify-center font-semibold text-sm">
                        <ion-icon name="gift-outline" class="mr-1"></ion-icon> ä¼´æ‰‹ç¦®
                    </button>
                    <button @click="activeShoppingTab = 'drugstore'"
                            :class="{'bg-active-blue text-white shadow-md': activeShoppingTab === 'drugstore', 'text-gray-600': activeShoppingTab !== 'drugstore'}"
                            class="flex-1 py-2 rounded-lg transition duration-200 flex items-center justify-center font-semibold text-sm">
                        <ion-icon name="bandage-outline" class="mr-1"></ion-icon> è—¥å¦
                    </button>
                </div>

                <div v-for="item in filteredShoppingList" :key="item.id" 
                     class="bg-white p-4 rounded-xl shadow-lg flex items-center transition duration-150 relative">
                    
                    <div class="flex flex-col items-center flex-shrink-0 mr-4">
                        <button @click.stop="togglePurchase(item)" class="text-2xl mb-2 hover:scale-110 transition" 
                                :class="item.purchased ? 'text-green-500' : 'text-gray-300'">
                            <ion-icon :name="item.purchased ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                        </button>
                        <div class="w-14 h-14 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center border shadow-sm">
                            <img v-if="item.imageUrls && item.imageUrls.length > 0" :src="item.imageUrls[0]" alt="å•†å“åœ–ç‰‡" class="w-full h-full object-cover">
                            <ion-icon v-else name="camera-outline" class="text-2xl text-gray-400 p-2"></ion-icon>
                        </div>
                    </div>

                    <div class="flex-grow cursor-pointer" @click="openShoppingModal(item, 'view')">
                        <p class="text-lg font-semibold" :class="{'line-through text-gray-500': item.purchased}">{{ item.name }}</p>
                        
                        <p class="text-sm font-bold text-red-600">
                            Â¥{{ item.price ? item.price.toLocaleString() : 'N/A' }} <span class="text-gray-400 font-normal text-xs">(ç´„ NT${{ (item.price * exchangeRate).toFixed(0) }})</span>
                        </p>
                        
                        <p v-if="item.notes" class="text-xs text-gray-500 whitespace-pre-line mt-1 truncate">{{ item.notes.split('\n')[0] }}</p>
                    </div>

                    <div class="ml-3 flex flex-col space-y-2 flex-shrink-0">
                        <button @click.stop="openShoppingModal(item, 'edit')" 
                                class="text-gray-500 hover:text-active-blue transition duration-150 p-1">
                            <ion-icon name="create-outline" class="text-xl"></ion-icon>
                        </button>
                        <button @click.stop="openShoppingModal(item, 'delete')" 
                                class="text-gray-500 hover:text-red-500 transition duration-150 p-1">
                            <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                        </button>
                    </div>
                </div>

                <button @click="openShoppingModal(null, 'new')" 
                        class="fixed bottom-24 right-4 bg-active-blue text-white p-4 rounded-full shadow-2xl hover:bg-blue-600 transition duration-300 z-50 flex items-center justify-center transform hover:scale-110">
                    <ion-icon name="add-outline" class="text-3xl"></ion-icon>
                </button>
            </div>

            <div v-show="activeTab === 'expenses'" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <ion-icon name="cash-outline" class="mr-2 text-active-blue"></ion-icon>
                    æ—…è¡ŒèŠ±è²»
                </h2>

                <div class="bg-active-blue text-white p-4 rounded-xl shadow-lg text-center">
                    <p class="text-sm">ç¸½èŠ±è²» (JPY)</p>
                    <p class="text-4xl font-extrabold">Â¥ {{ totalExpense.toLocaleString() }}</p>
                </div>

                <div v-for="item in expensesList" :key="item.id" class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-active-blue/70">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="text-lg font-bold text-gray-800">{{ item.name }}</p>
                            <p class="text-xs text-gray-500">{{ item.date }} | **{{ getExpenseCategoryLabel(item.category) }}** ({{ item.paymentMethod === 'cash' ? 'ç¾é‡‘' : 'ä¿¡ç”¨å¡' }})</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-extrabold text-red-600">- Â¥{{ item.amount.toLocaleString() }}</p>
                            <button @click="openExpenseModal(item)" class="text-xs text-gray-400 mt-1 hover:text-active-blue underline">ç·¨è¼¯</button>
                        </div>
                    </div>
                    <p v-if="item.notes" class="text-sm mt-1 text-gray-600 italic">å‚™è¨»: {{ item.notes }}</p>
                </div>

                <button @click="openExpenseModal(null)" 
                        class="fixed bottom-24 right-4 bg-active-blue text-white p-4 rounded-full shadow-2xl hover:bg-blue-600 transition duration-300 z-50 flex items-center justify-center transform hover:scale-110">
                    <ion-icon name="add-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
            
        </main>
        
        <div class="fixed bottom-0 left-0 right-0 z-50 flex justify-around py-2 bg-white shadow-2xl border-t border-gray-200 w-full">
            <button v-for="tab in tabs" :key="tab.id" 
                    @click="activeTab = tab.id"
                    :class="{'text-active-blue transform scale-110': activeTab === tab.id, 'text-gray-500': activeTab !== tab.id}"
                    class="flex flex-col items-center flex-1 py-1 px-1 transition duration-300 ease-in-out">
                <ion-icon :name="tab.icon" class="text-2xl"></ion-icon>
                <span class="text-xs mt-0.5">{{ tab.label }}</span>
            </button>
        </div>
        
        <div v-if="isBannerModalOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-4">
                <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
                    ä¸Šå‚³è‡ªè¨‚ Banner åœ–ç‰‡
                    <button @click="isBannerModalOpen = false" class="text-gray-500 hover:text-gray-800 transition duration-150">
                        <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                    </button>
                </h3>
                
                <p class="text-sm text-gray-600">ä¸Šå‚³å¾Œï¼Œæ­¤åœ–ç‰‡å°‡æ°¸ä¹…æ›¿æ›é ‚éƒ¨çš„æ©«å¹…ç…§ç‰‡ã€‚</p>
                <input type="file" @change="handleBannerUpload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-active-blue/10 file:text-active-blue hover:file:bg-active-blue/20">

                <div v-if="uploadProgress > 0 && uploadProgress <= 100" class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-active-blue h-2.5 rounded-full transition-all duration-300" 
                            :style="{ width: uploadProgress + '%' }"></div>
                    <p class="text-xs text-center mt-1 text-gray-600">{{ uploadProgress.toFixed(0) }}% ä¸Šå‚³ä¸­...</p>
                </div>

                <div v-if="tempBannerPreviewUrl" class="text-center pt-4 border-t">
                    <p class="text-sm font-semibold mb-2">åœ–ç‰‡é è¦½:</p>
                    <img :src="tempBannerPreviewUrl" class="w-full max-h-40 object-cover rounded-lg border shadow-md">
                </div>

                <div class="flex justify-end space-x-2 pt-2">
                    <button @click="isBannerModalOpen = false" class="bg-gray-300 text-gray-800 p-2 rounded-lg w-24">å–æ¶ˆ</button>
                    <button @click="saveBannerUrl" :disabled="!tempBannerPreviewUrl || uploadProgress > 0 && uploadProgress < 100" 
                            class="bg-active-blue text-white p-2 rounded-lg w-24 disabled:opacity-50">
                        ç¢ºèªè¨­å®š
                    </button>
                </div>
            </div>
        </div>

        <div v-if="isDateModalOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-4">
                <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
                    è¡Œç¨‹æ—¥æœŸç®¡ç†
                    <button @click="isDateModalOpen = false" class="text-gray-500 hover:text-gray-800 transition duration-150">
                        <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                    </button>
                </h3>
                
                <div class="space-y-3 max-h-60 overflow-y-auto pr-2 border-b pb-4">
                    <div v-for="dateObj in dates" :key="dateObj.date" class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <p class="font-semibold text-lg text-gray-700">{{ dateObj.dateNum }} ({{ dateObj.dayName }})</p>
                        <button v-if="dates.length > 1" @click="deleteDate(dateObj.date)" class="text-red-500 hover:text-red-700 p-1" title="åˆªé™¤æ—¥æœŸ">
                            <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                        </button>
                        <span v-else class="text-xs text-gray-400">è‡³å°‘ä¿ç•™ä¸€å€‹</span>
                    </div>
                </div>

                <div class="pt-4 space-y-3">
                    <label for="new-date" class="block text-sm font-medium text-gray-700">æ–°å¢æ—¥æœŸ</label>
                    <input type="date" id="new-date" v-model="tempNewDate" class="w-full p-2 border rounded-lg focus:ring-active-blue focus:border-active-blue">
                    <button @click="addDate" class="w-full bg-active-blue text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">
                        <ion-icon name="add-outline" class="mr-1 align-middle"></ion-icon>
                        ç¢ºèªæ–°å¢
                    </button>
                </div>
            </div>
        </div>
        
        <div v-if="isScheduleModalOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">{{ editingScheduleId ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                    <button @click="isScheduleModalOpen = false" class="text-gray-500 hover:text-gray-800 transition duration-150">
                        <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                    </button>
                </div>
                
                <select v-model="tempSchedule.category" class="w-full p-2 border rounded-lg">
                    <option value="" disabled>é¸æ“‡åˆ†é¡</option>
                    <option v-for="cat in generalScheduleCategories" :key="cat.value" :value="cat.value">{{ cat.label }}</option>
                </select>

                <input type="text" v-model="tempSchedule.name" placeholder="è¡Œç¨‹åç¨±" class="w-full p-2 border rounded-lg">
                <input type="text" v-model="tempSchedule.address" placeholder="åœ°å€ (ç”¨æ–¼å°èˆª)" class="w-full p-2 border rounded-lg">
                <input type="time" v-model="tempSchedule.time" class="w-full p-2 border rounded-lg">
                
                <div class="space-y-2 border p-3 rounded-lg bg-gray-50">
                    <label class="block text-sm font-medium text-gray-700">ä¸Šå€‹è¡Œç¨‹åˆ°æ­¤çš„äº¤é€šè³‡è¨Š</label>
                    <div class="flex space-x-2">
                        <input type="text" v-model="tempSchedule.prevTravelTime" placeholder="æ‰€éœ€æ™‚é–“ (ä¾‹å¦‚: 15m)" class="w-2/3 p-2 border rounded-lg">
                        <select v-model="tempSchedule.prevTransport" class="w-1/3 p-2 border rounded-lg">
                            <option value="walk">æ­¥è¡Œ</option>
                            <option value="drive">é–‹è»Š</option>
                            <option value="public">å¤§çœ¾é‹è¼¸</option>
                            <option value="">N/A</option>
                        </select>
                    </div>
                </div>
                
                <div v-if="['sightseeing', 'accommodation', 'food', 'shopping'].includes(tempSchedule.category)" class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">ç‡Ÿæ¥­æ™‚é–“</label>
                    <div class="flex space-x-2 items-center">
                        <input type="time" v-model="tempSchedule.openTime" class="w-full p-2 border rounded-lg" placeholder="é–‹é–€æ™‚é–“">
                        <span class="text-gray-500">~</span>
                        <input type="time" v-model="tempSchedule.closeTime" class="w-full p-2 border rounded-lg" placeholder="é—œé–€æ™‚é–“">
                    </div>
                </div>
                
                <input type="number" v-model.number="tempSchedule.entryFee" placeholder="é–€ç¥¨ (æ™¯é»é©ç”¨, JPY)" class="w-full p-2 border rounded-lg" v-if="tempSchedule.category === 'sightseeing'">
                
                <textarea v-model="tempSchedule.notes" placeholder="ç‰¹è‰²åŠå‚™è¨» (å¯è¼¸å…¥å¤šè¡Œ)" class="w-full p-2 border rounded-lg h-24"></textarea>

                <div class="flex justify-end space-x-2 pt-2">
                    <button v-if="editingScheduleId" @click="confirmDelete" class="flex-1 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600">åˆªé™¤</button>
                    <button @click="isScheduleModalOpen = false" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded-lg hover:bg-gray-400">å–æ¶ˆ</button>
                    <button @click="saveSchedule" :class="editingScheduleId ? 'flex-1' : 'flex-2'" class="bg-active-blue text-white p-2 rounded-lg hover:bg-blue-600">å„²å­˜</button>
                </div>
            </div>
        </div>
        
        <div v-if="isFlightModalOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">
                        <span v-if="!editingFlightId">æ–°å¢èˆªç­</span>
                        <span v-else-if="isFlightModalReadOnly">èˆªç­è©³ç´°è³‡è¨Š</span>
                        <span v-else>ç·¨è¼¯èˆªç­è³‡è¨Š</span>
                    </h3>
                    <button @click="isFlightModalOpen = false" class="text-gray-500 hover:text-gray-800 transition duration-150">
                        <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                    </button>
                </div>
                
                <div v-if="!isFlightModalReadOnly" class="space-y-4">
                    <input type="text" v-model="tempFlight.airportName" placeholder="æ©Ÿå ´åç¨± (ä¾‹å¦‚: æ¡ƒåœ’æ©Ÿå ´å‡ºç™¼)" class="w-full p-2 border rounded-lg">
                    <input type="text" v-model="tempFlight.flightNum" placeholder="èˆªç­ç·¨è™Ÿ (ä¾‹å¦‚: BR116)" class="w-full p-2 border rounded-lg">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" v-model="tempFlight.fromAirport" placeholder="å‡ºç™¼åœ°ä»£ç¢¼ (TPE)" class="p-2 border rounded-lg">
                        <input type="text" v-model="tempFlight.toAirport" placeholder="ç›®çš„åœ°ä»£ç¢¼ (CTS)" class="p-2 border rounded-lg">
                    </div>
                    <div class="space-y-2 border p-3 rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700">æ™‚é–“</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" v-model="tempFlight.depTime" class="p-2 border rounded-lg" placeholder="èµ·é£›æ™‚é–“">
                            <input type="time" v-model="tempFlight.arrTime" class="p-2 border rounded-lg" placeholder="æŠµé”æ™‚é–“">
                        </div>
                        <input type="text" v-model="tempFlight.duration" placeholder="é£›è¡Œæ™‚é–“ (ä¾‹å¦‚: 3h30m)" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="time" v-model="tempFlight.boardingTime" placeholder="ç™»æ©Ÿæ™‚é–“" class="p-2 border rounded-lg">
                        <input type="text" v-model="tempFlight.gate" placeholder="ç™»æ©Ÿé–€ (G10)" class="p-2 border rounded-lg">
                    </div>
                    <div class="space-y-2 border p-3 rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700">å‰ç½®äº¤é€šè³‡è¨Š (ä¾‹å¦‚: åˆ°æ©Ÿå ´æ™‚é–“)</label>
                        <div class="flex space-x-2">
                            <input type="text" v-model="tempFlight.prevTravelTime" placeholder="æ‰€éœ€æ™‚é–“ (ä¾‹å¦‚: 2h)" class="w-2/3 p-2 border rounded-lg">
                            <select v-model="tempFlight.prevTransport" class="w-1/3 p-2 border rounded-lg">
                                <option value="drive">é–‹è»Š</option>
                                <option value="public">å¤§çœ¾é‹è¼¸</option>
                                <option value="walk">æ­¥è¡Œ</option>
                                <option value="">N/A</option>
                            </select>
                        </div>
                    </div>
                    <textarea v-model="tempFlight.notes" placeholder="å‚™è¨» (ä¾‹å¦‚: æ‰˜é‹è¡Œæé™åˆ¶)" class="w-full p-2 border rounded-lg h-16"></textarea>
                    <div class="flex justify-end space-x-2 pt-2">
                        <button v-if="editingFlightId" @click="confirmDeleteFlight" class="flex-1 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600">åˆªé™¤</button>
                        <button @click="isFlightModalOpen = false" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded-lg hover:bg-gray-400">å–æ¶ˆ</button>
                        <button @click="saveFlight" :class="editingFlightId ? 'flex-1' : 'flex-2'" class="bg-active-blue text-white p-2 rounded-lg hover:bg-blue-600">å„²å­˜</button>
                    </div>
                </div>

                <div v-else class="space-y-4 text-gray-700">
                    <div class="text-center pb-4 border-b">
                        <ion-icon name="airplane-outline" class="text-6xl text-active-blue"></ion-icon>
                        <p class="text-2xl font-bold">{{ tempFlight.airportName }}</p>
                        <p class="text-xl font-extrabold text-active-blue mt-1">{{ tempFlight.flightNum }}</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-center p-3 bg-gray-50 rounded-lg shadow-sm">
                            <div>
                                <p class="text-2xl font-bold">{{ tempFlight.depTime }}</p>
                                <p class="text-sm text-gray-500">{{ tempFlight.fromAirport }} (èµ·é£›)</p>
                            </div>
                            <div class="flex flex-col items-center text-sm text-gray-500 flex-grow mx-4">
                                <ion-icon name="swap-horizontal-outline" class="text-xl"></ion-icon>
                                <p>{{ tempFlight.duration }}</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold">{{ tempFlight.arrTime }}</p>
                                <p class="text-sm text-gray-500">{{ tempFlight.toAirport }} (æŠµé”)</p>
                            </div>
                        </div>
                        <p class="text-sm flex items-start">
                            <ion-icon name="time-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">ç™»æ©Ÿæ™‚é–“:</span> {{ tempFlight.boardingTime || 'æœªå®š' }}
                        </p>
                        <p class="text-sm flex items-start">
                            <ion-icon name="location-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">ç™»æ©Ÿé–€:</span> {{ tempFlight.gate || 'æœªå®š' }}
                        </p>
                        <p class="text-sm flex items-start">
                            <ion-icon :name="getTransportIcon(tempFlight.prevTransport)" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">å‰ç½®äº¤é€š:</span> {{ tempFlight.prevTravelTime || 'æœªå®š' }}
                        </p>
                        <div v-if="tempFlight.notes" class="text-sm flex items-start pt-2 border-t">
                            <ion-icon name="document-text-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">å‚™è¨»:</span> <span class="whitespace-pre-line">{{ tempFlight.notes }}</span>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button @click="isFlightModalOpen = false" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded-lg hover:bg-gray-400">é—œé–‰</button>
                        <button @click="isFlightModalReadOnly = false" class="flex-1 bg-active-blue text-white p-2 rounded-lg hover:bg-blue-600 flex items-center justify-center">
                            <ion-icon name="create-outline" class="mr-1"></ion-icon> ç·¨è¼¯
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="isShoppingModalOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">
                        <span v-if="!editingShoppingId">æ–°å¢è³¼ç‰©é …ç›®</span>
                        <span v-else-if="isShoppingModalReadOnly">è³¼ç‰©è©³ç´°è³‡è¨Š</span>
                        <span v-else>ç·¨è¼¯è³¼ç‰©é …ç›®</span>
                    </h3>
                    <button @click="isShoppingModalOpen = false" class="text-gray-500 hover:text-gray-800 transition duration-150">
                        <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                    </button>
                </div>
                
                <div v-if="!isShoppingModalReadOnly" class="space-y-4">
                    <select v-model="tempShoppingItem.category" class="w-full p-2 border rounded-lg">
                        <option value="gift">ä¼´æ‰‹ç¦®</option>
                        <option value="drugstore">è—¥å¦</option>
                    </select>
                    <input type="text" v-model="tempShoppingItem.name" placeholder="å•†å“åç¨±/å‹è™Ÿ" class="w-full p-2 border rounded-lg">
                    <input type="number" v-model.number="tempShoppingItem.price" placeholder="é ä¼°åƒ¹æ ¼ (JPY)" class="w-full p-2 border rounded-lg">
                    
                    <div class="border p-3 rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å•†å“åœ–ç‰‡ (å¯ä¸Šå‚³å¤šå¼µ)</label>
                        <input type="file" @change="handleFileUpload" multiple 
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-active-blue/10 file:text-active-blue hover:file:bg-active-blue/20">

                        <div v-if="uploadProgress > 0 && uploadProgress <= 100" class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="bg-active-blue h-2.5 rounded-full transition-all duration-300" 
                                    :style="{ width: uploadProgress + '%' }"></div>
                            <p class="text-xs text-center mt-1 text-gray-600">{{ uploadProgress.toFixed(0) }}% ä¸Šå‚³ä¸­...</p>
                        </div>
                        
                        <div v-if="tempShoppingItem.imageUrls && tempShoppingItem.imageUrls.length > 0" class="flex flex-wrap gap-2 pt-2 border-t mt-3">
                            <div v-for="(url, index) in tempShoppingItem.imageUrls" :key="index" class="relative">
                                <img :src="url" class="w-16 h-16 object-cover rounded-md border">
                                <button @click.stop="removeImage(index)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-700">
                                    <ion-icon name="close-outline"></ion-icon>
                                </button>
                            </div>
                        </div>
                        <p v-else class="text-xs text-gray-400">ç›®å‰æ²’æœ‰åœ–ç‰‡é è¦½ã€‚</p>
                    </div>

                    <input type="text" v-model="tempShoppingItem.address" placeholder="é è¨ˆè³¼è²·åœ°é»" class="w-full p-2 border rounded-lg">
                    <input type="text" v-model="tempShoppingItem.website" placeholder="å®˜æ–¹ç¶²ç«™æˆ–é€£çµ" class="w-full p-2 border rounded-lg">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">ç‡Ÿæ¥­æ™‚é–“</label>
                        <div class="flex space-x-2 items-center">
                            <input type="time" v-model="tempShoppingItem.openTime" class="w-full p-2 border rounded-lg" placeholder="é–‹é–€æ™‚é–“">
                            <span class="text-gray-500">~</span>
                            <input type="time" v-model="tempShoppingItem.closeTime" class="w-full p-2 border rounded-lg" placeholder="é—œé–€æ™‚é–“">
                        </div>
                    </div>
                    <textarea v-model="tempShoppingItem.notes" placeholder="å‚™è¨»ã€å‹è™Ÿæˆ–è³¼è²·é‡é»" class="w-full p-2 border rounded-lg h-24"></textarea>

                    <div class="flex justify-end space-x-2 pt-2">
                        <button v-if="editingShoppingId" @click="confirmDeleteShopping" class="flex-1 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600">åˆªé™¤</button>
                        <button @click="isShoppingModalOpen = false" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded-lg hover:bg-gray-400">å–æ¶ˆ</button>
                        <button @click="saveShoppingItem()" :class="editingShoppingId ? 'flex-1' : 'flex-2'" class="bg-active-blue text-white p-2 rounded-lg hover:bg-blue-600">å„²å­˜</button>
                    </div>
                </div>

                <div v-else class="space-y-4 text-gray-700">
                    <div class="text-center pb-4 border-b">
                        <div v-if="tempShoppingItem.imageUrls && tempShoppingItem.imageUrls.length > 0" class="flex justify-center flex-wrap gap-2 mb-3">
                            <img :src="tempShoppingItem.imageUrls[0]" class="w-20 h-20 object-cover rounded-lg border shadow-md">
                        </div>
                        <p class="text-2xl font-bold">{{ tempShoppingItem.name }}</p>
                        <p class="text-xl font-extrabold text-red-600 mt-1">Â¥{{ tempShoppingItem.price ? tempShoppingItem.price.toLocaleString() : 'N/A' }}</p>
                    </div>

                    <div class="space-y-3">
                        <p class="text-sm flex items-start">
                            <ion-icon name="pricetag-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">åˆ†é¡:</span> {{ tempShoppingItem.category === 'gift' ? 'ä¼´æ‰‹ç¦®' : 'è—¥å¦' }}
                        </p>
                        <p v-if="tempShoppingItem.address" class="text-sm flex items-start">
                            <ion-icon name="location-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">é è¨ˆåœ°é»:</span> {{ tempShoppingItem.address }}
                        </p>
                        <p v-if="tempShoppingItem.openHours" class="text-sm flex items-start">
                            <ion-icon name="time-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">ç‡Ÿæ¥­æ™‚é–“:</span> {{ tempShoppingItem.openHours }}
                        </p>
                        <p v-if="tempShoppingItem.notes" class="text-sm flex items-start pt-2 border-t">
                            <ion-icon name="document-text-outline" class="mr-2 mt-1 text-active-blue flex-shrink-0"></ion-icon>
                            <span class="font-semibold">å‚™è¨»:</span> <span class="whitespace-pre-line">{{ tempShoppingItem.notes }}</span>
                        </p>
                        <p class="text-sm flex items-start pt-2 border-t">
                            <ion-icon :name="tempShoppingItem.purchased ? 'checkmark-circle-outline' : 'alert-circle-outline'" class="mr-2 mt-1 flex-shrink-0" :class="tempShoppingItem.purchased ? 'text-green-500' : 'text-orange-500'"></ion-icon>
                            <span class="font-semibold">ç‹€æ…‹:</span> <span :class="tempShoppingItem.purchased ? 'text-green-500' : 'text-orange-500'">{{ tempShoppingItem.purchased ? 'âœ… å·²è³¼è²·' : 'ğŸ›’ å¾…è³¼' }} </span>
                        </p>
                    </div>

                    <div class="flex justify-end space-x-2 pt-4">
                        <button @click="isShoppingModalOpen = false" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded-lg hover:bg-gray-400">é—œé–‰</button>
                        <button @click="isShoppingModalReadOnly = false" class="flex-1 bg-active-blue text-white p-2 rounded-lg hover:bg-blue-600 flex items-center justify-center">
                            <ion-icon name="create-outline" class="mr-1"></ion-icon> ç·¨è¼¯
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="isExpenseModalOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-4">
                <h3 class="text-xl font-bold mb-4">{{ editingExpenseId ? 'ç·¨è¼¯èŠ±è²»' : 'æ–°å¢èŠ±è²»' }}</h3>
                <input type="text" v-model="tempExpense.name" placeholder="èŠ±è²»é …ç›®åç¨±" class="w-full p-2 border rounded-lg">
                <input type="number" v-model.number="tempExpense.amount" placeholder="é‡‘é¡ (JPY)" class="w-full p-2 border rounded-lg">
                <select v-model="tempExpense.category" class="w-full p-2 border rounded-lg">
                    <option value="" disabled>é¸æ“‡èŠ±è²»åˆ†é¡</option>
                    <option v-for="cat in expenseCategories" :key="cat.value" :value="cat.value">{{ cat.label }}</option>
                </select>
                <div class="grid grid-cols-2 gap-2">
                    <select v-model="tempExpense.paymentMethod" class="w-full p-2 border rounded-lg">
                        <option value="cash">ç¾é‡‘ (Cash)</option>
                        <option value="card">ä¿¡ç”¨å¡ (Card)</option>
                    </select>
                    <input type="date" v-model="tempExpense.date" class="w-full p-2 border rounded-lg">
                </div>
                <textarea v-model="tempExpense.notes" placeholder="å‚™è¨»" class="w-full p-2 border rounded-lg h-16"></textarea>
                <div class="flex justify-end space-x-2 pt-2">
                    <button v-if="editingExpenseId" @click="confirmDeleteExpense" class="bg-red-500 text-white p-2 rounded-lg w-20 hover:bg-red-600">åˆªé™¤</button>
                    <button @click="isExpenseModalOpen = false" class="bg-gray-300 text-gray-800 p-2 rounded-lg w-20">å–æ¶ˆ</button>
                    <button @click="saveExpense" class="bg-active-blue text-white p-2 rounded-lg w-20">å„²å­˜</button>
                </div>
            </div>
        </div>
        
        <div v-if="isDeleteConfirmOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl text-center">
                <ion-icon name="warning-outline" class="text-5xl text-red-500 mb-3"></ion-icon>
                <h3 class="text-xl font-bold mb-2">ç¢ºèªåˆªé™¤</h3>
                <p class="text-gray-700">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹ {{ deleteConfirmMessage }} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚</p>
                <div class="flex justify-center space-x-4 mt-6">
                    <button @click="isDeleteConfirmOpen = false" class="bg-gray-300 text-gray-800 p-2 rounded-lg w-24 hover:bg-gray-400">å–æ¶ˆ</button>
                    <button @click="executeDelete" class="bg-red-500 text-white p-2 rounded-lg w-24 hover:bg-red-600">ç¢ºèªåˆªé™¤</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch } = Vue;
        
        createApp({
            components: {
                draggable: vuedraggable,
            },
            data() {
                return {
                    isLoading: true,
                    // --- ç‹€æ…‹æ§åˆ¶ ---
                    activeTab: 'daily-plan', 
                    activeDate: localStorage.getItem('hokkaido_active_date') || '2025-12-06',
                    activeShoppingTab: 'gift', 
                    
                    // --- Modal ç‹€æ…‹ ---
                    isBannerModalOpen: false,
                    isDateModalOpen: false,
                    isScheduleModalOpen: false,
                    editingScheduleId: null,
                    isFlightModalOpen: false,
                    editingFlightId: null,
                    isFlightModalReadOnly: false,
                    isShoppingModalOpen: false,
                    editingShoppingId: null,
                    isShoppingModalReadOnly: false,
                    isExpenseModalOpen: false,
                    editingExpenseId: null,
                    isDeleteConfirmOpen: false,
                    deleteTargetType: '', // 'schedule', 'flight', 'shopping', 'expense'
                    deleteTargetId: null,

                    // --- è‡¨æ™‚è³‡æ–™ ---
                    tempBannerPreviewUrl: null,
                    tempNewDate: null,
                    tempSchedule: { date: '', name: '', category: 'sightseeing', notes: '', entryFee: null, time: '09:00', address: '', openHours: '', openTime: '09:00', closeTime: '18:00', prevTravelTime: '', prevTransport: 'drive', orderIndex: 99 }, 
                    tempFlight: { date: '', name: '', category: 'flight', flightNum: '', fromAirport: '', toAirport: '', depTime: '10:00', arrTime: '13:30', boardingTime: '09:30', gate: 'TBD', duration: '3h30m', notes: '', airportName: 'æ¡ƒåœ’æ©Ÿå ´ (TPE)', prevTravelTime: '', prevTransport: 'public', orderIndex: 0 }, 
                    tempShoppingItem: { name: '', category: 'gift', price: null, notes: '', imageUrls: [], purchased: false, address: '', website: '', openHours: '', openTime: '10:00', closeTime: '21:00' },
                    tempExpense: { name: '', category: 'food', date: new Date().toISOString().substring(0, 10), amount: null, paymentMethod: 'cash', notes: '' },

                    // --- ä¸»è¦è³‡æ–™ ---
                    bannerUrl: 'https://images.unsplash.com/photo-1549488344-938b81313e6d?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    dates: [],
                    schedulesList: [],
                    shoppingList: [],
                    expensesList: [],
                    
                    // --- å…¶ä»–è¨­å®š ---
                    exchangeRate: 0.22, 
                    jpyAmount: 10000, 
                    twdAmount: 2200, 
                    uploadProgress: 0,
                    weatherData: {
                        temperature: '-3',
                        feelsLike: '-8',
                        condition: 'snow', // sunny, cloudy, rain, snow
                        conditionText: 'ä¸‹é›ª â„ï¸'
                    },

                    // ç¶å®šå…¨åŸŸè®Šæ•¸
                    db: window.db,
                    storage: window.storage,

                    // --- å¸¸é‡/é¸å–® ---
                    tabs: [
                        { id: 'daily-plan', icon: 'map-outline', label: 'è¡Œç¨‹' },
                        { id: 'info', icon: 'information-circle-outline', label: 'è³‡è¨Š' },
                        { id: 'shopping', icon: 'basket-outline', label: 'è³¼ç‰©' },
                        { id: 'expenses', icon: 'cash-outline', label: 'èŠ±è²»' },
                    ],
                    fullScheduleCategories: [
                        { value: 'sightseeing', label: 'æ™¯é»' },
                        { value: 'accommodation', label: 'ä½å®¿' },
                        { value: 'food', label: 'ç¾é£Ÿ' },
                        { value: 'shopping', label: 'è³¼ç‰©' },
                        { value: 'flight', label: 'èˆªç­' },
                        { value: 'other', label: 'å…¶ä»–' },
                    ],
                    generalScheduleCategories: [
                        { value: 'sightseeing', label: 'æ™¯é»' },
                        { value: 'accommodation', label: 'ä½å®¿' },
                        { value: 'food', label: 'ç¾é£Ÿ' },
                        { value: 'shopping', label: 'è³¼ç‰©' },
                        { value: 'other', label: 'å…¶ä»–' },
                    ],
                    expenseCategories: [
                        { value: 'transport', label: 'äº¤é€š' },
                        { value: 'food', label: 'é¤é£²' },
                        { value: 'accommodation', label: 'ä½å®¿' },
                        { value: 'shopping', label: 'è³¼ç‰©' },
                        { value: 'sightseeing', label: 'é–€ç¥¨/æ´»å‹•' },
                        { value: 'other', label: 'å…¶ä»–' },
                    ],
                }
            },
            watch: {
                activeDate(newDate) {
                    localStorage.setItem('hokkaido_active_date', newDate);
                    this.fetchWeather(newDate); 
                },
            },
            computed: {
                filteredSchedules: {
                    get() { 
                        return this.schedulesList.filter(s => s.date === this.activeDate)
                            .sort((a, b) => {
                                if (a.category === 'flight' && b.category !== 'flight') return -1;
                                if (a.category !== 'flight' && b.category === 'flight') return 1;

                                if (typeof a.orderIndex === 'number' && typeof b.orderIndex === 'number') {
                                    return a.orderIndex - b.orderIndex;
                                }
                                
                                return (a.time || '').localeCompare(b.time || ''); 
                            });
                    },
                    set(updatedList) { 
                        const otherSchedules = this.schedulesList.filter(s => s.date !== this.activeDate);
                        this.schedulesList = [...otherSchedules, ...updatedList]; 
                    }
                },
                filteredShoppingList() {
                    return this.shoppingList.filter(item => item.category === this.activeShoppingTab);
                },
                totalExpense() {
                    return this.expensesList.reduce((sum, item) => sum + (item.amount || 0), 0);
                },
                deleteConfirmMessage() {
                    switch (this.deleteTargetType) {
                        case 'schedule': return 'è¡Œç¨‹';
                        case 'flight': return 'èˆªç­è¡Œç¨‹';
                        case 'shopping': return 'è³¼ç‰©é …ç›®';
                        case 'expense': return 'èŠ±è²»è¨˜éŒ„';
                        default: return 'é …ç›®';
                    }
                }
            },
            methods: {
                // --- é€šç”¨æ–¹æ³• ---
                getCategoryLabel(value) {
                    const category = this.fullScheduleCategories.find(c => c.value === value);
                    return category ? category.label : 'å…¶ä»–';
                },
                getCategoryIcon(value) {
                    switch (value) {
                        case 'sightseeing': return 'camera-outline';
                        case 'accommodation': return 'bed-outline';
                        case 'food': return 'restaurant-outline';
                        case 'shopping': return 'bag-handle-outline';
                        case 'flight': return 'airplane-outline';
                        default: return 'help-circle-outline';
                    }
                },
                getExpenseCategoryLabel(value) {
                    const category = this.expenseCategories.find(c => c.value === value);
                    return category ? category.label : 'å…¶ä»–';
                },
                getTransportIcon(transport) {
                    switch (transport) {
                        case 'walk': return 'walk-outline';
                        case 'drive': return 'car-outline';
                        case 'public': return 'bus-outline';
                        case 'flight': return 'airplane-outline';
                        default: return 'arrow-forward-outline';
                    }
                },
                getWeatherIcon(condition) {
                    switch (condition) {
                        case 'sunny': return 'sunny-outline';
                        case 'cloudy': return 'cloudy-outline';
                        case 'rain': return 'rainy-outline';
                        case 'snow': return 'snow-outline';
                        default: return 'cloud-outline';
                    }
                },
                async fetchWeather(dateString) {
                    const weatherOptions = [
                        { temp: -3, feels: -8, cond: 'snow', text: 'ä¸‹é›ª â„ï¸' },
                        { temp: 2, feels: -2, cond: 'cloudy', text: 'å¤šé›² â˜ï¸' },
                        { temp: -5, feels: -10, cond: 'snow', text: 'å¤§é›ª ğŸŒ¨ï¸' },
                        { temp: 5, feels: 1, cond: 'sunny', text: 'æ™´æœ— â˜€ï¸' },
                        { temp: 1, feels: -3, cond: 'rain', text: 'ä¸‹é›¨ ğŸŒ§ï¸' },
                    ];
                    
                    const randomWeather = weatherOptions[Math.floor(Math.random() * weatherOptions.length)];
                    await new Promise(resolve => setTimeout(resolve, 500)); 
                    
                    this.weatherData.temperature = randomWeather.temp;
                    this.weatherData.feelsLike = randomWeather.feels;
                    this.weatherData.condition = randomWeather.cond;
                    this.weatherData.conditionText = randomWeather.text;
                },
                navigateTo(address) {
                    if (address) {
                        const url = `https://www.google.com/maps/search/?api=1&query=$?q=${encodeURIComponent(address)}`;
                        window.open(url, '_blank');
                    } else {
                        alert('æ­¤è¡Œç¨‹æœªæä¾›åœ°å€æˆ–åœ°é»åç¨±ï¼Œç„¡æ³•å°èˆªï¼');
                    }
                },

                // --- Firebase è³‡æ–™æ“ä½œ ---
                async fetchData(collectionName, listName) {
                    if (!this.db) {
                        console.warn(`Firestore æœå‹™æœªåˆå§‹åŒ–ï¼Œç•¥éè®€å– ${collectionName}`);
                        return;
                    }
                    try {
                        const snapshot = await this.db.collection(collectionName).get();
                        this[listName] = snapshot.docs.map(doc => ({ 
                            ...doc.data(), 
                            id: doc.id, 
                            imageUrls: doc.data().imageUrls || (doc.data().imageUrl ? [doc.data().imageUrl] : []),
                        }));
                    } catch (error) {
                        console.error(`Error fetching ${collectionName}: `, error);
                    }
                },
                async fetchBannerUrl() {
                    if (!this.db) return;
                    try {
                        const doc = await this.db.collection('settings').doc('banner').get();
                        if (doc.exists && doc.data().url) {
                            this.bannerUrl = doc.data().url;
                        }
                    } catch(e) {
                        console.error("Error fetching banner URL:", e);
                    }
                },
                handleBannerUpload(event) {
                    const file = event.target.files[0];
                    if (!file || !this.storage) return;

                    const storageRef = this.storage.ref('banner-images');
                    const uploadTask = storageRef.child('main_banner').put(file);

                    uploadTask.on('state_changed', 
                        (snapshot) => { this.uploadProgress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; }, 
                        (error) => { 
                            console.error("Banner åœ–ç‰‡ä¸Šå‚³å¤±æ•—:", error);
                            this.uploadProgress = 0;
                            this.tempBannerPreviewUrl = this.bannerUrl; 
                            alert('Banner åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼');
                        }, 
                        async () => {
                            this.uploadProgress = 100;
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            this.tempBannerPreviewUrl = downloadURL;
                            setTimeout(() => this.uploadProgress = 0, 1000);
                        }
                    );
                },
                async saveBannerUrl() {
                    if (this.tempBannerPreviewUrl && this.db) {
                        this.bannerUrl = this.tempBannerPreviewUrl;
                        try {
                            await this.db.collection('settings').doc('banner').set({ url: this.bannerUrl });
                            alert('Banner åœ–ç‰‡å·²æ›´æ–°ä¸¦å„²å­˜ï¼');
                        } catch(e) {
                            console.error("Error saving banner URL to Firestore:", e);
                            alert('Banner åœ–ç‰‡æ›´æ–°æˆåŠŸï¼Œä½†å„²å­˜æŒä¹…åŒ–è¨­å®šå¤±æ•—ï¼');
                        }
                        this.isBannerModalOpen = false;
                    }
                },

                // --- æ—¥æœŸç®¡ç†æ–¹æ³• ---
                getFormattedDate(dateString) {
                    const date = new Date(dateString.replace(/-/g, '/'));
                    const dayName = new Intl.DateTimeFormat('zh-Hant', { weekday: 'short' }).format(date); 
                    const month = new Intl.DateTimeFormat('zh-Hant', { month: 'numeric' }).format(date);
                    const dateNum = new Intl.DateTimeFormat('zh-Hant', { day: 'numeric' }).format(date);
                    return { 
                        date: dateString, 
                        dayName, 
                        dateNum: `${month}/${dateNum}` 
                    };
                },
                loadDates() {
                    const storedDates = localStorage.getItem('hokkaido_dates');
                    if (storedDates) {
                        this.dates = JSON.parse(storedDates).map(d => this.getFormattedDate(d.date ? d.date : d));
                    } else {
                        const initialDates = [
                            '2025-12-06', '2025-12-07', '2025-12-08', '2025-12-09', '2025-12-10', '2025-12-11', '2025-12-12', '2025-12-13' 
                        ].map(d => this.getFormattedDate(d));
                        this.dates = initialDates;
                        this.saveDates();
                    }
                    if (this.dates.length > 0 && !this.dates.find(d => d.date === this.activeDate)) {
                        this.activeDate = this.dates[0].date;
                    }
                },
                saveDates() {
                    localStorage.setItem('hokkaido_dates', JSON.stringify(this.dates.map(d => d.date)));
                },
                addDate() {
                    if (this.tempNewDate && !this.dates.find(d => d.date === this.tempNewDate)) {
                        this.dates.push(this.getFormattedDate(this.tempNewDate));
                        this.dates.sort((a, b) => new Date(a.date) - new Date(b.date)); 
                        this.saveDates();
                        this.tempNewDate = null;
                    } else if (this.tempNewDate) {
                        alert('è©²æ—¥æœŸå·²å­˜åœ¨ï¼');
                    }
                },
                deleteDate(dateString) {
                    if (this.dates.length <= 1) {
                        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ—¥æœŸï¼');
                        return;
                    }
                    this.dates = this.dates.filter(d => d.date !== dateString);
                    if (this.activeDate === dateString) {
                        this.activeDate = this.dates[0].date;
                    }
                    this.saveDates();
                },

                // --- åŒ¯ç‡åŠŸèƒ½ ---
                calculateExchange() {
                    if (this.jpyAmount === null || this.jpyAmount < 0) {
                        this.twdAmount = 0;
                        return;
                    }
                    this.twdAmount = (this.jpyAmount * this.exchangeRate).toFixed(0);
                },

                // --- è¡Œç¨‹åŠŸèƒ½ ---
                openScheduleModal(schedule) {
                    if (schedule && schedule.category === 'flight') {
                        this.openFlightModal(schedule, 'view');
                        return;
                    }
                    this.editingScheduleId = schedule ? schedule.id : null;
                    let openTime = '09:00';
                    let closeTime = '18:00';
                    if (schedule && schedule.openHours && schedule.openHours.includes('-')) {
                        [openTime, closeTime] = schedule.openHours.split('-');
                    }
                    this.tempSchedule = schedule ? { 
                        ...schedule, 
                        openTime: openTime, 
                        closeTime: closeTime,
                        prevTravelTime: schedule.prevTravelTime || '', 
                        prevTransport: schedule.prevTransport || 'drive', 
                    } : { 
                        date: this.activeDate, name: '', category: 'sightseeing', notes: '', entryFee: null, 
                        time: '09:00', address: '', openHours: '', openTime: '09:00', closeTime: '18:00',
                        prevTravelTime: '', prevTransport: 'drive', orderIndex: 99
                    };
                    this.isScheduleModalOpen = true;
                },
                async saveSchedule() {
                    if (!this.tempSchedule.name || !this.tempSchedule.category) {
                        alert('è«‹å¡«å¯«è¡Œç¨‹åç¨±å’Œåˆ†é¡ã€‚');
                        return;
                    }
                    if (this.tempSchedule.category === 'flight') {
                        alert('èˆªç­è«‹ä½¿ç”¨å°ˆå±¬æ–°å¢æŒ‰éˆ•æˆ–å°‡åˆ†é¡æ”¹æˆå…¶ä»–ï¼');
                        return;
                    }
                    if (this.tempSchedule.openTime && this.tempSchedule.closeTime) {
                        this.tempSchedule.openHours = `${this.tempSchedule.openTime}-${this.tempSchedule.closeTime}`;
                    } else {
                        this.tempSchedule.openHours = '';
                    }
                    if (!this.db) {
                        alert('Firebase Firestore æœªåˆå§‹åŒ–ï¼Œç„¡æ³•å„²å­˜ã€‚');
                        return;
                    }
                    try {
                        const scheduleToSave = { ...this.tempSchedule };
                        delete scheduleToSave.id;
                        delete scheduleToSave.openTime; 
                        delete scheduleToSave.closeTime; 

                        if (this.editingScheduleId) {
                            await this.db.collection('schedules').doc(this.editingScheduleId).set(scheduleToSave, { merge: true });
                            alert('è¡Œç¨‹å·²æ›´æ–°ï¼');
                        } else {
                            scheduleToSave.orderIndex = this.filteredSchedules.length;
                            await this.db.collection('schedules').add(scheduleToSave);
                            alert('è¡Œç¨‹å·²æ–°å¢ï¼');
                        }

                        this.fetchData('schedules', 'schedulesList'); 
                        this.isScheduleModalOpen = false;
                        this.editingScheduleId = null;
                        this.updateTravelTimes();

                    } catch (error) {
                        console.error("Error saving schedule: ", error);
                        alert('å„²å­˜è¡Œç¨‹å¤±æ•—ã€‚');
                    }
                },
                confirmDelete() {
                    this.deleteTargetType = 'schedule';
                    this.deleteTargetId = this.editingScheduleId;
                    this.isScheduleModalOpen = false;
                    this.isDeleteConfirmOpen = true;
                },
                
                async updateTravelTimes() {
                    if (!this.db) return;
                    try {
                        const batch = this.db.batch();
                        for (let i = 0; i < this.filteredSchedules.length; i++) {
                            const item = this.filteredSchedules[i];
                            item.orderIndex = i; 
                            if (i === 0) {
                                if (!item.prevTravelTime) { item.prevTravelTime = '20m'; item.prevTransport = 'drive'; }
                            } else {
                                if (!item.prevTravelTime) { item.prevTravelTime = '15m'; item.prevTransport = 'walk'; }
                            }
                            if (item.id) {
                                batch.set(this.db.collection('schedules').doc(item.id), 
                                        { orderIndex: item.orderIndex, prevTravelTime: item.prevTravelTime || '', prevTransport: item.prevTransport || '' }, 
                                        { merge: true });
                            }
                        }
                        await batch.commit();
                        console.log('è¡Œç¨‹é †åºåŠäº¤é€šæ™‚é–“æ›´æ–°æˆåŠŸï¼');
                    } catch (error) {
                        console.error('æ›´æ–°è¡Œç¨‹é †åºå¤±æ•—:', error);
                    }
                },

                // --- èˆªç­åŠŸèƒ½ ---
                openFlightModal(flight, mode = 'edit') {
                    this.editingFlightId = flight ? flight.id : null;
                    this.tempFlight = flight ? { 
                        ...flight,
                        prevTravelTime: flight.prevTravelTime || '', 
                        prevTransport: flight.prevTransport || 'public', 
                    } : { 
                        date: this.activeDate, name: '', category: 'flight', 
                        flightNum: '', fromAirport: '', toAirport: '', depTime: '10:00', arrTime: '13:30', 
                        boardingTime: '09:30', gate: 'TBD', duration: '3h30m', notes: '', 
                        airportName: 'æ¡ƒåœ’æ©Ÿå ´ (TPE)', prevTravelTime: '', prevTransport: 'public', orderIndex: 0
                    };
                    this.isFlightModalReadOnly = (mode === 'view' && flight);
                    this.isFlightModalOpen = true;
                },
                async saveFlight() {
                    if (!this.tempFlight.flightNum || !this.tempFlight.depTime) {
                        alert('è«‹å¡«å¯«èˆªç­ç·¨è™Ÿå’Œèµ·é£›æ™‚é–“ï¼');
                        return;
                    }
                    if (!this.db) { alert('Firebase æœªé€£ç·š'); return; }

                    try {
                        const flightToSave = { ...this.tempFlight };
                        delete flightToSave.id;
                        flightToSave.name = `èˆªç­ ${flightToSave.flightNum}`;
                        flightToSave.time = flightToSave.depTime;
                        flightToSave.date = this.activeDate;
                        flightToSave.category = 'flight';

                        if (this.editingFlightId) {
                            await this.db.collection('schedules').doc(this.editingFlightId).set(flightToSave, { merge: true });
                            alert('èˆªç­å·²æ›´æ–°ï¼');
                        } else {
                            flightToSave.orderIndex = 0; 
                            await this.db.collection('schedules').add(flightToSave);
                            alert('èˆªç­å·²æ–°å¢ï¼');
                        }
                        this.fetchData('schedules', 'schedulesList'); 
                        this.isFlightModalOpen = false;
                        this.editingFlightId = null;
                    } catch (error) {
                        console.error("Error saving flight: ", error);
                        alert('å„²å­˜èˆªç­å¤±æ•—ï¼');
                    }
                },
                confirmDeleteFlight() {
                    this.deleteTargetType = 'flight';
                    this.deleteTargetId = this.editingFlightId;
                    this.isFlightModalOpen = false;
                    this.isDeleteConfirmOpen = true;
                },

                // --- è³¼ç‰©åŠŸèƒ½ ---
                openShoppingModal(item, mode = 'edit') {
                    this.editingShoppingId = item ? item.id : null;
                    let openTime = '10:00';
                    let closeTime = '21:00';
                    if (item && item.openHours && item.openHours.includes('-')) {
                        [openTime, closeTime] = item.openHours.split('-');
                    }
                    this.tempShoppingItem = item ? { 
                        ...item, 
                        openTime: openTime, 
                        closeTime: closeTime
                    } : { 
                        name: '', category: this.activeShoppingTab, price: null, notes: '', imageUrls: [], purchased: false, 
                        address: '', website: '', openHours: '', openTime: '10:00', closeTime: '21:00' 
                    };
                    this.isShoppingModalReadOnly = (mode === 'view' && item);
                    this.isShoppingModalOpen = true;
                },
                async handleFileUpload(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;
                    if (!this.storage) { alert('Firebase Storage æœªåˆå§‹åŒ–'); return; }

                    let uploadedCount = 0;
                    let totalFiles = files.length;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        try {
                            const uniqueFileName = `${Date.now()}-${file.name}`;
                            const storageRef = this.storage.ref('shopping-images');
                            const imageRef = storageRef.child(uniqueFileName);
                            const uploadTask = imageRef.put(file);

                            uploadTask.on('state_changed', (snapshot) => {
                                const fileProgress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100 / totalFiles;
                                this.uploadProgress = (uploadedCount * 100 / totalFiles) + fileProgress;
                            }, (error) => {
                                console.error(`ä¸Šå‚³å¤±æ•—:`, error);
                            }, async () => {
                                uploadedCount++;
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                this.tempShoppingItem.imageUrls.push(downloadURL);
                                if (uploadedCount === totalFiles) {
                                    this.uploadProgress = 100;
                                    setTimeout(() => this.uploadProgress = 0, 1000); 
                                }
                            });
                        } catch (error) {
                            console.error("ä¸Šå‚³éŒ¯èª¤:", error);
                        }
                    }
                },
                removeImage(index) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ')) {
                        this.tempShoppingItem.imageUrls.splice(index, 1);
                    }
                },
                async saveShoppingItem() {
                    if (!this.db) { alert('Firebase æœªé€£ç·š'); return; }
                    if (!this.tempShoppingItem.name || !this.tempShoppingItem.category) { alert('è«‹å¡«å¯«å•†å“åç¨±å’Œåˆ†é¡ã€‚'); return; }

                    if (this.tempShoppingItem.openTime && this.tempShoppingItem.closeTime) {
                        this.tempShoppingItem.openHours = `${this.tempShoppingItem.openTime}-${this.tempShoppingItem.closeTime}`;
                    } else {
                        this.tempShoppingItem.openHours = '';
                    }

                    try {
                        const itemToSave = { ...this.tempShoppingItem };
                        delete itemToSave.id;
                        delete itemToSave.openTime;
                        delete itemToSave.closeTime;

                        if (this.editingShoppingId) {
                            await this.db.collection('shopping').doc(this.editingShoppingId).set(itemToSave, { merge: true });
                            alert('è³¼ç‰©é …ç›®å·²æ›´æ–°ï¼');
                        } else {
                            await this.db.collection('shopping').add(itemToSave);
                            alert('è³¼ç‰©é …ç›®å·²æ–°å¢ï¼');
                        }
                        this.fetchData('shopping', 'shoppingList');
                        this.isShoppingModalOpen = false;
                        this.editingShoppingId = null;
                        this.isShoppingModalReadOnly = false;
                    } catch (error) {
                        console.error("Error saving shopping item: ", error);
                        alert('å„²å­˜å¤±æ•—ï¼');
                    }
                },
                togglePurchase(item) {
                    item.purchased = !item.purchased;
                    if (this.db && item.id) {
                        this.db.collection('shopping').doc(item.id).update({ purchased: item.purchased });
                    }
                },
                confirmDeleteShopping() {
                    this.deleteTargetType = 'shopping';
                    this.deleteTargetId = this.editingShoppingId;
                    this.isShoppingModalOpen = false;
                    this.isDeleteConfirmOpen = true;
                },

                // --- èŠ±è²»åŠŸèƒ½ ---
                openExpenseModal(expense) {
                    this.editingExpenseId = expense ? expense.id : null;
                    this.tempExpense = expense ? { ...expense } : { name: '', category: 'food', date: new Date().toISOString().substring(0, 10), amount: null, paymentMethod: 'cash', notes: '' };
                    this.isExpenseModalOpen = true;
                },
                async saveExpense() {
                    if (!this.tempExpense.name || !this.tempExpense.amount || !this.tempExpense.category) { alert('è«‹å¡«å¯«å®Œæ•´èŠ±è²»è¨˜éŒ„ã€‚'); return; }
                    if (!this.db) { alert('Firebase æœªé€£ç·š'); return; }
                    try {
                        const expenseToSave = { ...this.tempExpense };
                        delete expenseToSave.id;
                        if (this.editingExpenseId) {
                            await this.db.collection('expenses').doc(this.editingExpenseId).set(expenseToSave, { merge: true });
                            alert('èŠ±è²»è¨˜éŒ„å·²æ›´æ–°ï¼');
                        } else {
                            await this.db.collection('expenses').add(expenseToSave);
                            alert('èŠ±è²»è¨˜éŒ„å·²æ–°å¢ï¼');
                        }
                        this.fetchData('expenses', 'expensesList'); 
                        this.isExpenseModalOpen = false;
                        this.editingExpenseId = null;
                        this.tempExpense = {}; 
                    } catch (error) {
                        console.error("Error saving expense: ", error);
                        alert('å„²å­˜å¤±æ•—ã€‚');
                    }
                },
                confirmDeleteExpense() {
                    this.deleteTargetType = 'expense';
                    this.deleteTargetId = this.editingExpenseId;
                    this.isExpenseModalOpen = false;
                    this.isDeleteConfirmOpen = true;
                },

                // --- é€šç”¨åˆªé™¤åŸ·è¡Œ ---
                async executeDelete() {
                    if (!this.db || !this.deleteTargetId) return;
                    let collectionName;
                    let listName;
                    switch (this.deleteTargetType) {
                        case 'schedule': collectionName = 'schedules'; listName = 'schedulesList'; this.editingScheduleId = null; break;
                        case 'flight': collectionName = 'schedules'; listName = 'schedulesList'; this.editingFlightId = null; break;
                        case 'shopping': collectionName = 'shopping'; listName = 'shoppingList'; this.editingShoppingId = null; break;
                        case 'expense': collectionName = 'expenses'; listName = 'expensesList'; this.editingExpenseId = null; break;
                        default: return;
                    }

                    try {
                        await this.db.collection(collectionName).doc(this.deleteTargetId).delete();
                        alert(`${this.deleteConfirmMessage} å·²åˆªé™¤ï¼`);
                        this.fetchData(collectionName, listName); 
                        this.isDeleteConfirmOpen = false;
                        this.deleteTargetType = '';
                        this.deleteTargetId = null;

                        if (this.deleteTargetType === 'schedule' || this.deleteTargetType === 'flight') {
                            this.updateTravelTimes();
                        }
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        alert('åˆªé™¤å¤±æ•—ã€‚');
                    }
                },
            },
            mounted() {
                // å°‡å…¨åŸŸè®Šæ•¸æ³¨å…¥ Vue data
                this.db = window.db;
                this.storage = window.storage;

                this.loadDates(); 
                this.calculateExchange();
                this.fetchBannerUrl();
                this.fetchData('schedules', 'schedulesList');
                this.fetchData('shopping', 'shoppingList');
                this.fetchData('expenses', 'expensesList');
                this.fetchWeather(this.activeDate);
                
                this.isLoading = false;
            }
        }).mount('#app');
    </script>
</body>
</html>