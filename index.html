<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Family Trip to Hokkaido 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea-blue': '#01579B',
                        'accent-yellow': '#FFD54F',
                    },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            background-color: #F0F2F5;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 480px;
            background-color: #ffffff; min-height: 100vh; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* Header */
        .header-bg {
            height: 200px; width: 100%; position: relative;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            overflow: hidden; background-color: #eee;
            box-shadow: 0 4px 20px rgba(1, 87, 155, 0.1);
        }
        
        .banner-btn {
            position: absolute; width: 36px; height: 36px;
            background: rgba(255, 255, 255, 0.9); color: #01579B;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 30;
            backdrop-filter: blur(4px);
        }
        .banner-settings-btn { top: 20px; right: 20px; }

        /* Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; background: rgba(255, 255, 255, 0.98);
            border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center;
            padding: 10px 16px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); z-index: 50;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94A3B8; font-size: 0.7rem; width: 60px; }
        .nav-item.active { color: #01579B; font-weight: bold; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .fab-center {
            width: 52px; height: 52px; background: #FFD54F; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #01579B;
            font-size: 1.4rem; margin-top: -26px; border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(255, 213, 79, 0.6);
        }

        /* Timeline */
        .timeline-line {
            position: absolute; left: 23px; top: 30px; bottom: -20px;
            width: 2px; background-color: #E2E8F0; z-index: 0;
        }

        /* Common */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .form-label {
            font-size: 0.75rem; font-weight: 700; color: #64748B;
            margin-bottom: 0.35rem; display: block; margin-left: 0.25rem;
        }
        .input-field {
            width: 100%; background-color: #F8FAFC; border-radius: 0.75rem;
            padding: 0.75rem; font-size: 0.875rem; outline: none;
            border: 1px solid transparent; transition: border-color 0.2s;
        }
        .input-field:focus { border-color: #01579B; background-color: #fff; }

        /* Images */
        .image-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .image-preview-item {
            aspect-ratio: 1; position: relative; border-radius: 0.75rem;
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }

        .modal-close-btn {
            position: absolute; top: 12px; right: 12px; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            background-color: #F1F5F9; border-radius: 50%; color: #64748B;
            font-size: 1rem; cursor: pointer; z-index: 50;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95); color: white;
            padding: 12px 20px; border-radius: 12px; font-size: 0.875rem;
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 110; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none; width: max-content;
        }

        /* Lightbox for zooming */
        .lightbox {
            position: fixed; inset: 0; background: black; z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* Spinner */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #01579B; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="app-container" v-cloak>

    <!-- Global Loading -->
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner mb-3"></div>
        <div class="text-slate-600 font-bold text-sm bg-white/80 px-3 py-1 rounded-full">{{ loadingText || 'è™•ç†ä¸­...' }}</div>
    </div>

    <!-- Toast -->
    <div v-if="toastMessage" class="toast">{{ toastMessage }}</div>

    <!-- Header (Banner) -->
    <div class="header-bg">
        <div class="header-image-container relative w-full h-full group">
            <div v-if="!bannerLoaded" class="absolute inset-0 bg-slate-200 animate-pulse z-0"></div>
            <label class="cursor-pointer block w-full h-full relative">
                <input type="file" @change="handleBannerUpload" class="hidden" accept="image/*">
                <img :src="bannerUrl || 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80'" 
                     alt="Header" referrerpolicy="no-referrer"
                     class="relative z-10 transition-opacity duration-500 w-full h-full object-cover"
                     :class="bannerLoaded ? 'opacity-100' : 'opacity-0'"
                     @load="bannerLoaded = true">
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity z-20 flex items-center justify-center text-white text-sm font-bold">
                    <i class="fa-solid fa-camera mr-2"></i> æ›´æ›å°é¢
                </div>
            </label>
            <button @click.stop="showSettingsModal = true" class="banner-btn banner-settings-btn"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <main class="px-4 pt-4">
        
        <!-- Tab: è¡Œç¨‹ (Itinerary) -->
        <div v-if="currentTab === 'itinerary'">
            <!-- Date Selector -->
            <div class="sticky top-0 z-30 bg-white/95 backdrop-blur-md -mx-4 px-4 pb-2 pt-1 shadow-sm rounded-b-2xl">
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 py-1">
                    <div v-for="(day, index) in dates" :key="index"
                         @click="selectedDateIndex = index"
                         class="flex-shrink-0 w-[56px] h-[64px] rounded-xl flex flex-col items-center justify-center cursor-pointer border border-transparent transition-all"
                         :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white shadow-md' : 'bg-slate-50 text-slate-400'">
                        <span class="text-xs font-medium">{{ day.weekday }}</span>
                        <span class="text-lg font-bold leading-none mt-0.5">{{ day.date.split('/')[1] }}</span>
                        <span class="text-[9px] opacity-70">{{ day.date.split('/')[0] }}æœˆ</span>
                    </div>
                </div>
            </div>

            <!-- Header Info -->
            <div class="flex justify-between items-center my-3 px-1">
                <span class="text-xs font-bold text-slate-400">ç•¶æ—¥è¡Œç¨‹ ({{ currentItinerary.length }}) <span class="text-[10px] font-normal ml-1">è‡ªå‹•ä¾æ™‚é–“æ’åº</span></span>
            </div>

            <!-- Timeline -->
            <div class="pl-2 pb-24">
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-400 text-sm">
                    <i class="fa-solid fa-map-location-dot text-4xl mb-3 opacity-20 block"></i>
                    å°šæœªå®‰æ’è¡Œç¨‹ï¼ŒæŒ‰ + æ–°å¢
                </div>

                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group pb-6">
                    <div v-if="idx < currentItinerary.length - 1" class="timeline-line border-l-2 border-dashed border-slate-200"></div>
                    
                    <div v-if="idx > 0" class="pl-12 mb-2 flex items-center text-xs text-slate-400">
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded border border-slate-100">
                            <i :class="getTransportIcon(item.transportType)" class="mr-1.5 opacity-60"></i><span>ç§»å‹•</span>
                        </div>
                    </div>

                    <div class="flex items-start relative z-10">
                        <div class="flex flex-col items-center mr-3 w-12 flex-shrink-0">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm ring-4 ring-white" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-500 mt-1 bg-white px-1 rounded">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden flex cursor-pointer active:scale-[0.99] transition-transform"
                             @click="openDetailPreview(item)">
                            
                            <div class="p-3 flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-base font-bold text-slate-800 leading-tight truncate pr-1">{{ item.name }}</h3>
                                    <span v-if="item.price" class="text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded font-bold shrink-0">Â¥{{ item.price }}</span>
                                </div>
                                <div v-if="item.category === 'flight' && item.deptAirport" class="text-xs text-slate-500 mt-1">
                                    {{ item.deptAirport }} <i class="fa-solid fa-arrow-right text-[10px]"></i> {{ item.arrAirport }}
                                </div>
                                <p v-else class="text-xs text-slate-500 truncate mt-1" v-if="item.note">{{ item.note }}</p>
                            </div>

                            <div v-if="item.images && item.images.length > 0" class="w-20 bg-slate-100 relative">
                                <img :src="item.images[0]" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                                <div v-if="item.images.length > 1" class="absolute bottom-0 right-0 bg-black/50 text-white text-[9px] px-1.5 py-0.5 rounded-tl">
                                    +{{ item.images.length - 1 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è³¼ç‰© (Shopping) -->
        <div v-if="currentTab === 'shopping'" class="pb-24">
            <div class="flex p-1 bg-slate-100 rounded-2xl mb-4">
                <button @click="shoppingSubTab = 'souvenir'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'souvenir' ? 'bg-white text-pink-500 shadow-sm' : 'text-slate-400'">
                    ä¼´æ‰‹ç¦®
                </button>
                <button @click="shoppingSubTab = 'cosmetic'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'cosmetic' ? 'bg-white text-teal-500 shadow-sm' : 'text-slate-400'">
                    è—¥å¦
                </button>
            </div>

            <div class="flex flex-col gap-3">
                <div v-for="(item, idx) in filteredShoppingList" :key="item.id" 
                     @click="openShoppingDetail(item)" 
                     class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-4 cursor-pointer active:bg-slate-50">
                    <div class="w-16 h-16 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0 relative border border-slate-200">
                         <img v-if="item.images && item.images.length > 0" :src="item.images[0]" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image"></i></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-slate-800 text-sm truncate">{{ item.name }}</h4>
                        <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                            <span v-if="item.price" class="bg-yellow-50 text-yellow-700 px-1.5 py-0.5 rounded">Â¥{{ item.price }}</span>
                            <span v-if="item.quantity">x{{ item.quantity }}</span>
                        </div>
                    </div>
                    <div class="text-slate-300 text-sm"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
            </div>
        </div>

        <!-- Tab: èŠ±è²» (Expenses) -->
        <div v-if="currentTab === 'expenses'" class="pb-24">
            <div class="bg-gradient-to-br from-deep-sea-blue to-blue-800 text-white rounded-2xl p-6 mb-6 shadow-lg">
                <p class="text-xs text-blue-200 mb-1">ç¸½æ”¯å‡ºé ä¼°</p>
                <h2 class="text-4xl font-bold mb-1">Â¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm text-blue-200 opacity-80">â‰ˆ NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div v-for="exp in expenses" :key="exp.id" class="flex items-center justify-between p-4 border-b border-slate-50 last:border-0">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm mr-3" :class="getCategoryColor(exp.category)">
                            <i :class="getCategoryIcon(exp.category)"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                            <p class="text-[10px] text-slate-400">{{ exp.date }} Â· {{ exp.payment === 'card' ? 'åˆ·å¡' : 'ç¾é‡‘' }}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-slate-700 text-sm mr-3">Â¥{{ formatNumber(exp.amount) }}</span>
                        <button @click="removeExpense(exp.id)" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è³‡è¨Š (Info) -->
        <div v-if="currentTab === 'info'" class="pb-24">
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-3 mb-6">
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 block mb-1">æ—¥å¹£ JPY</label>
                    <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-slate-50 rounded-lg p-2 font-bold text-deep-sea-blue outline-none">
                </div>
                <i class="fa-solid fa-arrow-right text-slate-300 mt-4"></i>
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 block mb-1">å°å¹£ TWD</label>
                    <div class="w-full bg-slate-100 rounded-lg p-2 font-bold text-slate-600">$ {{ currencyResult }}</div>
                </div>
            </div>

            <!-- Hotel List Section -->
            <div class="mb-4 px-1">
                <h3 class="text-sm font-bold text-slate-600 mb-3"><i class="fa-solid fa-bed mr-2 text-indigo-500"></i>æ—…ç¨‹ä½å®¿æ¸…å–®</h3>
                <div v-if="allAccommodations.length === 0" class="text-center py-6 bg-white rounded-xl border border-dashed border-slate-200 text-slate-400 text-xs">
                    å°šæœªå®‰æ’ä»»ä½•ä½å®¿
                </div>
                <div class="space-y-3">
                    <div v-for="hotel in allAccommodations" :key="hotel.id" class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex flex-col gap-2">
                         <div class="flex justify-between items-start">
                             <div>
                                 <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded mb-1 inline-block">{{ getDateString(hotel.dayIndex) }}</span>
                                 <h4 class="font-bold text-slate-800 text-base">{{ hotel.name }}</h4>
                             </div>
                             <a v-if="hotel.address" :href="'https://www.google.com/maps/search/?api=1&query='+hotel.address" target="_blank" class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100">
                                 <i class="fa-solid fa-location-arrow"></i>
                             </a>
                         </div>
                         <div v-if="hotel.startTime" class="text-xs text-slate-500">
                             <i class="fa-regular fa-clock mr-1"></i>Check-in: {{ hotel.startTime }}
                         </div>
                         <div v-if="hotel.address" class="text-xs text-slate-400 break-words">
                             {{ hotel.address }}
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item" :class="{ active: currentTab === 'itinerary' }" @click="currentTab = 'itinerary'">
            <i class="fa-solid fa-map-location-dot"></i><span>è¡Œç¨‹</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'shopping' }" @click="currentTab = 'shopping'">
            <i class="fa-solid fa-bag-shopping"></i><span>è³¼ç‰©</span>
        </button>
        <button class="fab-center" @click="handleAddClick"><i class="fa-solid fa-plus"></i></button>
        <button class="nav-item" :class="{ active: currentTab === 'expenses' }" @click="currentTab = 'expenses'">
            <i class="fa-solid fa-wallet"></i><span>èŠ±è²»</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'info' }" @click="currentTab = 'info'">
            <i class="fa-solid fa-circle-info"></i><span>è³‡è¨Š</span>
        </button>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- 1. Itinerary Detail Modal (READ ONLY) -->
    <div v-if="showItineraryDetailModal && previewItem" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative z-10 max-h-[90vh] overflow-y-auto">
            <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center z-20 backdrop-blur-md"><i class="fa-solid fa-xmark"></i></button>

            <!-- Image Area -->
            <div class="relative h-60 bg-slate-100 group" @click="openLightbox(previewItem.images ? previewItem.images[currentGalleryIndex] : null)">
                <img v-if="previewItem.images && previewItem.images.length > 0" :src="previewItem.images[currentGalleryIndex]" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                <div v-else class="w-full h-full flex flex-col items-center justify-center text-slate-400 bg-slate-50">
                    <i :class="getCategoryIcon(previewItem.category)" class="text-6xl opacity-30 mb-2"></i>
                    <span class="text-xs">ç„¡ç…§ç‰‡</span>
                </div>
                
                <div v-if="previewItem.images && previewItem.images.length > 1">
                    <button @click.stop="galleryNav(-1, previewItem)" class="absolute top-1/2 left-2 -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                    <button @click.stop="galleryNav(1, previewItem)" class="absolute top-1/2 right-2 -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/50 px-2 py-0.5 rounded-full text-white text-xs backdrop-blur-sm">
                        {{ currentGalleryIndex + 1 }} / {{ previewItem.images.length }}
                    </div>
                </div>
            </div>

            <div class="p-6">
                <div class="mb-4">
                    <!-- æ¨™ç±¤ -->
                    <div class="flex gap-2 mb-2">
                        <span class="text-xs font-bold px-2 py-1 rounded text-white inline-block" :class="getCategoryColor(previewItem.category)">{{ getCategoryName(previewItem.category) }}</span>
                        <!-- èˆªç­è™Ÿ Tag -->
                        <span v-if="previewItem.category === 'flight' && previewItem.name" class="text-xs font-bold px-2 py-1 rounded bg-sky-100 text-sky-700 border border-sky-200 inline-block">
                            <i class="fa-solid fa-plane mr-1"></i>{{ previewItem.name }}
                        </span>
                    </div>

                    <!-- æ¨™é¡Œé‚è¼¯ä¿®æ”¹ï¼šèˆªç­é¡¯ç¤ºæ©Ÿå ´ -->
                    <h2 class="text-2xl font-bold text-slate-800 leading-tight">
                        <span v-if="previewItem.category === 'flight' && previewItem.deptAirport && previewItem.arrAirport">
                            {{ previewItem.deptAirport }} <i class="fa-solid fa-arrow-right text-sm mx-1 opacity-50"></i> {{ previewItem.arrAirport }}
                        </span>
                        <span v-else>{{ previewItem.name }}</span>
                    </h2>
                </div>

                <!-- èˆªç­è©³ç´°è³‡è¨Š -->
                <div v-if="previewItem.category === 'flight' && previewItem.deptAirport" class="mb-6 bg-sky-50 rounded-xl p-4 border border-sky-100 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-sky-400"></div>
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-center flex-1">
                            <div class="text-3xl font-black text-slate-700 tracking-wider">{{ previewItem.deptAirport }}</div>
                            <div class="text-xs text-slate-500 font-bold">{{ previewItem.deptTerminal ? 'T'+previewItem.deptTerminal : 'èˆªå»ˆ -' }}</div>
                            <div class="text-lg font-bold text-sky-700 mt-1">{{ previewItem.startTime }}</div>
                        </div>
                        <div class="flex flex-col items-center justify-center px-2 w-16 opacity-50">
                            <i class="fa-solid fa-plane text-sky-400 text-xl transform rotate-45 mb-1"></i>
                            <div class="w-full border-t-2 border-dashed border-sky-300"></div>
                        </div>
                        <div class="text-center flex-1">
                            <div class="text-3xl font-black text-slate-700 tracking-wider">{{ previewItem.arrAirport }}</div>
                            <div class="text-xs text-slate-500 font-bold">{{ previewItem.arrTerminal ? 'T'+previewItem.arrTerminal : 'èˆªå»ˆ -' }}</div>
                            <div class="text-lg font-bold text-sky-700 mt-1">{{ previewItem.endTime || '--:--' }}</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div v-if="previewItem.category !== 'flight'" class="flex items-start gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-regular fa-clock"></i></div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-700">é è¨ˆæ™‚é–“: {{ previewItem.startTime || '--:--' }}</p>
                            <p v-if="previewItem.openTime" class="text-xs text-slate-500">ç‡Ÿæ¥­æ™‚é–“: {{ previewItem.openTime }}</p>
                            <p v-if="previewItem.checkOutDate" class="text-xs text-indigo-600">é€€æˆ¿: {{ previewItem.checkOutDate }}</p>
                        </div>
                    </div>
                    <div v-if="previewItem.price" class="flex items-center gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-yen-sign"></i></div>
                        <div class="text-sm font-bold text-slate-700">{{ previewItem.price }}</div>
                    </div>
                    <div v-if="previewItem.address" class="flex items-start gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-location-dot"></i></div>
                        <div class="flex-1">
                            <p class="text-sm text-slate-700 mb-1">{{ previewItem.address }}</p>
                            <a :href="'https://www.google.com/maps/search/?api=1&query='+previewItem.address" target="_blank" class="inline-block text-xs bg-slate-100 px-3 py-1.5 rounded-lg text-slate-600 font-bold hover:bg-slate-200"><i class="fa-solid fa-map-location-dot mr-1"></i> Google å°èˆª</a>
                        </div>
                    </div>
                    <div v-if="previewItem.website" class="flex items-center gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-globe"></i></div>
                        <a :href="previewItem.website" target="_blank" class="text-sm text-blue-600 underline font-bold truncate block flex-1">å®˜æ–¹ç¶²ç«™</a>
                    </div>
                    <div v-if="previewItem.note" class="flex items-start gap-3">
                        <div class="w-6 text-slate-400 text-center"><i class="fa-solid fa-note-sticky"></i></div>
                        <p class="text-sm text-slate-600 whitespace-pre-wrap bg-slate-50 p-2 rounded-lg flex-1">{{ previewItem.note }}</p>
                    </div>
                </div>

                <div v-if="previewItem.files && previewItem.files.length > 0" class="mb-6">
                    <p class="text-xs font-bold text-slate-400 mb-2">é™„ä»¶æª”æ¡ˆ</p>
                    <div class="space-y-2">
                        <div v-for="(file, idx) in previewItem.files" :key="idx" @click="openFile(file)" class="flex items-center p-3 bg-slate-50 rounded-xl border border-slate-100 cursor-pointer hover:bg-slate-100">
                            <i class="fa-solid fa-file-pdf text-red-400 text-xl mr-3"></i>
                            <!-- é¡¯ç¤ºæª”æ¡ˆåç¨±ï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºé™„ä»¶ X -->
                            <span class="text-sm font-bold text-slate-700 flex-1 truncate">{{ file.name || 'é™„ä»¶ ' + (idx + 1) }}</span>
                            <i class="fa-solid fa-arrow-up-right-from-square text-slate-300 text-xs ml-2"></i>
                        </div>
                    </div>
                </div>

                <button @click="switchToEditItinerary" class="w-full py-3.5 bg-deep-sea-blue text-white rounded-xl font-bold shadow-lg shadow-blue-900/20"><i class="fa-solid fa-pen mr-2"></i> ç·¨è¼¯è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- 2. Shopping Detail Preview Modal (READ ONLY) -->
    <div v-if="showShoppingDetailModal && selectedShoppingItem" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative z-10 max-h-[90vh] overflow-y-auto">
            <button @click="closeAllModals" class="absolute top-4 right-4 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center z-20 backdrop-blur-md"><i class="fa-solid fa-xmark"></i></button>

            <div class="relative h-72 bg-slate-100 group" @click="openLightbox(selectedShoppingItem.images ? selectedShoppingItem.images[currentGalleryIndex] : null)">
                <img v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 0" :src="selectedShoppingItem.images[currentGalleryIndex]" referrerpolicy="no-referrer" class="w-full h-full object-contain bg-black">
                <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image text-4xl"></i></div>
                
                <div v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 1">
                    <button @click.stop="galleryNav(-1, selectedShoppingItem)" class="absolute top-1/2 left-2 -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                    <button @click.stop="galleryNav(1, selectedShoppingItem)" class="absolute top-1/2 right-2 -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/50 px-2 py-0.5 rounded-full text-white text-xs backdrop-blur-sm">
                        {{ currentGalleryIndex + 1 }} / {{ selectedShoppingItem.images.length }}
                    </div>
                </div>
            </div>

            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-800 mb-2">{{ selectedShoppingItem.name }}</h3>
                <p v-if="selectedShoppingItem.shopName" class="text-sm font-bold text-slate-500 mb-4"><i class="fa-solid fa-store mr-1"></i> {{ selectedShoppingItem.shopName }}</p>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-3 rounded-xl text-center"><span class="text-xs text-slate-400 block">å–®åƒ¹</span><span class="font-bold">Â¥{{ selectedShoppingItem.price || '-' }}</span></div>
                    <div class="bg-slate-50 p-3 rounded-xl text-center"><span class="text-xs text-slate-400 block">æ•¸é‡</span><span class="font-bold">x{{ selectedShoppingItem.quantity || 1 }}</span></div>
                </div>
                <button @click="switchToEditShopping" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold shadow-lg shadow-blue-900/20"><i class="fa-solid fa-pen mr-2"></i> ç·¨è¼¯å…§å®¹</button>
            </div>
        </div>
    </div>

    <!-- 3. Itinerary Add/Edit Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}è¡Œç¨‹</h3>
            
            <div class="space-y-4">
                <div><label class="form-label">é¡å‹</label>
                    <select v-model="newItinerary.category" class="input-field">
                        <option value="sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="food">ğŸ´ é£²é£Ÿ</option>
                        <option value="accommodation">ğŸ¨ ä½å®¿</option>
                        <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="flight">âœˆï¸ èˆªç­</option>
                        <option value="transport">ğŸšŒ äº¤é€š</option>
                    </select>
                </div>

                <!-- 1. é¤å»³ -->
                <div v-if="newItinerary.category === 'food'" class="space-y-3">
                    <div><label class="form-label">é¤å»³åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">åƒ¹æ ¼</label><input v-model="newItinerary.price" placeholder="Â¥" class="input-field"></div>
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                    </div>
                    <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newItinerary.openTime" class="input-field"></div>
                    <div><label class="form-label">åœ°å€</label><input v-model="newItinerary.address" class="input-field"></div>
                    <div><label class="form-label">å®˜ç¶²é€£çµ</label><input v-model="newItinerary.website" placeholder="http://" class="input-field"></div>
                </div>

                <!-- 2. æ™¯é» -->
                <div v-else-if="newItinerary.category === 'sightseeing'" class="space-y-3">
                    <div><label class="form-label">æ™¯é»åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">é–€ç¥¨åƒ¹æ ¼</label><input v-model="newItinerary.price" class="input-field"></div>
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                    </div>
                    <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newItinerary.openTime" class="input-field"></div>
                    <div><label class="form-label">åœ°å€</label><input v-model="newItinerary.address" class="input-field"></div>
                </div>

                <!-- 3. ä½å®¿ -->
                <div v-else-if="newItinerary.category === 'accommodation'" class="space-y-3 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                    <div><label class="form-label text-indigo-800">é£¯åº—åç¨±</label><input v-model="newItinerary.name" class="input-field bg-white"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label text-indigo-800">å…¥ä½æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field bg-white"></div>
                        <div><label class="form-label text-indigo-800">é€€æˆ¿æ—¥æœŸ</label><input v-model="newItinerary.checkOutDate" type="date" class="input-field bg-white"></div>
                    </div>
                    <div><label class="form-label text-indigo-800">åœ°å€</label><input v-model="newItinerary.address" class="input-field bg-white"></div>
                    <div>
                        <label class="form-label text-indigo-800">è¨‚å–®æª”æ¡ˆ</label>
                        <div class="space-y-2">
                             <div v-for="(file, idx) in newItinerary.files" :key="idx" class="flex flex-col bg-white p-2 rounded-lg text-xs border border-indigo-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-slate-500 font-bold">æª”æ¡ˆ {{idx+1}}</span>
                                    <button @click="removeFile(idx, newItinerary)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <!-- æª”æ¡ˆåç¨±è¼¸å…¥ -->
                                <input type="text" v-model="file.name" placeholder="è«‹è¼¸å…¥æª”æ¡ˆèªªæ˜ (å¦‚: è¨‚æˆ¿ç¢ºèªå–®)" class="w-full border-b border-indigo-100 outline-none pb-1 text-indigo-700 placeholder-indigo-200">
                             </div>
                             <label class="block w-full py-2 bg-white border border-dashed border-indigo-300 rounded-lg text-center text-indigo-400 cursor-pointer text-xs">
                                <input type="file" @change="(e) => handleFileUpload(e, newItinerary)" class="hidden" multiple accept="application/pdf,image/*">
                                <i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³ PDF/åœ–ç‰‡
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 4. èˆªç­ -->
                <div v-else-if="newItinerary.category === 'flight'" class="space-y-3 bg-sky-50 p-3 rounded-xl border border-sky-100">
                    <div><label class="form-label text-sky-800">èˆªç­è™Ÿ</label><input v-model="newItinerary.name" placeholder="ä¾‹å¦‚ï¼šJX800" class="input-field bg-white"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label text-sky-800">å‡ºç™¼æ©Ÿå ´</label><input v-model="newItinerary.deptAirport" placeholder="TPE" class="input-field bg-white"></div>
                        <div><label class="form-label text-sky-800">èˆªå»ˆ</label><input v-model="newItinerary.deptTerminal" placeholder="T1" class="input-field bg-white"></div>
                    </div>
                    <div><label class="form-label text-sky-800">å‡ºç™¼æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field bg-white"></div>
                    <div class="border-t border-sky-200 my-1"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label text-sky-800">æŠµé”æ©Ÿå ´</label><input v-model="newItinerary.arrAirport" placeholder="CTS" class="input-field bg-white"></div>
                        <div><label class="form-label text-sky-800">èˆªå»ˆ</label><input v-model="newItinerary.arrTerminal" placeholder="T1" class="input-field bg-white"></div>
                    </div>
                    <div><label class="form-label text-sky-800">æŠµé”æ™‚é–“</label><input v-model="newItinerary.endTime" type="time" class="input-field bg-white"></div>
                    
                     <!-- èˆªç­æª”æ¡ˆä¸Šå‚³ -->
                     <div class="mt-2">
                        <label class="form-label text-sky-800">é›»å­æ©Ÿç¥¨/é™„ä»¶</label>
                        <div class="space-y-2">
                             <div v-for="(file, idx) in newItinerary.files" :key="idx" class="flex flex-col bg-white p-2 rounded-lg text-xs border border-sky-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-slate-500 font-bold">æª”æ¡ˆ {{idx+1}}</span>
                                    <button @click="removeFile(idx, newItinerary)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <input type="text" v-model="file.name" placeholder="è«‹è¼¸å…¥æª”æ¡ˆèªªæ˜ (å¦‚: é›»å­æ©Ÿç¥¨)" class="w-full border-b border-sky-100 outline-none pb-1 text-sky-700 placeholder-sky-200">
                             </div>
                             <label class="block w-full py-2 bg-white border border-dashed border-sky-300 rounded-lg text-center text-sky-400 cursor-pointer text-xs">
                                <input type="file" @change="(e) => handleFileUpload(e, newItinerary)" class="hidden" multiple accept="application/pdf,image/*">
                                <i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³ PDF/åœ–ç‰‡
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 5. å…¶ä»– -->
                <div v-else class="space-y-3">
                     <div><label class="form-label">åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                     <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                        <div><label class="form-label">äº¤é€š</label><select v-model="newItinerary.transportType" class="input-field"><option value="walk">æ­¥è¡Œ</option><option value="car">è‡ªé§•</option><option value="bus">å·´å£«</option><option value="public">åœ°éµ</option><option value="flight">é£›æ©Ÿ</option></select></div>
                     </div>
                </div>

                <div><label class="form-label">å‚™è¨»</label><textarea v-model="newItinerary.note" rows="2" class="input-field"></textarea></div>
                
                <div class="flex gap-2 pt-2">
                    <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveItineraryItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Shopping Add/Edit Modal (Simplified for brevity) -->
    <div v-if="showShoppingModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
         <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
         <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
             <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
             <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}è³¼ç‰©</h3>
             <div class="space-y-4">
                 <div><label class="form-label">å•†å“åç¨±</label><input v-model="newShoppingItem.name" class="input-field"></div>
                 <div class="grid grid-cols-2 gap-3">
                     <div><label class="form-label">å–®åƒ¹ (Â¥)</label><input v-model="newShoppingItem.price" type="number" class="input-field"></div>
                     <div><label class="form-label">æ•¸é‡</label><input v-model="newShoppingItem.quantity" type="number" class="input-field"></div>
                 </div>
                 <div><label class="form-label">å•†åº—åç¨±</label><input v-model="newShoppingItem.shopName" class="input-field"></div>
                 <div><label class="form-label">å•†åº—åœ°å€</label><input v-model="newShoppingItem.address" class="input-field"></div>
                <div>
                    <label class="form-label">å•†å“ç…§ç‰‡</label>
                    <div class="image-preview-grid">
                        <div v-for="(img, idx) in newShoppingItem.images" :key="idx" class="image-preview-item">
                            <img :src="img" referrerpolicy="no-referrer">
                            <button @click="removeImage(idx, newShoppingItem)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 cursor-pointer">
                            <input type="file" @change="(e) => handleImageUpload(e, newShoppingItem)" class="hidden" multiple accept="image/*">
                            <i class="fa-solid fa-plus text-slate-400"></i>
                        </label>
                    </div>
                </div>
                 <div class="flex gap-2 mt-4">
                     <button v-if="isEditMode" @click="removeShoppingItem(newShoppingItem.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                     <button @click="saveShoppingItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
                 </div>
             </div>
         </div>
    </div>

    <!-- 5. Settings Modal -->
    <div v-if="showSettingsModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-6 text-center">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div><label class="form-label">å‡ºç™¼æ—¥æœŸ</label><input type="date" v-model="tripSettings.startDate" class="input-field"></div>
                <div>
                    <label class="form-label">ç®¡ç†å¤©æ•¸</label>
                    <div class="flex items-center justify-between bg-slate-50 rounded-xl p-3">
                        <button @click="changeDuration(-1)" class="w-10 h-10 bg-white shadow rounded-lg text-slate-600"><i class="fa-solid fa-minus"></i></button>
                        <span class="font-bold text-lg">{{ tripSettings.duration }} å¤©</span>
                        <button @click="changeDuration(1)" class="w-10 h-10 bg-white shadow rounded-lg text-slate-600"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <button @click="saveTripSettings" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold mt-2">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>
    
    <!-- 6. Expense Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-6 text-center">è¨˜ä¸€ç­†</h3>
            <div class="space-y-4">
                 <div><label class="form-label">é …ç›®</label><input v-model="newExpense.name" class="input-field"></div>
                 <div><label class="form-label">é‡‘é¡ (Â¥)</label><input v-model.number="newExpense.amount" type="number" class="input-field font-bold text-lg text-deep-sea-blue"></div>
                 <div><label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
                    <div class="flex gap-2">
                        <button @click="newExpense.payment='cash'" class="flex-1 py-2 rounded-lg border text-sm" :class="newExpense.payment==='cash'?'bg-deep-sea-blue text-white':'text-slate-400'">ç¾é‡‘</button>
                        <button @click="newExpense.payment='card'" class="flex-1 py-2 rounded-lg border text-sm" :class="newExpense.payment==='card'?'bg-deep-sea-blue text-white':'text-slate-400'">ä¿¡ç”¨å¡</button>
                    </div>
                 </div>
                 <button @click="addExpense" class="w-full py-3 bg-accent-yellow text-yellow-900 rounded-xl font-bold mt-2">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- 7. Lightbox Zoom -->
    <div v-if="lightboxImage" class="lightbox" @click="lightboxImage = null">
        <img :src="lightboxImage" referrerpolicy="no-referrer" class="max-w-full max-h-screen object-contain p-2">
        <button class="absolute top-4 right-4 text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            const firebaseConfig = {
               apiKey: "AIzaSyA8wiv63sS1lbCkOOeYlZpL1RlKHvvAAYA",
                authDomain: "hokkaido-b390b.firebaseapp.com",
                projectId: "hokkaido-b390b",
                storageBucket: "hokkaido-b390b.firebasestorage.app",
                messagingSenderId: "199459788936",
                appId: "1:199459788936:web:f430fac50b022959f8e73d",
                measurementId: "G-3XGXW53RDB"
            };

            const TRIP_ID = 'family_hokkaido_2026';
            const DATA_PATH = 'shared_data';

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            const isLoading = ref(false);
            const loadingText = ref('');
            const toastMessage = ref('');
            const bannerLoaded = ref(false);

            const compressImage = async (file) => {
                return new Promise((resolve) => {
                    const maxWidth = 1200;
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                        };
                    };
                });
            };

            const currentTab = ref('itinerary');
            const shoppingSubTab = ref('souvenir');
            const dates = ref([]);
            const tripSettings = ref({ startDate: '2026-02-01', duration: 7 });
            const itineraryData = ref({});
            const shoppingList = ref([]);
            const expenses = ref([]);
            const bannerUrl = ref('');
            const selectedDateIndex = ref(0);
            const lightboxImage = ref(null);

            const showSettingsModal = ref(false);
            const showItineraryModal = ref(false);
            const showItineraryDetailModal = ref(false);
            const showShoppingModal = ref(false);
            const showShoppingDetailModal = ref(false);
            const showExpenseModal = ref(false);
            
            const isEditMode = ref(false);
            const newItinerary = ref({ images: [], files: [] });
            const newShoppingItem = ref({ images: [] });
            const newExpense = ref({ payment: 'cash' });
            
            const previewItem = ref(null);
            const selectedShoppingItem = ref(null);
            const currentGalleryIndex = ref(0);
            const currencyInput = ref(10000);
            const currencyResult = ref(0);

            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const filteredShoppingList = computed(() => shoppingList.value.filter(item => item.category === shoppingSubTab.value));
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + e.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * 0.215));
            
            // Computed for All Hotels
            const allAccommodations = computed(() => {
                let hotels = [];
                Object.keys(itineraryData.value).forEach(dayIndex => {
                    itineraryData.value[dayIndex].forEach(item => {
                        if (item.category === 'accommodation') {
                            hotels.push({
                                ...item,
                                dayIndex: parseInt(dayIndex)
                            });
                        }
                    });
                });
                // Sort by day then by time
                return hotels.sort((a, b) => a.dayIndex - b.dayIndex || (a.startTime || '').localeCompare(b.startTime || ''));
            });

            const getCategoryColor = (cat) => ({
                sightseeing: 'bg-emerald-400', food: 'bg-orange-400', shopping: 'bg-pink-400',
                flight: 'bg-sky-500', transport: 'bg-slate-400', accommodation: 'bg-indigo-500'
            }[cat] || 'bg-gray-400');
            const getCategoryIcon = (cat) => ({
                sightseeing: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping',
                flight: 'fa-solid fa-plane', transport: 'fa-solid fa-bus', accommodation: 'fa-solid fa-bed'
            }[cat] || 'fa-solid fa-info');
            const getCategoryName = (cat) => ({
                sightseeing: 'æ™¯é»', food: 'é£²é£Ÿ', shopping: 'è³¼ç‰©', flight: 'èˆªç­', transport: 'äº¤é€š', accommodation: 'ä½å®¿'
            }[cat] || 'è¡Œç¨‹');
            const getTransportIcon = (t) => ({ walk: 'fa-solid fa-person-walking', car: 'fa-solid fa-car', bus: 'fa-solid fa-bus', public: 'fa-solid fa-train-subway', flight: 'fa-solid fa-plane' }[t] || 'fa-solid fa-arrow-right');
            const formatNumber = (n) => n?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * 0.215);
            const getDateString = (idx) => dates.value[idx] ? `${dates.value[idx].date} (${dates.value[idx].weekday})` : '';

            onMounted(async () => {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { if (user) setupListeners(); });
                calculateCurrency();
            });

            const generateDates = () => {
                const arr = [];
                const start = new Date(tripSettings.value.startDate);
                const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                for(let i=0; i<tripSettings.value.duration; i++){
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    arr.push({ date: `${d.getMonth()+1}/${d.getDate()}`, weekday: weekdays[d.getDay()] });
                }
                dates.value = arr;
            };

            const setupListeners = () => {
                onSnapshot(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), (snap) => {
                    if(snap.exists()){
                        const d = snap.data();
                        bannerUrl.value = d.headerImage;
                        if(d.tripStartDate) tripSettings.value.startDate = d.tripStartDate;
                        if(d.tripDuration) tripSettings.value.duration = d.tripDuration;
                        generateDates();
                    }
                });
                onSnapshot(collection(db, 'trips', TRIP_ID, 'itinerary_items'), (snap) => {
                    const temp = {};
                    snap.forEach(d => {
                        const data = d.data();
                        const day = data.dayIndex || 0;
                        if(!temp[day]) temp[day] = [];
                        temp[day].push({ ...data, id: d.id });
                    });
                    // Modified sort logic: Strictly by time
                    Object.keys(temp).forEach(k => {
                        temp[k].sort((a,b) => {
                            const timeA = a.startTime || '99:99'; // Push no-time items to end
                            const timeB = b.startTime || '99:99';
                            return timeA.localeCompare(timeB);
                        });
                    });
                    itineraryData.value = temp;
                });
                onSnapshot(collection(db, 'trips', TRIP_ID, 'shopping_items'), (snap) => shoppingList.value = snap.docs.map(d => ({...d.data(), id:d.id})));
                const qExp = query(collection(db, 'trips', TRIP_ID, 'expense_items'), orderBy("date", "desc"));
                onSnapshot(qExp, (snap) => expenses.value = snap.docs.map(d => ({...d.data(), id:d.id})));
            };

            // Enhanced File Upload Processing
            const processUploads = async (filesArray) => {
                const results = [];
                for(const item of filesArray) {
                    // Check if it's a raw file object (has content) to upload
                    if(item.content && item.content.startsWith('data:')) {
                        const res = await fetch(item.content); 
                        const blob = await res.blob();
                        const fileRef = storageRef(storage, `uploads/file_${Date.now()}_${Math.random().toString(36).substr(2)}`);
                        await uploadBytes(fileRef, blob);
                        const url = await getDownloadURL(fileRef);
                        results.push({ name: item.name, url: url });
                    } else if (item.url) {
                        // Existing file object
                        results.push(item);
                    } else if (typeof item === 'string') {
                        // Legacy string URL support
                        results.push({ name: 'é™„ä»¶', url: item });
                    }
                }
                return results;
            };

            // Image uploads remain arrays of strings
            const processImageUploads = async (imagesArray) => {
                 const urls = [];
                 for(const item of imagesArray) {
                    if(item.startsWith('data:')) {
                         const res = await fetch(item); const blob = await res.blob();
                         const fileRef = storageRef(storage, `uploads/img_${Date.now()}_${Math.random().toString(36).substr(2)}`);
                         await uploadBytes(fileRef, blob);
                         urls.push(await getDownloadURL(fileRef));
                    } else urls.push(item);
                 }
                 return urls;
            };

            const saveTripSettings = async () => {
                isLoading.value = true;
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), {
                    tripStartDate: tripSettings.value.startDate, tripDuration: tripSettings.value.duration
                }, { merge: true });
                generateDates(); isLoading.value = false; showSettingsModal.value = false;
            };
            const changeDuration = (delta) => {
                const n = tripSettings.value.duration + delta;
                if(n > 0) tripSettings.value.duration = n;
            };

            const handleAddClick = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    newItinerary.value = { category: 'sightseeing', transportType: 'walk', images: [], files: [], dayIndex: selectedDateIndex.value };
                    showItineraryModal.value = true;
                } else if(currentTab.value === 'shopping') {
                    isEditMode.value = false;
                    newShoppingItem.value = { category: shoppingSubTab.value, images: [] };
                    showShoppingModal.value = true;
                } else if(currentTab.value === 'expenses') {
                    newExpense.value = { payment: 'cash' };
                    showExpenseModal.value = true;
                }
            };

            const saveItineraryItem = async () => {
                isLoading.value = true;
                const imgUrls = await processImageUploads(newItinerary.value.images);
                const fileObjects = await processUploads(newItinerary.value.files);
                
                const data = { ...newItinerary.value, images: imgUrls, files: fileObjects, dayIndex: selectedDateIndex.value };
                // Ensure order is deleted if exists to rely on time sorting
                delete data.order; 
                delete data.id;
                
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', newItinerary.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'itinerary_items'), data);
                isLoading.value = false; closeAllModals();
            };
            const removeItineraryItem = async (id) => {
                if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) { await deleteDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', id)); closeAllModals(); }
            };

            const saveShoppingItem = async () => {
                isLoading.value = true;
                if(!isEditMode.value) newShoppingItem.value.category = shoppingSubTab.value;
                const urls = await processImageUploads(newShoppingItem.value.images);
                const data = { ...newShoppingItem.value, images: urls };
                delete data.id;
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', newShoppingItem.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'shopping_items'), data);
                isLoading.value = false; closeAllModals();
            };
            const removeShoppingItem = async (id) => {
                if(confirm("åˆªé™¤æ­¤å•†å“ï¼Ÿ")) { await deleteDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', id)); closeAllModals(); }
            };

            const addExpense = async () => {
                if(!newExpense.value.name || !newExpense.value.amount) return;
                isLoading.value = true;
                await addDoc(collection(db, 'trips', TRIP_ID, 'expense_items'), { ...newExpense.value, date: new Date().toISOString().split('T')[0] });
                isLoading.value = false; closeAllModals();
            };
            const removeExpense = async (id) => { if(confirm("åˆªé™¤è¨˜å¸³ï¼Ÿ")) await deleteDoc(doc(db, 'trips', TRIP_ID, 'expense_items', id)); };

            const handleImageUpload = async (e, target) => {
                loadingText.value = 'å£“ç¸®ä¸­...'; isLoading.value = true;
                if(!target.images) target.images = [];
                for(const file of e.target.files) {
                    const blob = await compressImage(file);
                    const reader = new FileReader();
                    reader.onload = (evt) => target.images.push(evt.target.result);
                    reader.readAsDataURL(blob);
                }
                isLoading.value = false;
            };

            // Enhanced File Upload Handler (Stores name and content)
            const handleFileUpload = (e, target) => {
                if(!target.files) target.files = [];
                for(const file of e.target.files) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        target.files.push({
                            name: file.name,
                            content: evt.target.result // Base64 content
                        });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const removeImage = (idx, target) => target.images.splice(idx, 1);
            const removeFile = (idx, target) => target.files.splice(idx, 1);
            
            const openFile = (fileObj) => { 
                const url = fileObj.url || fileObj; // Handle old string format
                if(url && !url.startsWith('data:')) window.open(url, '_blank'); 
            };
            const openLightbox = (url) => { if(url) lightboxImage.value = url; };

            const openDetailPreview = (item) => {
                // Normalize file data structure for legacy support
                const normalizedItem = { ...item };
                if (normalizedItem.files) {
                    normalizedItem.files = normalizedItem.files.map(f => {
                        return (typeof f === 'string') ? { name: 'é™„ä»¶', url: f } : f;
                    });
                }
                previewItem.value = normalizedItem;
                currentGalleryIndex.value = 0;
                showItineraryDetailModal.value = true;
            };
            const switchToEditItinerary = () => {
                showItineraryDetailModal.value = false;
                isEditMode.value = true;
                // Deep copy
                newItinerary.value = JSON.parse(JSON.stringify(previewItem.value));
                showItineraryModal.value = true;
            };

            const openShoppingDetail = (item) => { 
                selectedShoppingItem.value = item; 
                currentGalleryIndex.value = 0; 
                showShoppingDetailModal.value = true; 
            };
            const switchToEditShopping = () => { 
                showShoppingDetailModal.value = false; 
                isEditMode.value = true; 
                newShoppingItem.value = JSON.parse(JSON.stringify(selectedShoppingItem.value)); 
                showShoppingModal.value = true; 
            };
            const galleryNav = (d, target) => {
                const len = target.images.length;
                let n = currentGalleryIndex.value + d;
                if(n < 0) n = len - 1; if(n >= len) n = 0;
                currentGalleryIndex.value = n;
            };
            const handleBannerUpload = async (e) => {
                const file = e.target.files[0]; if(!file) return; isLoading.value = true;
                const blob = await compressImage(file);
                const fileRef = storageRef(storage, `uploads/banner_${Date.now()}`);
                await uploadBytes(fileRef, blob);
                const url = await getDownloadURL(fileRef);
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), { headerImage: url }, { merge: true });
                isLoading.value = false;
            };
            const closeAllModals = () => {
                showSettingsModal.value = false; showItineraryModal.value = false;
                showItineraryDetailModal.value = false; showShoppingModal.value = false; 
                showShoppingDetailModal.value = false; showExpenseModal.value = false; 
                isLoading.value = false;
            };

            return {
                isLoading, loadingText, toastMessage, bannerUrl, bannerLoaded, lightboxImage,
                currentTab, dates, selectedDateIndex, currentItinerary,
                shoppingSubTab, filteredShoppingList, expenses, totalExpensesJPY, totalExpensesTWD,
                currencyInput, currencyResult, calculateCurrency, formatNumber, getDateString,
                getCategoryColor, getCategoryIcon, getCategoryName, getTransportIcon,
                showSettingsModal, showItineraryModal, showItineraryDetailModal, showShoppingModal, showShoppingDetailModal, showExpenseModal,
                tripSettings, saveTripSettings, changeDuration,
                newItinerary, isEditMode, handleAddClick, handleImageUpload, handleFileUpload, removeImage, removeFile, saveItineraryItem, removeItineraryItem, openDetailPreview, switchToEditItinerary, openFile,
                previewItem, allAccommodations,
                newShoppingItem, selectedShoppingItem, currentGalleryIndex, galleryNav, openShoppingDetail, switchToEditShopping, saveShoppingItem, removeShoppingItem,
                newExpense, addExpense, removeExpense,
                closeAllModals, handleBannerUpload, openLightbox
            };
        }
    }).mount('#app');
</script>
</body>
</html>