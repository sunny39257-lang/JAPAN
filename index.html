<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Family Trip to Hokkaido 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea-blue': '#01579B',
                        'accent-yellow': '#FFD54F',
                    },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            background-color: #E5F3F7;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
            overscroll-behavior-y: none;
        }

        .app-container {
            max-width: 480px; margin: 0 auto; min-height: 100vh;
            background-color: #ffffff; position: relative; padding-bottom: 100px;
        }

        /* Header */
        .header-bg {
            height: 200px; overflow: hidden; position: relative;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 10px 30px rgba(1, 87, 155, 0.15);
        }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .banner-btn {
            position: absolute; width: 36px; height: 36px;
            background: rgba(255, 255, 255, 0.9); color: #01579B;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 20;
        }
        .banner-edit-btn { bottom: 20px; right: 20px; }
        .banner-settings-btn { top: 20px; right: 20px; }

        /* Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); border-top: 1px solid rgba(229, 231, 235, 0.5);
            display: flex; justify-content: space-around; align-items: center;
            padding: 12px 16px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
            z-index: 50; border-top-left-radius: 24px; border-top-right-radius: 24px;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94A3B8; font-size: 0.75rem; width: 60px; }
        .nav-item.active { color: #01579B; font-weight: bold; }
        .fab-center {
            width: 56px; height: 56px; background: #FFD54F; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #01579B;
            font-size: 1.5rem; margin-top: -28px; border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(255, 213, 79, 0.6);
        }

        /* Timeline */
        .timeline-line {
            position: absolute; left: 23px; top: 24px; bottom: -24px;
            width: 2px; background-color: #E2E8F0; z-index: 0;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #01579B; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Form Elements */
        .form-label {
            font-size: 0.75rem; font-weight: 700; color: #64748B;
            margin-bottom: 0.35rem; display: block; margin-left: 0.25rem;
        }
        .input-field {
            width: 100%; background-color: #F8FAFC; border-radius: 0.75rem;
            padding: 0.75rem; font-size: 0.875rem; outline: none;
            border: 1px solid transparent; transition: border-color 0.2s;
        }
        .input-field:focus { border-color: #01579B; background-color: #fff; }

        /* Image Gallery Grid */
        .image-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .image-preview-item {
            aspect-ratio: 1; position: relative; border-radius: 0.75rem;
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }

        .toast {
            background: rgba(30, 41, 59, 0.95); color: white;
            padding: 12px 20px; border-radius: 12px; font-size: 0.875rem;
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 110; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none;
        }
        
        /* Modal Close Button */
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem; width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center;
            background-color: #F1F5F9; border-radius: 50%; color: #64748B;
            font-size: 1rem; cursor: pointer; transition: background-color 0.2s;
        }
        .modal-close-btn:active { background-color: #E2E8F0; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="app-container" v-cloak>

    <!-- Global Loading -->
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner mb-3"></div>
        <div class="text-slate-600 font-bold text-sm bg-white/80 px-3 py-1 rounded-full">{{ loadingText || 'è™•ç†ä¸­...' }}</div>
    </div>

    <!-- Toast -->
    <div v-if="toastMessage" class="toast">{{ toastMessage }}</div>

    <!-- Header -->
    <div class="header-bg">
        <div class="header-image-container relative">
            <img :src="bannerUrl || 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80'" alt="Header">
            <button @click="showSettingsModal = true" class="banner-btn banner-settings-btn"><i class="fa-solid fa-gear"></i></button>
            <label class="banner-btn banner-edit-btn">
                <input type="file" @change="handleBannerUpload" class="hidden" accept="image/*">
                <i class="fa-solid fa-camera"></i>
            </label>
        </div>
    </div>

    <main class="px-4 app-main">
        
        <!-- Tab: è¡Œç¨‹ (Itinerary) -->
        <div v-if="currentTab === 'itinerary'" class="pb-24">
            <!-- Date Selector -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 px-1 sticky top-0 -mx-4 px-4 snap-x z-20 bg-white/95 backdrop-blur-md py-3 rounded-b-2xl shadow-sm mb-2">
                <div v-for="(day, index) in dates" :key="index"
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[60px] h-[70px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all border border-transparent"
                     :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white shadow-lg translate-y-[-2px]' : 'bg-slate-50 text-slate-400'">
                    <span class="text-xs font-medium mb-1">{{ day.weekday }}</span>
                    <span class="text-lg font-bold leading-none">{{ day.date.split('/')[1] }}</span>
                    <span class="text-[10px] opacity-60 mt-1">{{ day.date.split('/')[0] }}æœˆ</span>
                </div>
            </div>

            <!-- Sort Toggle Button -->
            <div class="flex justify-between items-center mb-4 px-2">
                <span class="text-xs font-bold text-slate-400">ç•¶æ—¥è¡Œç¨‹ ({{ currentItinerary.length }})</span>
                <button @click="isReordering = !isReordering" 
                        class="text-xs px-3 py-1.5 rounded-full font-bold transition-colors flex items-center gap-1"
                        :class="isReordering ? 'bg-accent-yellow text-yellow-900' : 'bg-slate-100 text-slate-500'">
                    <i class="fa-solid" :class="isReordering ? 'fa-check' : 'fa-sort'"></i>
                    {{ isReordering ? 'å®Œæˆæ’åº' : 'èª¿æ•´é †åº' }}
                </button>
            </div>

            <!-- Timeline -->
            <div class="space-y-0 pl-2">
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-400 text-sm">
                    <i class="fa-solid fa-map-location-dot text-4xl mb-3 opacity-20 block"></i>
                    å°šæœªå®‰æ’è¡Œç¨‹ï¼ŒæŒ‰ + æ–°å¢
                </div>

                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group pb-6 last:pb-24">
                    <!-- Connector Line -->
                    <div v-if="idx < currentItinerary.length - 1" class="timeline-line border-l-2 border-dashed border-slate-200"></div>

                    <!-- Travel Time (Visual) -->
                    <div v-if="idx > 0 && !isReordering" class="pl-12 mb-3 flex items-center text-xs text-slate-400">
                        <div class="flex items-center bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">
                            <i :class="getTransportIcon(item.transportType)" class="mr-1.5 text-slate-400"></i>
                            <span>æ¥çºŒè¡Œç¨‹</span>
                        </div>
                    </div>

                    <div class="flex items-start relative z-10">
                        <!-- Icon Column -->
                        <div class="flex flex-col items-center mr-3 w-12 flex-shrink-0">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm ring-4 ring-white z-10" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-500 mt-2 bg-white px-1 rounded">{{ item.startTime }}</span>
                        </div>

                        <!-- Card Content -->
                        <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden flex cursor-pointer active:scale-[0.99] transition-transform"
                             @click="!isReordering && openItineraryDetail(item)">
                            
                            <!-- Left: Info -->
                            <div class="p-3 flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-base font-bold text-slate-800 leading-snug truncate">{{ item.name }}</h3>
                                    <!-- Price Tag for Food/Ticket -->
                                    <span v-if="item.price" class="text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded ml-2 font-medium shrink-0">Â¥{{ item.price }}</span>
                                </div>
                                
                                <p class="text-xs text-slate-500 truncate mt-1" v-if="item.note">{{ item.note }}</p>
                                
                                <!-- Special Tags -->
                                <div class="mt-2 flex flex-wrap gap-1">
                                    <span v-if="item.category === 'flight'" class="inline-flex items-center bg-sky-50 text-sky-700 px-2 py-1 rounded-[4px] text-[10px] font-bold">
                                        <i class="fa-solid fa-plane mr-1"></i> {{ item.flightNo }}
                                    </span>
                                    <span v-if="item.category === 'accommodation'" class="inline-flex items-center bg-indigo-50 text-indigo-700 px-2 py-1 rounded-[4px] text-[10px] font-bold">
                                        <i class="fa-solid fa-bed mr-1"></i> ä½å®¿
                                    </span>
                                    <span v-if="item.files && item.files.length > 0" class="inline-flex items-center bg-slate-100 text-slate-500 px-2 py-1 rounded-[4px] text-[10px]">
                                        <i class="fa-solid fa-paperclip mr-1"></i> é™„ä»¶
                                    </span>
                                </div>
                            </div>

                            <!-- Sort Mode Controls (Only visible when Reordering) -->
                            <div v-if="isReordering" class="flex flex-col items-center justify-center border-l border-slate-100 bg-yellow-50 w-12 transition-all">
                                <button @click.stop="reorderItem(item, -1)" class="h-1/2 w-full flex items-center justify-center text-yellow-700 active:bg-yellow-200">
                                    <i class="fa-solid fa-chevron-up"></i>
                                </button>
                                <button @click.stop="reorderItem(item, 1)" class="h-1/2 w-full flex items-center justify-center text-yellow-700 active:bg-yellow-200">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                            </div>
                            
                            <!-- Normal Mode: Thumbnail -->
                            <div v-else-if="item.images && item.images.length > 0" class="w-20 bg-slate-100 relative border-l border-slate-100">
                                <img :src="item.images[0]" class="w-full h-full object-cover">
                                <div v-if="item.images.length > 1" class="absolute bottom-0 right-0 bg-black/50 text-white text-[9px] px-1.5 py-0.5 rounded-tl-md">
                                    +{{ item.images.length - 1 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è³¼ç‰© -->
        <div v-if="currentTab === 'shopping'" class="pb-24">
            <div class="flex p-1 bg-slate-100 rounded-2xl mb-4">
                <button @click="shoppingSubTab = 'souvenir'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'souvenir' ? 'bg-white text-pink-500 shadow-sm' : 'text-slate-400'">
                    ä¼´æ‰‹ç¦®
                </button>
                <button @click="shoppingSubTab = 'cosmetic'" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all"
                        :class="shoppingSubTab === 'cosmetic' ? 'bg-white text-teal-500 shadow-sm' : 'text-slate-400'">
                    è—¥å¦
                </button>
            </div>

            <div class="flex flex-col gap-3">
                <div v-for="(item, idx) in filteredShoppingList" :key="item.id" 
                     @click="openShoppingDetail(item)" 
                     class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-4 cursor-pointer active:bg-slate-50">
                    <div class="w-16 h-16 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0 relative border border-slate-200">
                         <img v-if="item.images && item.images.length > 0" :src="item.images[0]" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image"></i></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-slate-800 text-sm truncate">{{ item.name }}</h4>
                        <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                            <span v-if="item.price" class="bg-yellow-50 text-yellow-700 px-1.5 py-0.5 rounded">Â¥{{ item.price }}</span>
                            <span v-if="item.quantity">x{{ item.quantity }}</span>
                        </div>
                    </div>
                    <div class="text-slate-300 text-sm"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <button @click="handleAddClick" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-sm flex items-center justify-center hover:bg-slate-50">
                    <i class="fa-solid fa-plus mr-2"></i> æ–°å¢è³¼ç‰©æ¸…å–®
                </button>
            </div>
        </div>

        <!-- Tab: èŠ±è²» -->
        <div v-if="currentTab === 'expenses'" class="pb-24">
            <div class="bg-gradient-to-br from-deep-sea-blue to-blue-800 text-white rounded-3xl p-6 mb-6 shadow-xl relative overflow-hidden">
                <p class="text-xs text-blue-200 mb-1">ç¸½æ”¯å‡ºé ä¼°</p>
                <h2 class="text-4xl font-bold mb-1">Â¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm text-blue-200 opacity-80">â‰ˆ NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div v-for="exp in expenses" :key="exp.id" class="flex items-center justify-between p-4 border-b border-slate-50 last:border-0">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm mr-3" :class="getCategoryColor(exp.category)">
                            <i :class="getCategoryIcon(exp.category)"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                            <p class="text-[10px] text-slate-400">{{ exp.date }} Â· {{ exp.payment === 'card' ? 'åˆ·å¡' : 'ç¾é‡‘' }}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-slate-700 text-sm mr-3">Â¥{{ formatNumber(exp.amount) }}</span>
                        <button @click="removeExpense(exp.id)" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è³‡è¨Š (åªå‰©åŒ¯ç‡) -->
        <div v-if="currentTab === 'info'" class="pb-24">
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-3">
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 block mb-1">æ—¥å¹£ JPY</label>
                    <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-slate-50 rounded-lg p-2 font-bold text-deep-sea-blue">
                </div>
                <i class="fa-solid fa-arrow-right text-slate-300 mt-4"></i>
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 block mb-1">å°å¹£ TWD</label>
                    <div class="w-full bg-slate-100 rounded-lg p-2 font-bold text-slate-600">$ {{ currencyResult }}</div>
                </div>
            </div>
            <div class="mt-8 text-center text-slate-400 text-sm">
                <p>ä½å®¿è³‡è¨Šå·²ç§»è‡³ã€Œæ¯æ—¥è¡Œç¨‹ã€é é¢</p>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item" :class="{ active: currentTab === 'itinerary' }" @click="currentTab = 'itinerary'">
            <i class="fa-solid fa-map-location-dot"></i><span>è¡Œç¨‹</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'shopping' }" @click="currentTab = 'shopping'">
            <i class="fa-solid fa-bag-shopping"></i><span>è³¼ç‰©</span>
        </button>
        <button class="fab-center" @click="handleAddClick"><i class="fa-solid fa-plus"></i></button>
        <button class="nav-item" :class="{ active: currentTab === 'expenses' }" @click="currentTab = 'expenses'">
            <i class="fa-solid fa-wallet"></i><span>èŠ±è²»</span>
        </button>
        <button class="nav-item" :class="{ active: currentTab === 'info' }" @click="currentTab = 'info'">
            <i class="fa-solid fa-circle-info"></i><span>è³‡è¨Š</span>
        </button>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- 1. Settings Modal -->
    <div v-if="showSettingsModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-6 text-center">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div><label class="form-label">å‡ºç™¼æ—¥æœŸ</label><input type="date" v-model="tripSettings.startDate" class="input-field"></div>
                <div>
                    <label class="form-label">ç®¡ç†å¤©æ•¸</label>
                    <div class="flex items-center justify-between bg-slate-50 rounded-xl p-3">
                        <button @click="changeDuration(-1)" class="w-10 h-10 bg-white shadow rounded-lg text-slate-600"><i class="fa-solid fa-minus"></i></button>
                        <span class="font-bold text-lg">{{ tripSettings.duration }} å¤©</span>
                        <button @click="changeDuration(1)" class="w-10 h-10 bg-white shadow rounded-lg text-slate-600"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <button @click="saveTripSettings" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold mt-2">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- 2. Itinerary Add/Edit Modal (Updated Fields) -->
    <div v-if="showItineraryModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}è¡Œç¨‹</h3>
            
            <div class="space-y-4">
                <!-- Category Select -->
                <div>
                    <label class="form-label">é¡å‹</label>
                    <select v-model="newItinerary.category" class="input-field">
                        <option value="sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="food">ğŸ´ é£²é£Ÿ</option>
                        <option value="accommodation">ğŸ¨ ä½å®¿</option>
                        <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="flight">âœˆï¸ èˆªç­</option>
                        <option value="transport">ğŸšŒ äº¤é€š</option>
                    </select>
                </div>

                <!-- === Conditional Fields based on Category === -->

                <!-- A. Food (é£²é£Ÿ) -->
                <div v-if="newItinerary.category === 'food'" class="space-y-3">
                    <div><label class="form-label">é¤å»³åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">é ç®—/åƒ¹æ ¼</label><input v-model="newItinerary.price" type="text" placeholder="Â¥" class="input-field"></div>
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                    </div>
                    <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newItinerary.openTime" placeholder="ä¾‹å¦‚: 11:00-20:00" class="input-field"></div>
                    <div><label class="form-label">åœ°å€</label><input v-model="newItinerary.address" class="input-field"></div>
                    <div><label class="form-label">å®˜ç¶²é€£çµ</label><input v-model="newItinerary.website" placeholder="http://" class="input-field"></div>
                </div>

                <!-- B. Sightseeing (æ™¯é») -->
                <div v-else-if="newItinerary.category === 'sightseeing'" class="space-y-3">
                    <div><label class="form-label">æ™¯é»åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">é–€ç¥¨åƒ¹æ ¼</label><input v-model="newItinerary.price" type="text" placeholder="å…è²» / Â¥2000" class="input-field"></div>
                        <div><label class="form-label">é è¨ˆæ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                    </div>
                    <div><label class="form-label">ç‡Ÿæ¥­æ™‚é–“</label><input v-model="newItinerary.openTime" placeholder="ä¾‹å¦‚: 09:00-17:00" class="input-field"></div>
                    <div><label class="form-label">åœ°å€</label><input v-model="newItinerary.address" class="input-field"></div>
                </div>

                <!-- C. Accommodation (ä½å®¿) -->
                <div v-else-if="newItinerary.category === 'accommodation'" class="space-y-3 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                    <div><label class="form-label text-indigo-800">é£¯åº—åç¨±</label><input v-model="newItinerary.name" class="input-field bg-white"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label text-indigo-800">å…¥ä½æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field bg-white"></div>
                        <div><label class="form-label text-indigo-800">é€€æˆ¿æ—¥æœŸ</label><input v-model="newItinerary.checkOutDate" type="date" class="input-field bg-white"></div>
                    </div>
                    <div><label class="form-label text-indigo-800">åœ°å€</label><input v-model="newItinerary.address" class="input-field bg-white"></div>
                    
                    <!-- File Upload for Hotel -->
                    <div>
                        <label class="form-label text-indigo-800">è¨‚å–®æª”æ¡ˆ (PDF/æˆªåœ–)</label>
                        <div class="space-y-2">
                             <div v-for="(file, idx) in newItinerary.files" :key="idx" class="flex items-center justify-between bg-white p-2 rounded-lg text-xs border border-indigo-100">
                                <span class="truncate max-w-[150px] text-blue-600 underline cursor-pointer" @click="openFile(file)">å·²ä¸Šå‚³æª”æ¡ˆ {{idx+1}}</span>
                                <button @click="removeFile(idx, newItinerary)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                             </div>
                             <label class="block w-full py-2 bg-white border border-dashed border-indigo-300 rounded-lg text-center text-indigo-400 cursor-pointer text-xs">
                                <input type="file" @change="(e) => handleFileUpload(e, newItinerary)" class="hidden" multiple accept="image/*,application/pdf">
                                <i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³è¨‚å–®
                            </label>
                        </div>
                    </div>
                </div>

                <!-- D. Default/Transport/Other -->
                <div v-else class="space-y-3">
                     <div><label class="form-label">åç¨±</label><input v-model="newItinerary.name" class="input-field"></div>
                     <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">æ™‚é–“</label><input v-model="newItinerary.startTime" type="time" class="input-field"></div>
                        <div>
                             <label class="form-label">äº¤é€šæ–¹å¼</label>
                             <select v-model="newItinerary.transportType" class="input-field">
                                <option value="walk">æ­¥è¡Œ</option>
                                <option value="car">è‡ªé§•</option>
                                <option value="bus">å·´å£«</option>
                                <option value="public">åœ°éµ/JR</option>
                                <option value="flight">é£›æ©Ÿ</option>
                            </select>
                        </div>
                     </div>
                     <div v-if="newItinerary.category === 'flight'"><label class="form-label">èˆªç­è™Ÿ</label><input v-model="newItinerary.flightNo" class="input-field"></div>
                </div>

                <!-- Common: Note -->
                <div><label class="form-label">å‚™è¨»</label><textarea v-model="newItinerary.note" rows="2" class="input-field"></textarea></div>
                
                <!-- Common: Image Upload -->
                <div>
                    <label class="form-label">ç…§ç‰‡ ({{ newItinerary.images ? newItinerary.images.length : 0 }})</label>
                    <div class="image-preview-grid">
                        <div v-for="(img, idx) in newItinerary.images" :key="idx" class="image-preview-item">
                            <img :src="img">
                            <button @click="removeImage(idx, newItinerary)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 cursor-pointer">
                            <input type="file" @change="(e) => handleImageUpload(e, newItinerary)" class="hidden" multiple accept="image/*">
                            <i class="fa-solid fa-plus text-slate-400"></i>
                        </label>
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveItineraryItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Shopping Detail Modal -->
    <div v-if="showShoppingDetailModal && selectedShoppingItem" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative z-10">
            <div class="relative h-72 bg-slate-100 group">
                <img v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 0" 
                     :src="selectedShoppingItem.images[currentGalleryIndex]" 
                     class="w-full h-full object-contain bg-black">
                <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-image text-4xl"></i></div>
                <button @click="closeAllModals" class="absolute top-3 right-3 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-xmark"></i></button>
                <div v-if="selectedShoppingItem.images && selectedShoppingItem.images.length > 1">
                    <button @click.stop="galleryNav(-1)" class="absolute top-1/2 left-2 -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                    <button @click.stop="galleryNav(1)" class="absolute top-1/2 right-2 -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="p-5">
                <h3 class="text-xl font-bold text-slate-800 mb-2">{{ selectedShoppingItem.name }}</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-3 rounded-xl text-center"><span class="text-xs text-slate-400 block">å–®åƒ¹</span><span class="font-bold">Â¥{{ selectedShoppingItem.price || '-' }}</span></div>
                    <div class="bg-slate-50 p-3 rounded-xl text-center"><span class="text-xs text-slate-400 block">æ•¸é‡</span><span class="font-bold">x{{ selectedShoppingItem.quantity || 1 }}</span></div>
                </div>
                <button @click="switchToEditShopping" class="w-full py-3 bg-deep-sea-blue text-white rounded-xl font-bold">ç·¨è¼¯å…§å®¹</button>
            </div>
        </div>
    </div>
    
    <!-- 4. Shopping Add/Edit Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
         <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
         <div class="bg-white rounded-3xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 relative z-10">
             <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
             <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢' }}è³¼ç‰©</h3>
             <div class="space-y-4">
                 <div><label class="form-label">å•†å“åç¨±</label><input v-model="newShoppingItem.name" class="input-field"></div>
                 <div><label class="form-label">å•†åº—</label><input v-model="newShoppingItem.shopName" class="input-field"></div>
                 <div class="grid grid-cols-2 gap-3">
                     <div><label class="form-label">å–®åƒ¹</label><input v-model="newShoppingItem.price" type="number" class="input-field"></div>
                     <div><label class="form-label">æ•¸é‡</label><input v-model="newShoppingItem.quantity" type="number" class="input-field"></div>
                 </div>
                <div>
                    <label class="form-label">å•†å“ç…§ç‰‡</label>
                    <div class="image-preview-grid">
                        <div v-for="(img, idx) in newShoppingItem.images" :key="idx" class="image-preview-item">
                            <img :src="img">
                            <button @click="removeImage(idx, newShoppingItem)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <label class="image-preview-item flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 cursor-pointer">
                            <input type="file" @change="(e) => handleImageUpload(e, newShoppingItem)" class="hidden" multiple accept="image/*">
                            <i class="fa-solid fa-plus text-slate-400"></i>
                        </label>
                    </div>
                </div>
                 <div class="flex gap-2 mt-4">
                     <button v-if="isEditMode" @click="removeShoppingItem(newShoppingItem.id)" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i class="fa-solid fa-trash"></i></button>
                     <button @click="saveShoppingItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold">å„²å­˜</button>
                 </div>
             </div>
         </div>
    </div>

    <!-- 5. Expense Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 z-[60] flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="closeAllModals"></div>
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative z-10">
            <button @click="closeAllModals" class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold text-lg mb-6 text-center">è¨˜ä¸€ç­†</h3>
            <div class="space-y-4">
                 <div><label class="form-label">é …ç›®</label><input v-model="newExpense.name" class="input-field"></div>
                 <div><label class="form-label">é‡‘é¡ (Â¥)</label><input v-model.number="newExpense.amount" type="number" class="input-field font-bold text-lg text-deep-sea-blue"></div>
                 <div><label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
                    <div class="flex gap-2">
                        <button @click="newExpense.payment='cash'" class="flex-1 py-2 rounded-lg border text-sm" :class="newExpense.payment==='cash'?'bg-deep-sea-blue text-white':'text-slate-400'">ç¾é‡‘</button>
                        <button @click="newExpense.payment='card'" class="flex-1 py-2 rounded-lg border text-sm" :class="newExpense.payment==='card'?'bg-deep-sea-blue text-white':'text-slate-400'">ä¿¡ç”¨å¡</button>
                    </div>
                 </div>
                 <button @click="addExpense" class="w-full py-3 bg-accent-yellow text-yellow-900 rounded-xl font-bold mt-2">å„²å­˜</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // Firebase Config
            const firebaseConfig = {
               apiKey: "AIzaSyA8wiv63sS1lbCkOOeYlZpL1RlKHvvAAYA",
                authDomain: "hokkaido-b390b.firebaseapp.com",
                projectId: "hokkaido-b390b",
                storageBucket: "hokkaido-b390b.firebasestorage.app",
                messagingSenderId: "199459788936",
                appId: "1:199459788936:web:f430fac50b022959f8e73d",
                measurementId: "G-3XGXW53RDB"
            };

            const TRIP_ID = 'family_hokkaido_2026';
            const DATA_PATH = 'shared_data';

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            const isLoading = ref(false);
            const loadingText = ref('');
            const toastMessage = ref('');
            const showToast = (msg) => { toastMessage.value = msg; setTimeout(() => toastMessage.value = '', 3000); };

            // Helper: Image Compression
            const compressImage = async (file) => {
                return new Promise((resolve) => {
                    const maxWidth = 1200;
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                        };
                    };
                });
            };

            // Data
            const currentTab = ref('itinerary');
            const shoppingSubTab = ref('souvenir');
            const dates = ref([]);
            const tripSettings = ref({ startDate: '2026-02-01', duration: 7 });
            const itineraryData = ref({});
            const shoppingList = ref([]);
            const expenses = ref([]);
            const bannerUrl = ref('');
            const selectedDateIndex = ref(0);
            
            // UI State
            const isReordering = ref(false); // New: Reorder Mode
            
            // Modals
            const showSettingsModal = ref(false);
            const showItineraryModal = ref(false);
            const showShoppingModal = ref(false);
            const showShoppingDetailModal = ref(false);
            const showExpenseModal = ref(false);
            
            // Edit/New Items
            const isEditMode = ref(false);
            const newItinerary = ref({ images: [], files: [] });
            const newShoppingItem = ref({ images: [] });
            const newExpense = ref({ payment: 'cash' });
            
            const selectedShoppingItem = ref(null);
            const currentGalleryIndex = ref(0);
            const currencyInput = ref(10000);
            const currencyResult = ref(0);

            // Computed
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const filteredShoppingList = computed(() => shoppingList.value.filter(item => item.category === shoppingSubTab.value));
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + e.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * 0.215));

            // Icons
            const getCategoryColor = (cat) => ({
                sightseeing: 'bg-emerald-400', food: 'bg-orange-400', shopping: 'bg-pink-400',
                flight: 'bg-sky-500', transport: 'bg-slate-400', accommodation: 'bg-indigo-500'
            }[cat] || 'bg-gray-400');
            const getCategoryIcon = (cat) => ({
                sightseeing: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping',
                flight: 'fa-solid fa-plane', transport: 'fa-solid fa-bus', accommodation: 'fa-solid fa-bed'
            }[cat] || 'fa-solid fa-info');
            const getTransportIcon = (t) => ({ walk: 'fa-solid fa-person-walking', car: 'fa-solid fa-car', bus: 'fa-solid fa-bus', public: 'fa-solid fa-train-subway', flight: 'fa-solid fa-plane' }[t] || 'fa-solid fa-arrow-right');
            const formatNumber = (n) => n?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * 0.215);

            // Init
            onMounted(async () => {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { if (user) setupListeners(); });
                calculateCurrency();
            });

            const generateDates = () => {
                const arr = [];
                const start = new Date(tripSettings.value.startDate);
                const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                for(let i=0; i<tripSettings.value.duration; i++){
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    arr.push({ date: `${d.getMonth()+1}/${d.getDate()}`, weekday: weekdays[d.getDay()] });
                }
                dates.value = arr;
            };

            const setupListeners = () => {
                // Settings
                onSnapshot(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), (snap) => {
                    if(snap.exists()){
                        const d = snap.data();
                        bannerUrl.value = d.headerImage;
                        if(d.tripStartDate) tripSettings.value.startDate = d.tripStartDate;
                        if(d.tripDuration) tripSettings.value.duration = d.tripDuration;
                        generateDates();
                    }
                });
                // Itinerary
                onSnapshot(collection(db, 'trips', TRIP_ID, 'itinerary_items'), (snap) => {
                    const temp = {};
                    snap.forEach(d => {
                        const data = d.data();
                        const day = data.dayIndex || 0;
                        if(!temp[day]) temp[day] = [];
                        temp[day].push({ ...data, id: d.id });
                    });
                    Object.keys(temp).forEach(k => {
                        temp[k].sort((a,b) => (a.order || 0) - (b.order || 0) || (a.startTime||'').localeCompare(b.startTime||''));
                    });
                    itineraryData.value = temp;
                });
                // Shopping
                onSnapshot(collection(db, 'trips', TRIP_ID, 'shopping_items'), (snap) => shoppingList.value = snap.docs.map(d => ({...d.data(), id:d.id})));
                // Expenses
                const qExp = query(collection(db, 'trips', TRIP_ID, 'expense_items'), orderBy("date", "desc"));
                onSnapshot(qExp, (snap) => expenses.value = snap.docs.map(d => ({...d.data(), id:d.id})));
            };

            // Logic
            const processUploads = async (filesArray) => {
                const urls = [];
                for(const item of filesArray) {
                    if(item.startsWith('data:')) {
                        const res = await fetch(item); const blob = await res.blob();
                        const fileRef = storageRef(storage, `uploads/file_${Date.now()}_${Math.random().toString(36).substr(2)}`);
                        await uploadBytes(fileRef, blob);
                        urls.push(await getDownloadURL(fileRef));
                    } else urls.push(item);
                }
                return urls;
            };

            const saveTripSettings = async () => {
                isLoading.value = true;
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), {
                    tripStartDate: tripSettings.value.startDate, tripDuration: tripSettings.value.duration
                }, { merge: true });
                generateDates(); isLoading.value = false; showSettingsModal.value = false;
            };
            const changeDuration = (delta) => {
                const n = tripSettings.value.duration + delta;
                if(n > 0) tripSettings.value.duration = n;
            };

            // Itinerary
            const handleAddClick = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    const dayList = itineraryData.value[selectedDateIndex.value] || [];
                    const maxOrder = dayList.length > 0 ? Math.max(...dayList.map(i => i.order || 0)) : 0;
                    // Reset New Itinerary Structure
                    newItinerary.value = { category: 'sightseeing', transportType: 'walk', images: [], files: [], dayIndex: selectedDateIndex.value, order: maxOrder + 1000 };
                    showItineraryModal.value = true;
                } else if(currentTab.value === 'shopping') {
                    isEditMode.value = false;
                    newShoppingItem.value = { category: shoppingSubTab.value, images: [] };
                    showShoppingModal.value = true;
                } else if(currentTab.value === 'expenses') {
                    newExpense.value = { payment: 'cash' };
                    showExpenseModal.value = true;
                }
            };

            const saveItineraryItem = async () => {
                isLoading.value = true;
                const imgUrls = await processUploads(newItinerary.value.images);
                const fileUrls = await processUploads(newItinerary.value.files);
                const data = { ...newItinerary.value, images: imgUrls, files: fileUrls, dayIndex: selectedDateIndex.value };
                delete data.id;
                
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', newItinerary.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'itinerary_items'), data);
                isLoading.value = false; closeAllModals();
            };

            const removeItineraryItem = async (id) => {
                if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) { await deleteDoc(doc(db, 'trips', TRIP_ID, 'itinerary_items', id)); closeAllModals(); }
            };

            const reorderItem = async (item, dir) => {
                const dayList = itineraryData.value[selectedDateIndex.value];
                const idx = dayList.findIndex(i => i.id === item.id);
                if(idx === -1 || (idx + dir < 0) || (idx + dir >= dayList.length)) return;
                
                const neighbor = dayList[idx + dir];
                const myOrder = item.order || idx * 1000;
                const neighborOrder = neighbor.order || (idx + dir) * 1000;

                const batch = writeBatch(db);
                batch.update(doc(db, 'trips', TRIP_ID, 'itinerary_items', item.id), { order: neighborOrder });
                batch.update(doc(db, 'trips', TRIP_ID, 'itinerary_items', neighbor.id), { order: myOrder });
                await batch.commit();
            };

            // Shopping
            const saveShoppingItem = async () => {
                isLoading.value = true;
                if(!isEditMode.value) newShoppingItem.value.category = shoppingSubTab.value;
                const urls = await processUploads(newShoppingItem.value.images);
                const data = { ...newShoppingItem.value, images: urls };
                delete data.id;
                if(isEditMode.value) await updateDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', newShoppingItem.value.id), data);
                else await addDoc(collection(db, 'trips', TRIP_ID, 'shopping_items'), data);
                isLoading.value = false; closeAllModals();
            };
            const removeShoppingItem = async (id) => {
                if(confirm("åˆªé™¤æ­¤å•†å“ï¼Ÿ")) { await deleteDoc(doc(db, 'trips', TRIP_ID, 'shopping_items', id)); closeAllModals(); }
            };

            // Expense
            const addExpense = async () => {
                if(!newExpense.value.name || !newExpense.value.amount) return;
                isLoading.value = true;
                await addDoc(collection(db, 'trips', TRIP_ID, 'expense_items'), { ...newExpense.value, date: new Date().toISOString().split('T')[0] });
                isLoading.value = false; closeAllModals();
            };
            const removeExpense = async (id) => { if(confirm("åˆªé™¤è¨˜å¸³ï¼Ÿ")) await deleteDoc(doc(db, 'trips', TRIP_ID, 'expense_items', id)); };

            // Files & Images
            const handleImageUpload = async (e, target) => {
                loadingText.value = 'å£“ç¸®ä¸­...'; isLoading.value = true;
                if(!target.images) target.images = [];
                for(const file of e.target.files) {
                    const blob = await compressImage(file);
                    const reader = new FileReader();
                    reader.onload = (evt) => target.images.push(evt.target.result);
                    reader.readAsDataURL(blob);
                }
                isLoading.value = false;
            };
            const handleFileUpload = (e, target) => {
                if(!target.files) target.files = [];
                for(const file of e.target.files) {
                    const reader = new FileReader();
                    reader.onload = (evt) => target.files.push(evt.target.result);
                    reader.readAsDataURL(file);
                }
            };
            const removeImage = (idx, target) => target.images.splice(idx, 1);
            const removeFile = (idx, target) => target.files.splice(idx, 1);
            const openFile = (url) => { if(!url.startsWith('data:')) window.open(url, '_blank'); };
            
            // Detail Openers
            const openItineraryDetail = (item) => { isEditMode.value = true; newItinerary.value = JSON.parse(JSON.stringify(item)); showItineraryModal.value = true; };
            const openShoppingDetail = (item) => { selectedShoppingItem.value = item; currentGalleryIndex.value = 0; showShoppingDetailModal.value = true; };
            const switchToEditShopping = () => { showShoppingDetailModal.value = false; isEditMode.value = true; newShoppingItem.value = JSON.parse(JSON.stringify(selectedShoppingItem.value)); showShoppingModal.value = true; };
            const galleryNav = (d) => {
                const len = selectedShoppingItem.value.images.length;
                let n = currentGalleryIndex.value + d;
                if(n < 0) n = len - 1; if(n >= len) n = 0;
                currentGalleryIndex.value = n;
            };
            const handleBannerUpload = async (e) => {
                const file = e.target.files[0]; if(!file) return; isLoading.value = true;
                const blob = await compressImage(file);
                const fileRef = storageRef(storage, `uploads/banner_${Date.now()}`);
                await uploadBytes(fileRef, blob);
                const url = await getDownloadURL(fileRef);
                await setDoc(doc(db, 'trips', TRIP_ID, DATA_PATH, 'settings'), { headerImage: url }, { merge: true });
                isLoading.value = false;
            };
            const closeAllModals = () => {
                showSettingsModal.value = false; showItineraryModal.value = false;
                showShoppingModal.value = false; showShoppingDetailModal.value = false;
                showExpenseModal.value = false; isLoading.value = false;
            };

            return {
                isLoading, loadingText, toastMessage, bannerUrl,
                currentTab, dates, selectedDateIndex, currentItinerary, isReordering,
                shoppingSubTab, filteredShoppingList, expenses, totalExpensesJPY, totalExpensesTWD,
                currencyInput, currencyResult, calculateCurrency, formatNumber,
                getCategoryColor, getCategoryIcon, getTransportIcon,
                showSettingsModal, showItineraryModal, showShoppingModal, showShoppingDetailModal, showExpenseModal,
                tripSettings, saveTripSettings, changeDuration,
                newItinerary, isEditMode, handleAddClick, handleImageUpload, handleFileUpload, removeImage, removeFile, saveItineraryItem, removeItineraryItem, openItineraryDetail, reorderItem, openFile,
                newShoppingItem, selectedShoppingItem, currentGalleryIndex, galleryNav, openShoppingDetail, switchToEditShopping, saveShoppingItem, removeShoppingItem,
                newExpense, addExpense, removeExpense,
                closeAllModals, handleBannerUpload
            };
        }
    }).mount('#app');
</script>
</body>
</html>